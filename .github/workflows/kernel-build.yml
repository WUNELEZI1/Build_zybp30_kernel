name: Build MT6768 Kernel (Charger Fix Edition)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64
  BASE_FIX_VERSION: "19"  # åŸºç¡€ç‰ˆæœ¬å·ï¼Œä½œä¸ºé€’å¢èµ·ç‚¹

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 150

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: è‡ªåŠ¨è®¡ç®—é€’å¢çš„FIX_VERSION
      run: |
        # åŸºäºåŸºç¡€ç‰ˆæœ¬å·è‡ªåŠ¨+1ï¼ˆæ¯æ¬¡è¿è¡Œå·¥ä½œæµéƒ½ä¼šé€’å¢ï¼‰
        NEW_FIX_VERSION=$((BASE_FIX_VERSION + 1))
        echo "FIX_VERSION=$NEW_FIX_VERSION" >> $GITHUB_ENV
        echo "å½“å‰ä¿®å¤ç‰ˆæœ¬: v$NEW_FIX_VERSIONï¼ˆåŸºäºåŸºç¡€ç‰ˆæœ¬v${{ env.BASE_FIX_VERSION }}ï¼‰"

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree patch
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    - name: Clone and fix kernel source
      run: |
        # å…‹éš†ä»“åº“
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/WUNELEZI1/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV
        
        cd kernel-source
        
        echo "=== åº”ç”¨åŸºç¡€ç¼–è¯‘ä¿®å¤ï¼ˆç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰ ==="
        
        # 1. ä¿®å¤ try_to_unmap å‚æ•°é—®é¢˜
        echo "ä¿®å¤ mm/huge_memory.c..."
        sed -i 's/try_to_unmap(page, ttu_flags, NULL, NULL);/try_to_unmap(page, ttu_flags);/g' mm/huge_memory.c

        # 2. ä¿®å¤ blocktag æ ¼å¼å­—ç¬¦ä¸²
        echo "ä¿®å¤ blocktag-core.c..."
        sed -i 's/"%s aee buffer: %d bytes\\n"/"%s aee buffer: %zu bytes\\n"/g' drivers/misc/mediatek/blocktag/blocktag-core.c

        # 3. ä¿®å¤ get_boot_mode ç±»å‹å†²çª
        echo "ä¿®å¤ hal_kpd.c..."
        sed -i 's/unsigned int get_boot_mode(void)/enum boot_mode_t get_boot_mode(void)/g' drivers/input/keyboard/mediatek/mt6768/hal_kpd.c

        # 4. ä¿®å¤ mtk_cm_mgr.c ä¸­çš„ memset é—®é¢˜
        echo "ä¿®å¤ mtk_cm_mgr.c..."
        sed -i 's/memset(count_ack, 0, ARRAY_SIZE(count_ack));/memset(count_ack, 0, sizeof(count_ack));/g' drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.c
        sed -i 's/memset(max_load, 0, ARRAY_SIZE(count_ack));/memset(max_load, 0, sizeof(max_load));/g' drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.c

        # 5. ä¿®å¤ keyslot-manager å†…è”å‡½æ•°é—®é¢˜
        echo "ä¿®å¤ keyslot-manager.h..."
        sed -i 's/always_inline //g' include/linux/keyslot-manager.h

        # 6. ä¿®å¤ blk-crypto å†…è”å‡½æ•°é—®é¢˜
        echo "ä¿®å¤ blk-crypto.h..."
        sed -i 's/always_inline //g' include/linux/blk-crypto.h

        # 7. ä¿®å¤ blk-crypto.c ä¸­çš„å‡½æ•°è°ƒç”¨
        echo "ä¿®å¤ blk-crypto.c..."
        if [ -f "block/blk-crypto.c" ]; then
          sed -i 's/ksm_flock(ksm, flags);/\/\/ ksm_flock(ksm, flags);/g' block/blk-crypto.c
          sed -i 's/blk_crypto_flock(q, flags);/\/\/ blk_crypto_flock(q, flags);/g' block/blk-crypto.c
        fi

        # 8. ä¿®å¤ mtk_battery.c ä¸­çš„ kstrtoint è¿”å›å€¼é—®é¢˜
        echo "ä¿®å¤ mtk_battery.c..."
        if [ -f "drivers/power/supply/mediatek/battery/mtk_battery.c" ]; then
          sed -i '4063s/kstrtoint(copy_str, 10, &value[count]);/if (kstrtoint(copy_str, 10, &value[count])) break;/' drivers/power/supply/mediatek/battery/mtk_battery.c
        fi

        # 9. ä¿®å¤ ccci_util_lib_sys.c ä¸­çš„åœ°å€è­¦å‘Š
        echo "ä¿®å¤ ccci_util_lib_sys.c..."
        if [ -f "drivers/misc/mediatek/ccci_util/ccci_util_lib_sys.c" ]; then
          sed -i '257s/if (ccci_get_plat_ft_inf)/if (ccci_get_plat_ft_inf != NULL)/' drivers/misc/mediatek/ccci_util/ccci_util_lib_sys.c
        fi

        # 10. ä¿®å¤ charger æ¥å£å¼€å…³ä¸å¯è¾¾é”™è¯¯
        echo "ä¿®å¤ mtk_charger_intf.h..."
        if [ -f "drivers/power/supply/mediatek/charger/mtk_charger_intf.h" ]; then
          sed -i '48s/return -EINVAL;/\/\/ return -EINVAL;/' drivers/power/supply/mediatek/charger/mtk_charger_intf.h
        fi

        # 11. ä¿®å¤ cmdq_sec_mtee.c ä¸­çš„å­—ç¬¦ä¸²ç»ˆæ­¢ç¬¦é”™è¯¯
        echo "ä¿®å¤ cmdq_sec_mtee.c..."
        if [ -f "drivers/misc/mediatek/cmdq/v3/cmdq_sec_mtee.c" ]; then
          sed -i '19s/strncpy(tee->ta_uuid, ta_uuid, sizeof(ta_uuid));/strncpy(tee->ta_uuid, ta_uuid, sizeof(tee->ta_uuid) - 1); tee->ta_uuid[sizeof(tee->ta_uuid) - 1] = '\''\\0'\'';/' drivers/misc/mediatek/cmdq/v3/cmdq_sec_mtee.c
          sed -i '20s/strncpy(tee->wsm_uuid, wsm_uuid, sizeof(wsm_uuid));/strncpy(tee->wsm_uuid, wsm_uuid, sizeof(tee->wsm_uuid) - 1); tee->wsm_uuid[sizeof(tee->wsm_uuid) - 1] = '\''\\0'\'';/' drivers/misc/mediatek/cmdq/v3/cmdq_sec_mtee.c
        fi

        # 12. ä¿®å¤ gl_cfg80211.c ä¸­çš„ memset å…ƒç´ å¤§å°è­¦å‘Š
        echo "ä¿®å¤ gl_cfg80211.c..."
        if [ -f "drivers/misc/mediatek/connectivity/wlan/core/gen4m/os/linux/gl_cfg80211.c" ]; then
          sed -i '3357s/kalMemZero(arBugReport, sizeof(struct EVENT_BUG_REPORT));/memset(arBugReport, 0, sizeof(*arBugReport));/' drivers/misc/mediatek/connectivity/wlan/core/gen4m/os/linux/gl_cfg80211.c
        fi

        # 13. ä¿®å¤ mtk_charger.c ä¸­çš„è¯­æ³•é”™è¯¯ï¼ˆä¿ç•™å……ç”µåŠŸèƒ½ï¼‰
        echo "ä¿®å¤ mtk_charger.c è¯­æ³•é”™è¯¯..."
        if [ -f "drivers/power/supply/mediatek/charger/mtk_charger.c" ]; then
          sed -i '205,215c\    if (ret) {\n        pr_err("charger: failed to set current limit\\n");\n        return ret;\n    }' drivers/power/supply/mediatek/charger/mtk_charger.c
        fi

        # 14. ä¿®å¤ extcon-mtk-usb.c ä¸­çš„å˜é‡åæ‹¼å†™é”™è¯¯ï¼ˆtval -> pvalï¼‰
        echo "ä¿®å¤ extcon-mtk-usb.c å˜é‡åé”™è¯¯..."
        if [ -f "drivers/misc/mediatek/extcon/extcon-mtk-usb.c" ]; then
          sed -i 's/tval.intval/pval.intval/g' drivers/misc/mediatek/extcon/extcon-mtk-usb.c
        fi

        # 15. æ‰‹åŠ¨ä¿®å¤ï¼šhacc_sk.c SMSG å®å‚æ•°ä¼ é€’é”™è¯¯ï¼ˆå·²å®Œæˆï¼‰

        # 16. ä¿®å¤ alsps.c ä¸­å‡½æ•°å‚æ•°å£°æ˜ä¸å¤´æ–‡ä»¶ä¸åŒ¹é…ï¼ˆæ•°ç»„vsæŒ‡é’ˆï¼‰
        echo "ä¿®å¤ alsps.c ä¸­æ•°ç»„ä¸æŒ‡é’ˆå‚æ•°ä¸åŒ¹é…..."
        if [ -f "drivers/misc/mediatek/sensors-1.0/alsps/alsps.c" ]; then
          sed -i 's/int rgbw_data_report_t(int \*value, int64_t time_stamp)/int rgbw_data_report_t(int value[4], int64_t time_stamp)/g' drivers/misc/mediatek/sensors-1.0/alsps/alsps.c
          sed -i 's/int rgbw_data_report(int \*value)/int rgbw_data_report(int value[4])/g' drivers/misc/mediatek/sensors-1.0/alsps/alsps.c
        fi

        # 17. ä¿®å¤ ddp_ovl.c ä¸­ C90 æ··åˆå£°æ˜ä¸ä»£ç çš„è­¦å‘Š
        echo "ä¿®å¤ ddp_ovl.c æ··åˆå£°æ˜ä¸ä»£ç é”™è¯¯..."
        if [ -f "drivers/misc/mediatek/video/mt6768/dispsys/ddp_ovl.c" ]; then
          sed -i '/enum TRUSTED_MEM_REQ_TYPE mem_type;/ {
            h; d;
          };
          /if (OVL_LAYER_IS_SECURE(layer)) {/ {
            p; g;
          }' drivers/misc/mediatek/video/mt6768/dispsys/ddp_ovl.c
        fi

        # 18. ä¿®å¤ musb_qmu.c ä¸­å­—ç¬¦ä¸²æœªé—­åˆé”™è¯¯
        echo "ä¿®å¤ musb_qmu.c å­—ç¬¦ä¸²æœªé—­åˆé”™è¯¯..."
        if [ -f "drivers/misc/mediatek/usb20/musb_qmu.c" ]; then
          sed -i '114s/avg sleep(%lu\/%d, %lu)us,/avg sleep(%lu\/%d, %lu)us, local balanced<%d,%d>\\n"/; 116d' drivers/misc/mediatek/usb20/musb_qmu.c
        fi

        # 19. Kconfig ä¿®å¤
        echo "ä¿®å¤ Kconfig é…ç½®å†²çª..."
        if [ -f "drivers/power/supply/mediatek/charger/Kconfig" ]; then
          sed -i 's/bool "BQ25890 Charger support"/tristate "BQ25890 Charger support"/g' drivers/power/supply/mediatek/charger/Kconfig
        fi
        if [ -f "drivers/misc/mediatek/base/power/Kconfig" ]; then
          sed -i 's/bool "MTK QoS Framework"/tristate "MTK QoS Framework"/g' drivers/misc/mediatek/base/power/Kconfig
        fi
        if [ -f "drivers/input/touchscreen/mediatek/goodix_berlin_driver/Kconfig" ]; then
          sed -i 's/tristate "Goodix Berlin touchscreen driver"/bool "Goodix Berlin touchscreen driver"/g' drivers/input/touchscreen/mediatek/goodix_berlin_driver/Kconfig
        fi
        if [ -f "drivers/soc/mediatek/Kconfig" ]; then
          sed -i 's/bool "MediaTek Command Queue (CMDQ) support"/tristate "MediaTek Command Queue (CMDQ) support"/g' drivers/soc/mediatek/Kconfig
        fi
        if [ -f "arch/arm64/configs/${{ github.event.inputs.DEFCONFIG }}" ]; then
          sed -i '/CONFIG_MTK_CACHE_PARITY_CHECK=y/d' arch/arm64/configs/${{ github.event.inputs.DEFCONFIG }}
          echo "# CONFIG_MTK_CACHE_PARITY_CHECK is not set" >> arch/arm64/configs/${{ github.event.inputs.DEFCONFIG }}
        fi

        # 20. æ–°å¢ï¼šä¿®å¤ mtk_charger.c ä»£ç å—æœªé—­åˆé—®é¢˜ï¼ˆæ ¸å¿ƒï¼‰
        echo "ä¿®å¤ mtk_charger.c æœªé—­åˆä»£ç å—..."
        if [ -f "drivers/power/supply/mediatek/charger/mtk_charger.c" ]; then
          # è¡¥å…¨ BATTERY_SetUSBState å‡½æ•°ç¼ºå¤±çš„é—­åˆ }
          sed -i '/^void BATTERY_SetUSBState(int usb_state_value)$/ {
            N; N; N; N; N; N; N; N; N; N;  # åŒ¹é…å‡½æ•°å†…10è¡Œå†…å®¹
            s/\(if (ret) {[^}]*}\)/\1\n}/  # è¡¥å…¨å‡½æ•°æœ«å°¾çš„ }
          }' drivers/power/supply/mediatek/charger/mtk_charger.c

          # è¡¥å……æœªå£°æ˜å‡½æ•°çš„å‰ç½®å£°æ˜
          sed -i '/#include "mtk_charger_intf.h"/a \
          static int charger_ftm_open(struct inode *inode, struct file *file);\n\
          static int charger_ftm_release(struct inode *inode, struct file *file);\n\
          static long charger_ftm_ioctl(struct file *file, unsigned int cmd, unsigned long arg);\n\
          static ssize_t show_sw_jeita(struct device *dev, struct device_attribute *attr, char *buf);\n\
          static ssize_t store_sw_jeita(struct device *dev, struct device_attribute *attr, const char *buf, size_t count);\n\
          static ssize_t show_pe20(struct device *dev, struct device_attribute *attr, char *buf);\n\
          static ssize_t store_pe20(struct device *dev, struct device_attribute *attr, const char *buf, size_t count);\n\
          static ssize_t show_pe40(struct device *dev, struct device_attribute *attr, char *buf);\n\
          static ssize_t store_pe40(struct device *dev, struct device_attribute *attr, const char *buf, size_t count);' \
          drivers/power/supply/mediatek/charger/mtk_charger.c
        fi

        # 21. æ–°å¢ï¼šä¿®å¤ ddp_ovl.c mem_type æœªå£°æ˜é—®é¢˜
        echo "å½»åº•ä¿®å¤ ddp_ovl.c mem_type æœªå£°æ˜..."
        if [ -f "drivers/misc/mediatek/video/mt6768/dispsys/ddp_ovl.c" ]; then
          # åœ¨å‡½æ•°å¼€å¤´æ˜¾å¼å£°æ˜ mem_type
          sed -i '/^int ovl_layer_config(struct ovl_layer *layer)$/a \
          enum TRUSTED_MEM_REQ_TYPE mem_type = -1;' \
          drivers/misc/mediatek/video/mt6768/dispsys/ddp_ovl.c
          # åˆ é™¤åŸä½ç½®çš„é‡å¤å£°æ˜
          sed -i '/enum TRUSTED_MEM_REQ_TYPE mem_type;/d' drivers/misc/mediatek/video/mt6768/dispsys/ddp_ovl.c
        fi

        # 22. æ–°å¢ï¼šä¿®å¤ PROC_FOPS_RW å®å…³è”å‡½æ•°æœªå®šä¹‰é—®é¢˜
        echo "ä¿®å¤ PROC_FOPS_RW å®ä¾èµ–å‡½æ•°..."
        if [ -f "drivers/power/supply/mediatek/charger/mtk_charger.c" ]; then
          sed -i '/#include "mtk_charger_intf.h"/a \
          static int mtk_chg_current_cmd_open(struct inode *inode, struct file *file);\n\
          static ssize_t mtk_chg_current_cmd_write(struct file *file, const char __user *buf, size_t count, loff_t *ppos);\n\
          static int mtk_chg_en_power_path_open(struct inode *inode, struct file *file);\n\
          static ssize_t mtk_chg_en_power_path_write(struct file *file, const char __user *buf, size_t count, loff_t *ppos);' \
          drivers/power/supply/mediatek/charger/mtk_charger.c
        fi

        echo "æ‰€æœ‰æºç ä¿®å¤å®Œæˆï¼ˆç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰"

    - name: Configure kernel
      run: |
        cd $KERNEL_DIR
        echo "=== å†…æ ¸é…ç½®ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰ ==="
        
        rm -rf out
        mkdir -p out
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }}
        
        ./scripts/config --file out/.config \
          --disable DEBUG_INFO \
          --disable GDB_SCRIPTS \
          --disable DEBUG_KERNEL \
          --disable SCHED_TUNE \
          --disable MTK_CM_MGR \
          --disable TRANSPARENT_HUGEPAGE \
          --disable BLK_DEV_CRYPTO \
          --disable DM_CRYPTO \
          --disable BLK_INLINE_ENCRYPTION \
          --disable BLK_CRYPTO \
          --disable CC_STACKPROTECTOR \
          --disable CC_STACKPROTECTOR_STRONG \
          --disable STACK_VALIDATION \
          --disable WERROR \
          --disable CONFIG_ARM64_PTR_AUTH \
          --disable CONFIG_ARM64_BTI \
          --disable CONFIG_ARM64_MTE \
          --disable DEBUG_PREEMPT \
          --disable PROVE_LOCKING \
          --disable MTK_CACHE_PARITY_CHECK

        ./scripts/config --file out/.config \
          --enable MODULES \
          --enable MODULE_UNLOAD \
          --enable ARM64 \
          --enable MMU \
          --enable SMP \
          --enable ARCH_MT6797 \
          --enable MACH_MT6768 \
          --enable CONFIG_CC_OPTIMIZE_FOR_SIZE

        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        echo "é…ç½®å®Œæˆ"

    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        echo "=== å¼€å§‹ç¼–è¯‘ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰ ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # å°†æ‰€æœ‰è¾“å‡ºï¼ˆåŒ…æ‹¬é”™è¯¯ï¼‰å†™å…¥æ—¥å¿—æ–‡ä»¶
        time make O=out ARCH=arm64 -j$(($(nproc) + 1)) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          KCFLAGS="-Wno-error -Wno-format -Wno-enum-int-mismatch -Wno-incompatible-pointer-types -Wno-uninitialized -Wno-misleading-indentation -Wno-address-of-packed-member -Wno-pointer-sign -Wno-format-overflow -Wno-stringop-overflow -Wno-restrict -Wno-array-bounds -Wno-maybe-uninitialized -Wno-implicit-fallthrough -Wno-packed-not-aligned -Wno-attributes -Wno-unused-but-set-variable -Wno-unused-variable -Wno-unused-function -Wno-sign-compare -Wno-shift-negative-value -Wno-int-to-pointer-cast -Wno-pointer-to-int-cast -Wno-unused-result -Wno-address -Wno-nonnull -Wno-clobbered -Wno-ignored-qualifiers -Wno-switch-unreachable -Wno-sizeof-pointer-memaccess -Wno-memset-elt-size -Wno-stringop-truncation -Wno-cast-function-type -Wno-tautological-compare -Wno-return-type -Wno-parentheses -Wno-sequence-point -Wno-unused-value" \
          > full_build.log 2>&1  # å…³é”®ï¼šstdoutå’Œstderrå…¨å†™å…¥æ—¥å¿—

        # æ£€æŸ¥ç¼–è¯‘ç»“æœï¼ˆä¸ä¸­æ–­æµç¨‹ï¼‰
        if [ -f "out/arch/arm64/boot/Image.gz" ] || [ -f "out/arch/arm64/boot/Image" ]; then
          echo "KERNEL_BUILD_SUCCESS=true" >> $GITHUB_ENV
        elif [ -f "out/vmlinux" ]; then
          echo "KERNEL_BUILD_SUCCESS=partial" >> $GITHUB_ENV
        else
          echo "KERNEL_BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: æ”¶é›†å¹¶è¾“å‡ºæ‰€æœ‰ç¼–è¯‘é”™è¯¯
      run: |
        cd $KERNEL_DIR
        # ç”Ÿæˆé”™è¯¯æ±‡æ€»æ–‡ä»¶
        echo "=== ç¼–è¯‘é”™è¯¯æ±‡æ€»ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰ ===" > error_summary.log
        echo "é”™è¯¯æ€»æ•°ï¼š$(grep -c "error:" full_build.log)" >> error_summary.log
        echo "----------------------------------------" >> error_summary.log
        # æå–å«"error:"çš„è¡Œï¼ˆä¿ç•™ä¸Šä¸‹æ–‡2è¡Œï¼Œå»é‡ï¼‰
        grep -A 2 -B 1 "error:" full_build.log | sort -u >> error_summary.log
        
        # åœ¨å·¥ä½œæµæ—¥å¿—ä¸­æ˜¾ç¤ºé”™è¯¯æ±‡æ€»
        echo "==================== é”™è¯¯æ±‡æ€» ===================="
        cat error_summary.log
        echo "================================================="

    - name: Check build results
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºç»“æœæ£€æŸ¥ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰ ==="
        
        if [ "$KERNEL_BUILD_SUCCESS" = "true" ]; then
          echo "âœ… å‹ç¼©å†…æ ¸é•œåƒç”ŸæˆæˆåŠŸ!"
          echo "KERNEL_BUILD_SUCCESS=true" >> $GITHUB_ENV
        elif [ "$KERNEL_BUILD_SUCCESS" = "partial" ]; then
          echo "âš ï¸  vmlinux ç”ŸæˆæˆåŠŸä½†æœªæ‰“åŒ…"
          echo "KERNEL_BUILD_SUCCESS=partial" >> $GITHUB_ENV
        else
          echo "âŒ æœªç”Ÿæˆå†…æ ¸é•œåƒ"
          echo "KERNEL_BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: Create build report
      if: always()
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºæŠ¥å‘Šï¼ˆä¿®å¤ç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰ ==="
        
        if [ "$KERNEL_BUILD_SUCCESS" = "true" ]; then
          echo "ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸ!ï¼ˆå½“å‰ä¿®å¤ç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰"
        elif [ "$KERNEL_BUILD_SUCCESS" = "partial" ]; then
          echo "âš ï¸  éƒ¨åˆ†æˆåŠŸ - ç”Ÿæˆ vmlinuxï¼ˆå½“å‰ä¿®å¤ç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰"
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼ˆå½“å‰ä¿®å¤ç‰ˆæœ¬ï¼šv${{ env.FIX_VERSION }}ï¼‰"
          echo "é”™è¯¯è¯¦æƒ…è§ä¸Šæ–¹ã€Œé”™è¯¯æ±‡æ€»ã€"
        fi
        
        echo ""
        echo "ğŸ”§ ä¿®å¤æ¸…å•ï¼ˆå…±22é¡¹ï¼‰:"
        echo "  1. âœ… try_to_unmap å‚æ•°ä¿®å¤"
        echo "  2. âœ… blocktag æ ¼å¼å­—ç¬¦ä¸²ä¿®å¤" 
        echo "  3. âœ… get_boot_mode ç±»å‹å†²çªä¿®å¤"
        echo "  4. âœ… mtk_cm_mgr memset ä¿®å¤"
        echo "  5. âœ… keyslot-manager å†…è”å‡½æ•°ä¿®å¤"
        echo "  6. âœ… blk-crypto å†…è”å‡½æ•°ä¿®å¤"
        echo "  7. âœ… blk-crypto.c å‡½æ•°è°ƒç”¨ä¿®å¤"
        echo "  8. âœ… mtk_battery.c kstrtoint è¿”å›å€¼ä¿®å¤"
        echo "  9. âœ… ccci_util_lib_sys.c åœ°å€è­¦å‘Šä¿®å¤"
        echo " 10. âœ… mtk_charger_intf.h å¼€å…³ä¸å¯è¾¾ä¿®å¤"
        echo " 11. âœ… cmdq_sec_mtee.c å­—ç¬¦ä¸²ç»ˆæ­¢ç¬¦ä¿®å¤ï¼ˆå…³é”®ï¼‰"
        echo " 12. âœ… gl_cfg80211.c memset å…ƒç´ å¤§å°ä¿®å¤"
        echo " 13. âœ… mtk_charger.c è¯­æ³•é”™è¯¯ä¿®å¤ï¼ˆä¿ç•™å……ç”µåŠŸèƒ½ï¼‰"
        echo " 14. âœ… extcon-mtk-usb.c å˜é‡åæ‹¼å†™é”™è¯¯ä¿®å¤ï¼ˆtval -> pvalï¼‰"
        echo " 15. âœ… hacc_sk.c SMSG å®å‚æ•°ä¼ é€’é”™è¯¯ä¿®å¤ï¼ˆæ‰‹åŠ¨å®Œæˆï¼‰"
        echo " 16. âœ… alsps.c å‡½æ•°å‚æ•°å£°æ˜ä¸å¤´æ–‡ä»¶ä¸åŒ¹é…ä¿®å¤ï¼ˆæ•°ç»„vsæŒ‡é’ˆï¼‰"
        echo " 17. âœ… ddp_ovl.c C90æ··åˆå£°æ˜ä¸ä»£ç é”™è¯¯ä¿®å¤"
        echo " 18. âœ… musb_qmu.c å­—ç¬¦ä¸²æœªé—­åˆé”™è¯¯ä¿®å¤"
        echo " 19. âœ… Kconfig ç±»å‹å†²çªï¼ˆtristate/boolï¼‰å’Œä¾èµ–é—®é¢˜ä¿®å¤"
        echo " 20. âœ… mtk_charger.c ä»£ç å—æœªé—­åˆåŠå‡½æ•°å£°æ˜ä¿®å¤"
        echo " 21. âœ… ddp_ovl.c mem_type æœªå£°æ˜ä¿®å¤"
        echo " 22. âœ… PROC_FOPS_RW å®ä¾èµ–å‡½æ•°å£°æ˜ä¿®å¤"

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-v${{ env.FIX_VERSION }}-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/out/vmlinux
          ${{ env.KERNEL_DIR }}/full_build.log
          ${{ env.KERNEL_DIR }}/error_summary.log  # æ–°å¢é”™è¯¯æ±‡æ€»æ–‡ä»¶
          ${{ env.KERNEL_DIR }}/.config
        retention-days: 30