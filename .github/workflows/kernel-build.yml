name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'å†…æ ¸é…ç½®æ–‡ä»¶'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ç¼–è¯‘å†…æ ¸ (ç®€æ´è¾“å‡ºç‰ˆ)
      run: |
        echo "=== ðŸš€ å¼€å§‹å†…æ ¸ç¼–è¯‘ ==="
        
        # èŽ·å–ç³»ç»Ÿä¿¡æ¯
        CPU_CORES=$(nproc)
        PARALLEL_JOBS=$((CPU_CORES * 2))
        
        echo "é…ç½®: $PARALLEL_JOBS å¹¶è¡Œä»»åŠ¡ | $ARCHæž¶æž„ | allç›®æ ‡"
        
        # é™é»˜å®‰è£…ä¾èµ–
        sudo apt-get update -y > /dev/null 2>&1
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git python3 gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi libncurses-dev dwarves \
          rsync kmod cpio > /dev/null 2>&1
        
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        
        # å…‹éš†æºç 
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/WUNELEZI1/Gale-Kernel-Source.git kernel-source --quiet
        
        cd kernel-source
        
        # å¿«é€Ÿé…ç½®
        rm -f .config .config.old
        make ${{ github.event.inputs.defconfig }} > /dev/null 2>&1 || make defconfig > /dev/null 2>&1
        
        echo "âœ… é…ç½®å®Œæˆ | å¼€å§‹ç¼–è¯‘..."
        
        # ç®€æ´ç¼–è¯‘è¾“å‡º
        START_TIME=$(date +%s)
        
        # ä½¿ç”¨ç®€æ´æ¨¡å¼ç¼–è¯‘ - åªæ˜¾ç¤ºé‡è¦ä¿¡æ¯
        {
          echo "ç¼–è¯‘è¿›åº¦ç›‘æŽ§ (æ¯10ç§’æ›´æ–°):"
          while sleep 10; do
            if ps aux | grep -v grep | grep -q "make"; then
              COMPILED_FILES=$(find . -name "*.o" -type f | wc -l)
              echo "[$(date +%H:%M:%S)] å·²ç¼–è¯‘: $COMPILED_FILES ä¸ªæ–‡ä»¶"
            else
              break
            fi
          done &
          MONITOR_PID=$!
          
          # ä¸»è¦ç¼–è¯‘è¿‡ç¨‹ - è¿‡æ»¤è¾“å‡º
          make -j$PARALLEL_JOBS all 2>&1 | grep -E --line-buffered "error:|warning:|CC |LD |AR |Building|Entering directory|Leaving directory" | head -1000
          
          kill $MONITOR_PID 2>/dev/null
        } | tee build.log
        
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        
        END_TIME=$(date +%s)
        COMPILE_TIME=$((END_TIME - START_TIME))
        
        # ç»“æžœåˆ†æž
        ERROR_COUNT=$(grep -c "error:" build.log || true)
        WARNING_COUNT=$(grep -c "warning:" build.log || true)
        
        echo ""
        echo "=== ç¼–è¯‘å®Œæˆ ==="
        echo "è€—æ—¶: ${COMPILE_TIME}ç§’"
        echo "ç»“æžœ: $([ $BUILD_EXIT_CODE -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
        echo "ç»Ÿè®¡: $ERROR_COUNT é”™è¯¯ | $WARNING_COUNT è­¦å‘Š"
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          if ls arch/$ARCH/boot/Image* >/dev/null 2>&1; then
            echo "ç”Ÿæˆæ–‡ä»¶:"
            ls -lh arch/$ARCH/boot/Image* | awk '{print "  " $9 " (" $5 ")"}'
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "âš ï¸ æ— å†…æ ¸é•œåƒ"
            echo "BUILD_STATUS=no_image" >> $GITHUB_ENV
          fi
        else
          echo "æœ€åŽé”™è¯¯:"
          grep "error:" build.log | tail -3 | sed 's/^/  /'
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV
        fi
        
        echo "ERROR_COUNT=$ERROR_COUNT" >> $GITHUB_ENV
        echo "COMPILE_TIME=$COMPILE_TIME" >> $GITHUB_ENV

    - name: ä¸Šä¼ äº§ç‰©
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-images
        path: kernel-source/arch/arm64/boot/

    - name: ä¸Šä¼ æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: kernel-source/build.log