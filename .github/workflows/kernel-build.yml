name: Kernel Build Diagnostics

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  diagnose:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python2.7 python2.7-dev \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Download Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r23c-linux.zip
        unzip -q android-ndk-r23c-linux.zip
        echo "NDK_PATH=$(pwd)/android-ndk-r23c" >> $GITHUB_ENV

    - name: Setup environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        
        NDK_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
        echo "CC=$NDK_BIN/clang" >> $GITHUB_ENV
        echo "CROSS_COMPILE=$NDK_BIN/aarch64-linux-android-" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV

    - name: Verify kernel source
      run: |
        cd $KERNEL_DIR
        echo "=== 内核源码验证 ==="
        echo "当前目录: $(pwd)"
        echo "目录内容:"
        ls -la
        echo "Makefile 存在: $( [ -f Makefile ] && echo '是' || echo '否' )"
        echo "defconfig 存在: $( [ -f arch/arm64/configs/k69v1_64_k419_defconfig ] && echo '是' || echo '否' )"
        
        if [ -f Makefile ]; then
          echo "内核版本:"
          head -5 Makefile
        fi

    - name: Test configuration
      run: |
        cd $KERNEL_DIR
        echo "=== 测试内核配置 ==="
        
        # 清理
        rm -rf out
        mkdir -p out
        
        # 尝试配置
        echo "尝试配置内核..."
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }} && {
          echo "✅ 配置成功"
          ls -la out/
        } || {
          echo "❌ 配置失败"
          echo "尝试使用 defconfig..."
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig && {
            echo "✅ 基础配置成功"
            ls -la out/
          } || {
            echo "❌ 所有配置都失败"
          }
        }

    - name: Test compilation
      run: |
        cd $KERNEL_DIR
        echo "=== 测试编译 ==="
        
        if [ ! -f "out/.config" ]; then
          echo "❌ 没有配置文件，跳过编译测试"
          exit 0
        fi
        
        echo "开始编译测试..."
        # 只编译少量目标来测试工具链
        make O=out ARCH=arm64 -j1 \
          CC="$CC" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CLANG_TRIPLE="$CLANG_TRIPLE" \
          scripts 2>&1 | tee compile-test.log || {
          echo "编译测试失败"
          tail -20 compile-test.log
        }

    - name: Full compilation attempt
      run: |
        cd $KERNEL_DIR
        echo "=== 完整编译尝试 ==="
        
        if [ ! -f "out/.config" ]; then
          echo "❌ 没有配置文件，无法编译"
          exit 1
        fi
        
        # 禁用有问题的驱动
        echo "调整配置以解决链接错误..."
        ./scripts/config --file out/.config -d ACCDET_MT6358
        ./scripts/config --file out/.config -d MTK_SENSORS_1_0
        ./scripts/config --file out/.config -d INPUT_FINGERPRINT
        ./scripts/config --file out/.config -d MEDIATEX_EXTCON
        make O=out ARCH=arm64 olddefconfig
        
        echo "开始完整编译..."
        time make O=out ARCH=arm64 -j2 \
          CC="$CC" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CLANG_TRIPLE="$CLANG_TRIPLE" \
          2>&1 | tee full-build.log

    - name: Analyze results
      run: |
        cd $KERNEL_DIR
        echo "=== 结果分析 ==="
        
        echo "1. out 目录状态:"
        find out/ -type f 2>/dev/null | head -20 || echo "out 目录为空"
        
        echo "2. 编译日志分析:"
        if [ -f "full-build.log" ]; then
          echo "编译日志行数: $(wc -l < full-build.log)"
          echo "错误数量: $(grep -c "error:" full-build.log || echo 0)"
          echo "警告数量: $(grep -c "warning:" full-build.log || echo 0)"
          
          echo "最后错误:"
          grep "error:" full-build.log | tail -5 || echo "无错误"
        else
          echo "无完整编译日志"
        fi
        
        if [ -f "compile-test.log" ]; then
          echo "编译测试错误:"
          grep "error:" compile-test.log | tail -5 || echo "无错误"
        fi
        
        echo "3. 检查生成的内核文件:"
        find out/ -name "vmlinux" -o -name "Image*" -o -name "*.gz" -o -name "*.img" 2>/dev/null | while read f; do
          echo "找到: $f"
        done || echo "无内核文件"

    - name: Upload diagnostics
      uses: actions/upload-artifact@v4
      with:
        name: kernel-diagnostics-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/compile-test.log
          ${{ env.KERNEL_DIR }}/full-build.log
          ${{ env.KERNEL_DIR }}/out/.config
        retention-days: 15

    - name: Upload kernel if exists
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-output-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/out/vmlinux
        retention-days: 30