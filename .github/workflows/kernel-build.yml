name: Build MTK Kernel 4.19 (é€šç”¨ç¼–è¯‘)

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'å†…æ ¸é…ç½®æ–‡ä»¶'
        required: true
        default: 'k69v1_64_k419_defconfig'
      build_target:
        description: 'ç¼–è¯‘ç›®æ ‡'
        required: true
        default: 'Image.gz-dtb'
        type: choice
        options:
          - Image.gz-dtb
          - Image
          - all

env:
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: æ£€å‡ºå½“å‰ä»“åº“
      uses: actions/checkout@v4

    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        echo "=== å…‹éš†å†…æ ¸æºç  ==="
        
        # å°è¯•å…‹éš† MediaTek å†…æ ¸ä»“åº“
        if git clone --depth=1 --branch=main https://github.com/MediaTek-Labs/common-kernel-4.19.git kernel-source; then
          echo "âœ… æˆåŠŸå…‹éš† MediaTek å†…æ ¸æºç "
          echo "KERNEL_SOURCE=kernel-source" >> $GITHUB_ENV
        else
          echo "âŒ MediaTek ä»“åº“å…‹éš†å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ä»“åº“"
          # å°è¯•å…‹éš†ä½ åŽŸæ¥çš„ä»“åº“ä½œä¸ºå¤‡ç”¨
          if git clone --depth=1 --branch=mt6768-4.19 https://github.com/WUNELEZI1/Gale-Kernel-Source.git kernel-source; then
            echo "âœ… æˆåŠŸå…‹éš†å¤‡ç”¨å†…æ ¸æºç "
            echo "KERNEL_SOURCE=kernel-source" >> $GITHUB_ENV
          else
            echo "âŒ æ‰€æœ‰ä»“åº“å…‹éš†éƒ½å¤±è´¥"
            exit 1
          fi
        fi
        
        cd kernel-source
        echo "å†…æ ¸ç›®å½•: $(pwd)"
        echo "å†…æ ¸ç‰ˆæœ¬: $(make kernelversion 2>/dev/null || echo 'æœªçŸ¥')"

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi libncurses-dev dwarves curl file \
          rsync kmod cpio
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        sudo apt-get clean

    - name: æ˜¾ç¤ºçŽ¯å¢ƒä¿¡æ¯
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== æž„å»ºçŽ¯å¢ƒä¿¡æ¯ ==="
        echo "å†…æ ¸ç‰ˆæœ¬: $(make kernelversion 2>/dev/null || echo 'æœªçŸ¥')"
        echo "æž¶æž„: $ARCH"
        echo "äº¤å‰ç¼–è¯‘å™¨: $CROSS_COMPILE"
        echo "é…ç½®æ–‡ä»¶: ${{ github.event.inputs.defconfig }}"
        echo "ç¼–è¯‘ç›®æ ‡: ${{ github.event.inputs.build_target }}"
        which aarch64-linux-gnu-gcc
        aarch64-linux-gnu-gcc --version | head -1

    - name: é…ç½®å†…æ ¸ (é€šç”¨æ–¹æ³•)
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== æ­¥éª¤1: ç”Ÿæˆé»˜è®¤é…ç½® ==="
        
        # æ¸…ç†ä¹‹å‰çš„é…ç½®
        make mrproper
        
        # æ˜¾ç¤ºå¯ç”¨çš„é…ç½®
        echo "å¯ç”¨çš„é…ç½®æ–‡ä»¶:"
        find arch/arm64/configs -name "*defconfig" | head -10 || echo "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
        
        # å°è¯•ç”Ÿæˆé…ç½®
        echo "ä½¿ç”¨é…ç½®: ${{ github.event.inputs.defconfig }}"
        if ! make ${{ github.event.inputs.defconfig }}; then
          echo "âŒ é…ç½®ç”Ÿæˆå¤±è´¥"
          echo "å°è¯•ä½¿ç”¨é»˜è®¤é…ç½®..."
          if ! make defconfig; then
            echo "âŒ æ‰€æœ‰é…ç½®å°è¯•éƒ½å¤±è´¥"
            exit 1
          fi
        fi
        
        echo "âœ… é…ç½®ç”ŸæˆæˆåŠŸ"
        
        # æ˜¾ç¤ºä¸€äº›å…³é”®é…ç½®
        echo "=== å…³é”®é…ç½®æ£€æŸ¥ ==="
        grep -E "CONFIG_DEBUG_INFO|CONFIG_MODULES|CONFIG_ARM64" .config | head -10

    - name: ç¼–è¯‘å†…æ ¸ (é€šç”¨æ–¹æ³•)
      id: compile
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== æ­¥éª¤2: å¼€å§‹ç¼–è¯‘å†…æ ¸ ==="
        
        CORES=$(nproc)
        JOBS=$((CORES * 2))
        echo "ä½¿ç”¨ $JOBS ä¸ªå¹¶è¡Œä»»åŠ¡ç¼–è¯‘"
        
        # å¼€å§‹ç¼–è¯‘
        set +e
        time make -j$JOBS ${{ github.event.inputs.build_target }} 2>&1 | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        # åˆ†æžç¼–è¯‘ç»“æžœ
        ERROR_COUNT=$(grep -c "error:" build.log || true)
        WARNING_COUNT=$(grep -c "warning:" build.log || true)
        
        echo "ç¼–è¯‘é€€å‡ºç : $BUILD_EXIT_CODE"
        echo "é”™è¯¯æ•°é‡: $ERROR_COUNT"
        echo "è­¦å‘Šæ•°é‡: $WARNING_COUNT"
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†å†…æ ¸é•œåƒ
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          if [ -f "arch/$ARCH/boot/Image.gz-dtb" ] || [ -f "arch/$ARCH/boot/Image" ]; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "âœ… ç¼–è¯‘æˆåŠŸ - å†…æ ¸é•œåƒå·²ç”Ÿæˆ"
          else
            echo "BUILD_STATUS=no_image" >> $GITHUB_ENV
            echo "âš ï¸ ç¼–è¯‘è¿‡ç¨‹æˆåŠŸä½†æœªæ‰¾åˆ°å†…æ ¸é•œåƒ"
          fi
        else
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV
          echo "âŒ ç¼–è¯‘å¤±è´¥"
        fi
        
        # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
        echo "ERROR_COUNT=$ERROR_COUNT" >> $GITHUB_ENV
        echo "WARNING_COUNT=$WARNING_COUNT" >> $GITHUB_ENV

    - name: åˆ†æžç¼–è¯‘é”™è¯¯
      if: env.BUILD_STATUS == 'failed'
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== ç¼–è¯‘é”™è¯¯åˆ†æž ==="
        
        # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
        if [ ! -f "build.log" ]; then
          echo "âŒ build.log æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æå–å‰20ä¸ªé”™è¯¯åŠå…¶ä¸Šä¸‹æ–‡
        echo "=== ä¸»è¦é”™è¯¯æ±‡æ€» ===" > error_analysis.log
        grep -A 3 -B 1 "error:" build.log | head -n 80 >> error_analysis.log
        
        # é”™è¯¯åˆ†ç±»ç»Ÿè®¡
        echo "" >> error_analysis.log
        echo "=== é”™è¯¯ç±»åž‹ç»Ÿè®¡ ===" >> error_analysis.log
        grep "error:" build.log | sed 's/.*error: //' | sort | uniq -c | sort -nr | head -10 >> error_analysis.log
        
        cat error_analysis.log

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      if: env.BUILD_STATUS == 'success'
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶æ£€æŸ¥ ==="
        find arch/$ARCH/boot/ -type f -ls
        echo "å†…æ ¸å¤§å°ç»Ÿè®¡:"
        ls -lh arch/$ARCH/boot/Image* 2>/dev/null || echo "æœªæ‰¾åˆ°Imageæ–‡ä»¶"
        ls -lh arch/$ARCH/boot/*.dtb 2>/dev/null || echo "æœªæ‰¾åˆ°DTBæ–‡ä»¶"

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-success
        path: |
          ${{ env.KERNEL_SOURCE }}/arch/arm64/boot/
          ${{ env.KERNEL_SOURCE }}/.config
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ${{ env.KERNEL_SOURCE }}/build.log
          ${{ env.KERNEL_SOURCE }}/error_analysis.log
        retention-days: 7

    - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      if: always()
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== æž„å»ºæŠ¥å‘Š ===" > build_report.md
        echo "**æž„å»ºçŠ¶æ€:** $BUILD_STATUS" >> build_report.md
        echo "**é”™è¯¯æ•°é‡:** $ERROR_COUNT" >> build_report.md
        echo "**è­¦å‘Šæ•°é‡:** $WARNING_COUNT" >> build_report.md
        echo "**é…ç½®æ–‡ä»¶:** ${{ github.event.inputs.defconfig }}" >> build_report.md
        echo "**ç¼–è¯‘ç›®æ ‡:** ${{ github.event.inputs.build_target }}" >> build_report.md
        echo "" >> build_report.md
        
        if [ "$BUILD_STATUS" = "success" ]; then
          echo "ðŸŽ‰ **ç¼–è¯‘æˆåŠŸ!**" >> build_report.md
          echo "ç”Ÿæˆçš„å†…æ ¸æ–‡ä»¶:" >> build_report.md
          find arch/$ARCH/boot/ -name "Image*" -o -name "*.dtb" | sed 's/^/- /' >> build_report.md
        elif [ "$BUILD_STATUS" = "failed" ]; then
          echo "âŒ **ç¼–è¯‘å¤±è´¥**" >> build_report.md
          echo "" >> build_report.md
          echo "ä¸»è¦é”™è¯¯ç±»åž‹:" >> build_report.md
          grep "error:" build.log | sed 's/.*error: //' | sort | uniq -c | sort -nr | head -5 | sed 's/^/- /' >> build_report.md
        fi
        
        cat build_report.md

    - name: ä¸Šä¼ æž„å»ºæŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: ${{ env.KERNEL_SOURCE }}/build_report.md
        retention-days: 7