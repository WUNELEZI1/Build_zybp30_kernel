name: Build MT6768 Kernel (Source Fix)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Python 2.7 and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository universe
        sudo apt-get update
        sudo apt-get install -y python2.7 python2.7-dev
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2
        python2 --version

    - name: Install kernel build dependencies
      run: |
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip ccache python3 \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl lz4 lzop \
          rsync kmod cpio file patch

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix source code errors
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤æºç é”™è¯¯ ==="
        
        # ä¿®å¤ extcon-mtk-usb.c ä¸­çš„å˜é‡åé”™è¯¯
        if [ -f "drivers/misc/mediatek/extcon/extcon-mtk-usb.c" ]; then
          echo "ä¿®å¤ extcon-mtk-usb.c ä¸­çš„ tval -> pval"
          sed -i 's/tval\.intval/pval.intval/g' drivers/misc/mediatek/extcon/extcon-mtk-usb.c
          echo "ä¿®å¤å®Œæˆï¼ŒéªŒè¯:"
          grep -n "pval.intval" drivers/misc/mediatek/extcon/extcon-mtk-usb.c | head -5
        else
          echo "æœªæ‰¾åˆ° extcon-mtk-usb.c æ–‡ä»¶"
        fi
        
        # æ£€æŸ¥å¹¶ä¿®å¤å…¶ä»–å¸¸è§é”™è¯¯
        echo "æ£€æŸ¥å…¶ä»–å¯èƒ½çš„é”™è¯¯..."
        
        # ä¿®å¤å¯èƒ½çš„æƒé™é—®é¢˜
        find . -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true

    - name: Download Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r23c-linux.zip
        unzip -q android-ndk-r23c-linux.zip
        echo "NDK_PATH=$(pwd)/android-ndk-r23c" >> $GITHUB_ENV

    - name: Setup build environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        
        NDK_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
        echo "CC=$NDK_BIN/clang" >> $GITHUB_ENV
        echo "LD=$NDK_BIN/ld.lld" >> $GITHUB_ENV
        echo "AR=$NDK_BIN/llvm-ar" >> $GITHUB_ENV
        echo "NM=$NDK_BIN/llvm-nm" >> $GITHUB_ENV
        echo "STRIP=$NDK_BIN/llvm-strip" >> $GITHUB_ENV
        echo "OBJCOPY=$NDK_BIN/llvm-objcopy" >> $GITHUB_ENV
        echo "OBJDUMP=$NDK_BIN/llvm-objdump" >> $GITHUB_ENV
        echo "CROSS_COMPILE=$NDK_BIN/aarch64-linux-android-" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV

    - name: Configure kernel
      run: |
        cd $KERNEL_DIR
        mkdir -p out
        
        echo "é…ç½®å†…æ ¸..."
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }} || {
          echo "ç‰¹å®šé…ç½®å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€é…ç½®"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        }

    - name: Build kernel with fixes
      run: |
        cd $KERNEL_DIR
        
        if [ ! -f "out/.config" ]; then
          echo "âŒ æ²¡æœ‰é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        echo "=== å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼ˆå·²ä¿®å¤æºç é”™è¯¯ï¼‰==="
        
        # è®¾ç½®å®½æ¾çš„ç¼–è¯‘æ ‡å¿—ï¼Œé¿å…å› è­¦å‘Šè€Œåœæ­¢
        export KCFLAGS="-Wno-error -Wno-unused-variable -Wno-unused-function"
        
        time make O=out ARCH=arm64 -j$(($(nproc)/2)) \
          CC="$CC" \
          LD="$LD" \
          AR="$AR" \
          NM="$NM" \
          STRIP="$STRIP" \
          OBJCOPY="$OBJCOPY" \
          OBJDUMP="$OBJDUMP" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CLANG_TRIPLE="$CLANG_TRIPLE" \
          KCFLAGS="$KCFLAGS" \
          2>&1 | tee build.log

    - name: Check build progress
      if: failure()
      run: |
        cd $KERNEL_DIR
        echo "=== ç¼–è¯‘è¿›åº¦æ£€æŸ¥ ==="
        
        # æ£€æŸ¥ç¼–è¯‘åˆ°äº†å“ªä¸ªé˜¶æ®µ
        echo "å·²ç¼–è¯‘çš„æ–‡ä»¶æ•°é‡:"
        find out/ -name "*.o" | wc -l || echo "0"
        
        echo "ç¼–è¯‘é”™è¯¯ç»Ÿè®¡:"
        grep -c "error:" build.log || echo "0"
        
        echo "æœ€åçš„é”™è¯¯:"
        tail -20 build.log

    - name: Upload partial build
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: partial-build-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/build.log
          ${{ env.KERNEL_DIR }}/out/.config
        retention-days: 15

    - name: Upload successful kernel
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-success-${{ github.run_number }}
        path: ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
        retention-days: 30

    - name: Final verification
      if: success()
      run: |
        cd $KERNEL_DIR
        echo "ğŸ‰ ğŸ‰ ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
        echo "ç”Ÿæˆçš„å†…æ ¸æ–‡ä»¶:"
        ls -lh out/arch/arm64/boot/
        echo "å†…æ ¸é•œåƒå¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"