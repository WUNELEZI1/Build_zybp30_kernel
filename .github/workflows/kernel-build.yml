name: Build MT6768 Kernel (Fixed Config)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Python 2.7 and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository universe
        sudo apt-get update
        sudo apt-get install -y python2.7 python2.7-dev
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2
        python2 --version

    - name: Install kernel build dependencies
      run: |
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip ccache python3 \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl lz4 lzop \
          rsync kmod cpio file

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Debug kernel source structure
      run: |
        cd $KERNEL_DIR
        echo "=== è¯¦ç»†çš„å†…æ ¸æºç åˆ†æ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
        ls -la
        echo "=== æ£€æŸ¥ Makefile ==="
        head -20 Makefile || echo "æ— æ³•è¯»å– Makefile"
        echo "=== æ£€æŸ¥ defconfig ç›®å½• ==="
        ls -la arch/arm64/configs/ | head -20
        echo "=== æ£€æŸ¥æŒ‡å®šçš„ defconfig æ–‡ä»¶ ==="
        if [ -f "arch/arm64/configs/k69v1_64_k419_defconfig" ]; then
          echo "âœ… Defconfig æ–‡ä»¶å­˜åœ¨"
          echo "æ–‡ä»¶å†…å®¹å‰30è¡Œ:"
          head -30 arch/arm64/configs/k69v1_64_k419_defconfig
        else
          echo "âŒ Defconfig æ–‡ä»¶ä¸å­˜åœ¨"
          echo "å¯ç”¨çš„ defconfig æ–‡ä»¶:"
          ls arch/arm64/configs/ | head -15
        fi

    - name: Download Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r23c-linux.zip
        unzip -q android-ndk-r23c-linux.zip
        echo "NDK_PATH=$(pwd)/android-ndk-r23c" >> $GITHUB_ENV

    - name: Setup build environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        
        NDK_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
        echo "CC=$NDK_BIN/clang" >> $GITHUB_ENV
        echo "CROSS_COMPILE=$NDK_BIN/aarch64-linux-android-" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV

    - name: Test kernel configuration step by step
      run: |
        cd $KERNEL_DIR
        
        echo "=== æ­¥éª¤1: å®Œå…¨æ¸…ç†ç¯å¢ƒ ==="
        make distclean 2>/dev/null || true
        rm -rf out
        mkdir -p out
        
        echo "=== æ­¥éª¤2: æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬å’Œæ¶æ„æ”¯æŒ ==="
        grep "VERSION\|PATCHLEVEL" Makefile || echo "æ— æ³•è¯»å–ç‰ˆæœ¬ä¿¡æ¯"
        
        echo "=== æ­¥éª¤3: å°è¯•ä¸åŒçš„é…ç½®æ–¹æ³• ==="
        
        # æ–¹æ³•1: ç›´æ¥ä½¿ç”¨æŒ‡å®šçš„defconfig
        echo "ğŸ”§ å°è¯•æ–¹æ³•1: ç›´æ¥é…ç½®"
        set -x
        make O=out ARCH=arm64 k69v1_64_k419_defconfig
        CONFIG_RESULT=$?
        set +x
        
        if [ $CONFIG_RESULT -ne 0 ]; then
          echo "æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2..."
          
          # æ–¹æ³•2: ä½¿ç”¨é€šç”¨defconfig
          echo "ğŸ”§ å°è¯•æ–¹æ³•2: ä½¿ç”¨é€šç”¨defconfig"
          set -x
          make O=out ARCH=arm64 defconfig
          set +x
          
          if [ -f "out/.config" ]; then
            echo "âœ… é€šç”¨é…ç½®æˆåŠŸï¼Œç°åœ¨å°è¯•åˆå¹¶è‡ªå®šä¹‰é…ç½®"
            # æ‰‹åŠ¨åˆå¹¶é…ç½®
            if [ -f "arch/arm64/configs/k69v1_64_k419_defconfig" ]; then
              set -x
              cat arch/arm64/configs/k69v1_64_k419_defconfig >> out/.config
              make O=out ARCH=arm64 olddefconfig
              set +x
            fi
          fi
        fi
        
        echo "=== é…ç½®ç»“æœæ£€æŸ¥ ==="
        if [ -f "out/.config" ]; then
          echo "âœ… é…ç½®æˆåŠŸ!"
          echo "é…ç½®æ–‡ä»¶è¡Œæ•°: $(wc -l < out/.config)"
        else
          echo "âŒ æ‰€æœ‰é…ç½®æ–¹æ³•éƒ½å¤±è´¥"
          echo "æ£€æŸ¥é”™è¯¯ä¿¡æ¯..."
          exit 1
        fi

    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        echo "=== å¼€å§‹å†…æ ¸ç¼–è¯‘ ==="
        
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰é…ç½®æ–‡ä»¶
        if [ ! -f "out/.config" ]; then
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œæ— æ³•ç¼–è¯‘"
          exit 1
        fi
        
        echo "ä½¿ç”¨é…ç½®æ–‡ä»¶:"
        grep "CONFIG_LOCALVERSION" out/.config || echo "æ— æœ¬åœ°ç‰ˆæœ¬ä¿¡æ¯"
        
        # å¼€å§‹ç¼–è¯‘ï¼Œä¿å­˜è¯¦ç»†æ—¥å¿—
        time make O=out ARCH=arm64 -j$(($(nproc)/2)) \
          CC="$CC" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CLANG_TRIPLE="$CLANG_TRIPLE" \
          V=1 2>&1 | tee build.log

    - name: Analyze build results
      if: always()
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºç»“æœè¯¦ç»†åˆ†æ ==="
        
        # æ£€æŸ¥æ„å»ºæ—¥å¿—
        if [ -f "build.log" ]; then
          echo "ğŸ“„ æ„å»ºæ—¥å¿—å­˜åœ¨ï¼Œå¤§å°: $(wc -l < build.log) è¡Œ"
          echo "=== æ„å»ºæ—¥å¿—æœ€åé”™è¯¯ä¿¡æ¯ ==="
          grep -A 10 -B 5 -i "error\|fail\|stop" build.log | tail -50 || echo "æ— æ˜ç¡®é”™è¯¯ä¿¡æ¯"
        else
          echo "âŒ æ„å»ºæ—¥å¿—ä¸å­˜åœ¨"
        fi
        
        # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        echo "=== è¾“å‡ºç›®å½•å†…å®¹ ==="
        find out/ -type f -name "*.o" 2>/dev/null | head -5 || echo "æ— ç›®æ ‡æ–‡ä»¶"
        find out/ -type f -name "Image*" -o -name "*.img" -o -name "*.gz" 2>/dev/null | while read f; do
          echo "æ‰¾åˆ°: $f ($(du -h "$f" | cut -f1))"
        done
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ âœ… ç¼–è¯‘æˆåŠŸ! æ‰¾åˆ°å†…æ ¸é•œåƒ"
          ls -lh out/arch/arm64/boot/
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥: æœªæ‰¾åˆ°å†…æ ¸é•œåƒ"
          # æ£€æŸ¥é…ç½®é˜¶æ®µæ˜¯å¦æˆåŠŸ
          if [ -f "out/.config" ]; then
            echo "â„¹ï¸ é…ç½®æ–‡ä»¶å­˜åœ¨ä½†ç¼–è¯‘å¤±è´¥"
          else
            echo "âŒ é…ç½®é˜¶æ®µå°±å¤±è´¥äº†"
          fi
        fi

    - name: Upload debug information
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-debug-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/build.log
          ${{ env.KERNEL_DIR }}/out/.config
        retention-days: 15

    - name: Upload kernel artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
        retention-days: 30