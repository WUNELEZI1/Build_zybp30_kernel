name: Build MT6768 Kernel (KConfig Fix)

on:
  workflow_dispatch:
    inputs:
      USE_DEBUG_CONFIG:
        description: 'Use debug defconfig instead'
        required: false
        default: false
        type: boolean

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Python 2.7 and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository universe
        sudo apt-get update
        sudo apt-get install -y python2.7 python2.7-dev
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2
        python2 --version

    - name: Install kernel build dependencies
      run: |
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip ccache python3 \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl lz4 lzop \
          rsync kmod cpio file

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Download Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r23c-linux.zip
        unzip -q android-ndk-r23c-linux.zip
        echo "NDK_PATH=$(pwd)/android-ndk-r23c" >> $GITHUB_ENV

    - name: Setup build environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        
        NDK_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
        echo "CC=$NDK_BIN/clang" >> $GITHUB_ENV
        echo "CROSS_COMPILE=$NDK_BIN/aarch64-linux-android-" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV

    - name: Analyze Kconfig conflicts
      run: |
        cd $KERNEL_DIR
        echo "=== 详细分析 Kconfig 冲突 ==="
        
        # 检查有问题的 Kconfig 文件
        echo "检查 drivers/power/supply/mediatek/charger/Kconfig:199"
        if [ -f "drivers/power/supply/mediatek/charger/Kconfig" ]; then
          sed -n '195,205p' drivers/power/supply/mediatek/charger/Kconfig || echo "无法读取文件"
        fi
        
        echo "检查 drivers/soc/mediatek/Kconfig:7"
        if [ -f "drivers/soc/mediatek/Kconfig" ]; then
          sed -n '1,15p' drivers/soc/mediatek/Kconfig || echo "无法读取文件"
        fi
        
        # 检查 defconfig 中的相关配置
        echo "=== defconfig 中的相关配置 ==="
        grep -E "CHARGER_BQ25890|MTK_CMDQ" arch/arm64/configs/k69v1_64_k419_defconfig || echo "未在defconfig中找到相关配置"

    - name: Create manual config workaround
      run: |
        cd $KERNEL_DIR
        echo "=== 创建手动配置绕过方案 ==="
        
        mkdir -p out
        
        # 方法1: 使用最小配置开始
        echo "方法1: 使用最小 arm64 配置"
        make O=out ARCH=arm64 defconfig
        
        if [ -f "out/.config" ]; then
          echo "✅ 基础配置创建成功"
          
          # 手动设置必要的 MTK 配置
          echo "手动设置 MTK 相关配置..."
          # 这些是 MT6768 可能需要的配置
          ./scripts/config --file out/.config -e ARCH_MEDIATEK
          ./scripts/config --file out/.config -e ARM64
          ./scripts/config --file out/.config -e MTK_PLATFORM_ARM64
          
          # 对有冲突的配置使用安全值
          ./scripts/config --file out/.config -d CHARGER_BQ25890
          ./scripts/config --file out/.config -d MTK_CMDQ
          
          # 更新配置
          make O=out ARCH=arm64 olddefconfig
        else
          echo "❌ 基础配置失败"
          exit 1
        fi

    - name: Try alternative config methods
      run: |
        cd $KERNEL_DIR
        
        # 检查是否要使用 debug 配置
        if [ "${{ github.event.inputs.USE_DEBUG_CONFIG }}" = "true" ]; then
          echo "=== 尝试使用 debug defconfig ==="
          rm -rf out
          mkdir -p out
          make O=out ARCH=arm64 k69v1_64_k419_debug_defconfig && {
            echo "✅ Debug defconfig 成功"
            exit 0
          } || {
            echo "❌ Debug defconfig 也失败"
          }
        fi
        
        # 方法2: 使用 allyesconfig 然后精简
        echo "=== 方法2: 使用 allyesconfig ==="
        rm -rf out
        mkdir -p out
        make O=out ARCH=arm64 allyesconfig && {
          echo "✅ Allyesconfig 成功，现在精简配置"
          # 禁用所有配置，然后重新启用必要的
          make O=out ARCH=arm64 allnoconfig
          # 重新启用 ARM64 基础配置
          ./scripts/config --file out/.config -e ARM64
          ./scripts/config --file out/.config -e 64BIT
          make O=out ARCH=arm64 olddefconfig
        }

    - name: Build with manual config
      run: |
        cd $KERNEL_DIR
        
        # 验证配置
        if [ ! -f "out/.config" ]; then
          echo "❌ 没有有效的配置文件"
          exit 1
        fi
        
        echo "=== 配置摘要 ==="
        grep -E "ARM64|MTK|MEDIATEK|CHARGER|CMDQ" out/.config | head -20
        
        echo "=== 开始编译 ==="
        # 使用单线程编译以避免复杂错误
        make O=out ARCH=arm64 -j1 \
          CC="$CC" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CLANG_TRIPLE="$CLANG_TRIPLE" \
          2>&1 | tee build.log

    - name: Check minimal build results
      run: |
        cd $KERNEL_DIR
        echo "=== 最小构建检查 ==="
        
        # 检查是否生成了任何内核镜像
        if find out/arch/arm64/boot/ -name "Image*" 2>/dev/null | grep -q .; then
          echo "✅ 成功生成了内核镜像"
          find out/arch/arm64/boot/ -name "Image*" -exec ls -lh {} \;
        else
          echo "❌ 未找到内核镜像"
          echo "=== 构建错误 ==="
          grep -i "error\|undefined\|conflict" build.log | head -20
          echo "=== 最后编译步骤 ==="
          tail -30 build.log
        fi

    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kconfig-fix-results-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/build.log
          ${{ env.KERNEL_DIR }}/out/.config
        retention-days: 15

    - name: Upload kernel if successful
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-minimal-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
        retention-days: 30