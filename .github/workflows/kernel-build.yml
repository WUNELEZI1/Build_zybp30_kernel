name: Build MTK Kernel 4.19 (ä¿®å¤ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'å†…æ ¸é…ç½®æ–‡ä»¶'
        required: true
        default: 'k69v1_64_defconfig'
      build_target:
        description: 'ç¼–è¯‘ç›®æ ‡'
        required: true
        default: 'Image.gz-dtb'
        type: choice
        options:
          - Image.gz-dtb
          - Image
          - all

env:
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-linux-22.04
    timeout-minutes: 120

    steps:
    - name: æ£€å‡ºå½“å‰ä»“åº“
      uses: actions/checkout@v4

    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        echo "=== å…‹éš†å†…æ ¸æºç  ==="
        
        # å°è¯•å…‹éš†ä½ åŸæ¥çš„ä»“åº“ï¼ˆè¿™ä¸ªæˆ‘ä»¬çŸ¥é“å¯ä»¥å·¥ä½œï¼‰
        if git clone --depth=1 --branch=mt6768-4.19 https://github.com/WUNELEZI1/Gale-Kernel-Source.git kernel-source; then
          echo "âœ… æˆåŠŸå…‹éš†å†…æ ¸æºç "
          echo "KERNEL_SOURCE=kernel-source" >> $GITHUB_ENV
        else
          echo "âŒ å†…æ ¸æºç å…‹éš†å¤±è´¥"
          exit 1
        fi

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi libncurses-dev dwarves curl file \
          rsync kmod cpio
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        sudo apt-get clean

    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== æ„å»ºç¯å¢ƒä¿¡æ¯ ==="
        echo "å†…æ ¸ç›®å½•: $(pwd)"
        echo "æ¶æ„: $ARCH"
        echo "äº¤å‰ç¼–è¯‘å™¨: $CROSS_COMPILE"
        echo "é…ç½®æ–‡ä»¶: ${{ github.event.inputs.defconfig }}"
        echo "ç¼–è¯‘ç›®æ ‡: ${{ github.event.inputs.build_target }}"
        
        # æ˜¾ç¤ºå¯ç”¨çš„é…ç½®æ–‡ä»¶
        echo "=== å¯ç”¨çš„é…ç½®æ–‡ä»¶ ==="
        find arch/arm64/configs -name "*defconfig" | head -10 || echo "æœªæ‰¾åˆ°arm64é…ç½®æ–‡ä»¶"
        find arch/arm/configs -name "*defconfig" | head -5 || echo "æœªæ‰¾åˆ°armé…ç½®æ–‡ä»¶"

    - name: é…ç½®å†…æ ¸ (è·³è¿‡æ¸…ç†)
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== é…ç½®å†…æ ¸ ==="
        
        # è·³è¿‡ mrproperï¼Œç›´æ¥å°è¯•ç”Ÿæˆé…ç½®
        echo "è·³è¿‡ make mrproper (é¿å…ç›®å½•é”™è¯¯)"
        
        # å°è¯•ç”Ÿæˆé…ç½®
        echo "ä½¿ç”¨é…ç½®: ${{ github.event.inputs.defconfig }}"
        if ! make ${{ github.event.inputs.defconfig }}; then
          echo "âŒ æŒ‡å®šé…ç½®å¤±è´¥ï¼Œå°è¯•æŸ¥æ‰¾å¯ç”¨é…ç½®..."
          
          # å°è¯•ä¸€äº›å¸¸è§çš„é…ç½®
          for config in "k69v1_64_defconfig" "defconfig" "mediatek_defconfig"; do
            echo "å°è¯•é…ç½®: $config"
            if make $config; then
              echo "âœ… ä½¿ç”¨é…ç½®: $config"
              break
            fi
          done
        else
          echo "âœ… é…ç½®ç”ŸæˆæˆåŠŸ"
        fi
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "=== é…ç½®æ‘˜è¦ ==="
        if [ -f ".config" ]; then
          grep -E "CONFIG_ARM64|CONFIG_CPU|CONFIG_MTK|CONFIG_ARCH" .config | head -10
        else
          echo "âŒ æ²¡æœ‰ç”Ÿæˆ .config æ–‡ä»¶"
          exit 1
        fi

    - name: ç¼–è¯‘å†…æ ¸
      id: compile
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== å¼€å§‹ç¼–è¯‘å†…æ ¸ ==="
        
        CORES=$(nproc)
        JOBS=$((CORES + 1))  # ä½¿ç”¨ nproc + 1 æ›´å®‰å…¨
        echo "ä½¿ç”¨ $JOBS ä¸ªå¹¶è¡Œä»»åŠ¡ç¼–è¯‘"
        
        # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
        touch build.log
        touch error_analysis.log
        
        # å¼€å§‹ç¼–è¯‘
        set +e
        {
          time make -j$JOBS ${{ github.event.inputs.build_target }} 2>&1
        } | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        # åˆ†æç¼–è¯‘ç»“æœ
        ERROR_COUNT=$(grep -c "error:" build.log || true)
        WARNING_COUNT=$(grep -c "warning:" build.log || true)
        
        echo "ç¼–è¯‘é€€å‡ºç : $BUILD_EXIT_CODE"
        echo "é”™è¯¯æ•°é‡: $ERROR_COUNT"
        echo "è­¦å‘Šæ•°é‡: $WARNING_COUNT"
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†å†…æ ¸é•œåƒ
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          if ls arch/$ARCH/boot/Image* 1> /dev/null 2>&1; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "âœ… ç¼–è¯‘æˆåŠŸ - å†…æ ¸é•œåƒå·²ç”Ÿæˆ"
          else
            echo "BUILD_STATUS=no_image" >> $GITHUB_ENV
            echo "âš ï¸ ç¼–è¯‘è¿‡ç¨‹æˆåŠŸä½†æœªæ‰¾åˆ°å†…æ ¸é•œåƒ"
          fi
        else
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV
          echo "âŒ ç¼–è¯‘å¤±è´¥"
        fi
        
        # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
        echo "ERROR_COUNT=$ERROR_COUNT" >> $GITHUB_ENV
        echo "WARNING_COUNT=$WARNING_COUNT" >> $GITHUB_ENV
        
        # ç”Ÿæˆé”™è¯¯åˆ†æ
        if [ $ERROR_COUNT -gt 0 ]; then
          echo "=== é”™è¯¯åˆ†æ ===" > error_analysis.log
          grep -A 2 -B 1 "error:" build.log | head -n 50 >> error_analysis.log
          echo "... (æ›´å¤šé”™è¯¯è¯·æŸ¥çœ‹å®Œæ•´æ—¥å¿—)" >> error_analysis.log
        fi

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      if: env.BUILD_STATUS == 'success'
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        find arch/$ARCH/boot/ -type f -exec ls -lh {} \;
        echo "=== æ–‡ä»¶å¤§å° ==="
        du -sh arch/$ARCH/boot/* || echo "æ— æ³•è·å–æ–‡ä»¶å¤§å°"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-images
        path: |
          ${{ env.KERNEL_SOURCE }}/arch/arm64/boot/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—å’Œé…ç½®
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          ${{ env.KERNEL_SOURCE }}/.config
          ${{ env.KERNEL_SOURCE }}/build.log
          ${{ env.KERNEL_SOURCE }}/error_analysis.log
        retention-days: 7

    - name: æ˜¾ç¤ºæ„å»ºæ€»ç»“
      if: always()
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== æ„å»ºæ€»ç»“ ==="
        echo "çŠ¶æ€: $BUILD_STATUS"
        echo "é”™è¯¯: $ERROR_COUNT"
        echo "è­¦å‘Š: $WARNING_COUNT"
        
        if [ "$BUILD_STATUS" = "success" ]; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸ!"
          echo "ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la arch/$ARCH/boot/
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          if [ -f "error_analysis.log" ]; then
            echo "å‰å‡ ä¸ªé”™è¯¯:"
            head -20 error_analysis.log
          fi
        fi