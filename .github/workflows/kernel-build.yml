name: Build Kernel - Ultra Fast

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'ÂÜÖÊ†∏ÈÖçÁΩÆÊñá‰ª∂'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Ê£ÄÂá∫‰ªìÂ∫ì
      uses: actions/checkout@v4

    - name: ÊûÅÈÄüÁºñËØëÂÜÖÊ†∏
      run: |
        echo "=== üöÄ ÊûÅÈÄüÂÜÖÊ†∏ÁºñËØëÂêØÂä® ==="
        
        # ÊÄßËÉΩÈÖçÁΩÆ
        CPU_CORES=$(nproc)
        PARALLEL_JOBS=$((CPU_CORES * 3))
        
        echo "ÈÖçÁΩÆ: $PARALLEL_JOBS Âπ∂Ë°å‰ªªÂä° | $ARCHÊû∂ÊûÑ"
        
        # ÊûÅÁÆÄ‰æùËµñÂÆâË£Ö
        echo "üì¶ ÂÆâË£ÖÊ†∏ÂøÉ‰æùËµñ..."
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          build-essential bc bison flex libssl-dev libelf-dev \
          gcc-aarch64-linux-gnu git python3 libncurses-dev
        
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        
        # ÂàõÂª∫‰∏ìÁî®ÁõÆÂΩïÂπ∂ËøõÂÖ•
        mkdir -p kernel-build
        cd kernel-build
        
        # ÂÖãÈöÜÊ∫êÁ†ÅÂà∞‰∏ìÁî®ÁõÆÂΩï
        echo "üîß Ëé∑ÂèñÂÜÖÊ†∏Ê∫êÁ†Å..."
        git clone --depth=1 --single-branch --branch=mt6768-4.19 \
          https://github.com/WUNELEZI1/Gale-Kernel-Source.git . --quiet
        
        # Âø´ÈÄüÈÖçÁΩÆ
        echo "‚öôÔ∏è ÁîüÊàêÈÖçÁΩÆ..."
        rm -f .config .config.old
        if ! make ${{ github.event.inputs.defconfig }}; then
          echo "‚ö†Ô∏è ‰ΩøÁî®Â§áÁî®ÈÖçÁΩÆ"
          make defconfig
        fi
        
        # ÂÖ≥ÈîÆ‰ºòÂåñÔºöÁ¶ÅÁî®Ë∞ÉËØï‰ø°ÊÅØÔºåÂ§ßÂπÖÂáèÂ∞ëÁºñËØëÈáè
        echo "üîß Â∫îÁî®ÁºñËØë‰ºòÂåñ..."
        if [ -f .config ]; then
          # ‰ΩøÁî®sedÁõ¥Êé•‰øÆÊîπ.configÊñá‰ª∂ÔºåÈÅøÂÖç‰æùËµñscripts/config
          sed -i 's/CONFIG_DEBUG_INFO=y/CONFIG_DEBUG_INFO=n/' .config 2>/dev/null || true
          sed -i 's/CONFIG_DEBUG_KERNEL=y/CONFIG_DEBUG_KERNEL=n/' .config 2>/dev/null || true
          sed -i 's/CONFIG_GDB_SCRIPTS=y/CONFIG_GDB_SCRIPTS=n/' .config 2>/dev/null || true
          echo "‚úÖ Ë∞ÉËØï‰ø°ÊÅØÂ∑≤Á¶ÅÁî®"
        fi
        
        echo "‚ö° ÂºÄÂßãÁºñËØë..."
        START_TIME=$(date +%s)
        
        # ÂàÜÈò∂ÊÆµÁºñËØëÔºå‰ºòÂÖàÁºñËØëÊ†∏ÂøÉÈïúÂÉè
        echo "Èò∂ÊÆµ1: ÁºñËØëÊ†∏ÂøÉÈïúÂÉè (vmlinux)"
        make -j$PARALLEL_JOBS vmlinux
        
        echo "Èò∂ÊÆµ2: ÁºñËØëÂÜÖÊ†∏ÈïúÂÉè (Image)"
        make -j$PARALLEL_JOBS Image
        
        echo "Èò∂ÊÆµ3: ÁºñËØëËÆæÂ§áÊ†ë (dtbs)"
        make -j$PARALLEL_JOBS dtbs 2>/dev/null || echo "‚ö†Ô∏è ËÆæÂ§áÊ†ëÁºñËØëË∑≥Ëøá"
        
        echo "Èò∂ÊÆµ4: ÁºñËØëÊ®°Âùó (modules)"
        make -j$PARALLEL_JOBS modules 2>/dev/null || echo "‚ö†Ô∏è Ê®°ÂùóÁºñËØëË∑≥Ëøá"
        
        END_TIME=$(date +%s)
        COMPILE_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "=== üèÅ ÁºñËØëÂÆåÊàê ==="
        echo "‚è±Ô∏è ÊÄªËÄóÊó∂: ${COMPILE_TIME}Áßí"
        
        # ÁªìÊûúÊ£ÄÊü•
        if ls arch/$ARCH/boot/Image* >/dev/null 2>&1; then
          echo "‚úÖ ÁºñËØëÊàêÂäüÔºÅ"
          echo "ÁîüÊàêÊñá‰ª∂:"
          find arch/$ARCH/boot/ -name "Image*" -type f -exec ls -lh {} \; | awk '{print "  " $9 " (" $5 ")"}'
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
        else
          echo "‚ùå Êú™ÊâæÂà∞ÂÜÖÊ†∏ÈïúÂÉè"
          echo "BUILD_STATUS=no_image" >> $GITHUB_ENV
        fi
        
        echo "COMPILE_TIME=$COMPILE_TIME" >> $GITHUB_ENV

    - name: ‰∏ä‰º†‰∫ßÁâ©
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-ultra-fast
        path: kernel-build/arch/arm64/boot/

    - name: ‰∏ä‰º†ÈÖçÁΩÆ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-config
        path: kernel-build/.config