name: Build MT6768 Kernel (Ubuntu 22.04 Final Attempt)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Ubuntu 22.04 compatible toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python2.7 python2.7-dev \
          gcc-aarch64-linux-gnu gcc-11-aarch64-linux-gnu \
          gcc-10-aarch64-linux-gnu gcc-9-aarch64-linux-gnu \
          libncurses-dev dwarves curl file tree
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2

        # ä¸‹è½½é’ˆå¯¹Ubuntu 22.04çš„å…¼å®¹å·¥å…·é“¾
        wget https://toolchains.bootlin.com/downloads/releases/toolchains/aarch64/tarballs/aarch64--glibc--stable-2022.08-1.tar.bz2
        tar -xf aarch64--glibc--stable-2022.08-1.tar.bz2
        echo "BOOTLIN_TOOLCHAIN=$(pwd)/aarch64--glibc--stable-2022.08-1/bin/aarch64-buildroot-linux-gnu-" >> $GITHUB_ENV

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Pre-create essential build files
      run: |
        cd $KERNEL_DIR
        echo "=== é¢„åˆ›å»ºå¿…è¦çš„æž„å»ºæ–‡ä»¶ ==="
        
        rm -rf out
        mkdir -p out/include/generated out/arch/arm64/include/generated out/scripts
        
        # åˆ›å»º compile.h
        cat > out/include/generated/compile.h << 'EOF'
        #define UTS_MACHINE "aarch64"
        #define UTS_VERSION "#1 SMP PREEMPT $(date +%Y%m%d)"
        #define LINUX_COMPILE_BY "github-actions-22.04"
        #define LINUX_COMPILE_HOST "github-actions"
        #define LINUX_COMPILER "aarch64-linux-gnu-gcc (Ubuntu 11.3.0-1ubuntu1~22.04) 11.3.0"
        #define LINUX_COMPILE_DOMAIN "(none)"
        #define VERMAGIC_STRING "4.19.0-github-actions-22.04 SMP preempt mod_unload aarch64"
        EOF
        
        # åˆ›å»º autoconf.h
        cat > out/include/generated/autoconf.h << 'EOF'
        #define CONFIG_CC_HAS_ASM_INLINE 1
        #define CONFIG_ARM64 1
        #define CONFIG_64BIT 1
        EOF
        
        echo "âœ… é¢„åˆ›å»ºäº†å¿…è¦çš„å¤´æ–‡ä»¶"

    - name: Build with Bootlin toolchain
      run: |
        cd $KERNEL_DIR
        echo "=== ä½¿ç”¨ Bootlin å·¥å…·é“¾æž„å»º ==="
        
        # ä½¿ç”¨ Bootlin å·¥å…·é“¾é…ç½®
        make O=out ARCH=arm64 CROSS_COMPILE=${{ env.BOOTLIN_TOOLCHAIN }} defconfig
        
        # åº”ç”¨æœ€å°åŒ–é…ç½®
        ./scripts/config --file out/.config -d MTK_CM_MGR
        ./scripts/config --file out/.config -d UCLAMP_TASK
        ./scripts/config --file out/.config -d BLK_INLINE_ENCRYPTION
        
        make O=out ARCH=arm64 CROSS_COMPILE=${{ env.BOOTLIN_TOOLCHAIN }} olddefconfig
        
        echo "ä½¿ç”¨ Bootlin å·¥å…·é“¾ç¼–è¯‘..."
        time make O=out ARCH=arm64 -j$(nproc) \
          CROSS_COMPILE=${{ env.BOOTLIN_TOOLCHAIN }} \
          KCFLAGS="-Wno-error -Wno-format -Wno-memset-elt-size" \
          2>&1 | tee build_bootlin.log

    - name: Comprehensive result analysis
      if: always()
      run: |
        cd $KERNEL_DIR
        echo "=== ç»¼åˆæž„å»ºç»“æžœåˆ†æž ==="
        echo "=========================================="
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        echo "## æ ¸å¿ƒæ–‡ä»¶æ£€æŸ¥"
        for file in "out/vmlinux" "out/arch/arm64/boot/Image" "out/arch/arm64/boot/Image.gz"; do
          if [ -f "$file" ]; then
            echo "âœ… $file - å­˜åœ¨ ($(du -h "$file" | cut -f1))"
          else
            echo "âŒ $file - ç¼ºå¤±"
          fi
        done
        
        echo ""
        echo "## æž„å»ºè¿›åº¦ç»Ÿè®¡"
        object_count=$(find out/ -name "*.o" -type f 2>/dev/null | wc -l)
        build_log_lines=$(wc -l < build_bootlin.log 2>/dev/null || echo 0)
        echo "ðŸ“Š ç¼–è¯‘çš„å¯¹è±¡æ–‡ä»¶: $object_count"
        echo "ðŸ“Š æž„å»ºæ—¥å¿—è¡Œæ•°: $build_log_lines"
        
        if [ -f "build_bootlin.log" ]; then
          errors=$(grep -c "error:" build_bootlin.log || echo 0)
          warnings=$(grep -c "warning:" build_bootlin.log || echo 0)
          echo "ðŸ“Š é”™è¯¯æ•°é‡: $errors"
          echo "ðŸ“Š è­¦å‘Šæ•°é‡: $warnings"
          
          echo ""
          echo "## ä¸»è¦é”™è¯¯ç±»åž‹"
          grep "error:" build_bootlin.log | sort | uniq -c | sort -nr | head -10 || echo "æ— é”™è¯¯ç»Ÿè®¡"
        fi
        
        echo ""
        echo "## å·¥å…·é“¾ä¿¡æ¯"
        echo "ä¸»å·¥å…·é“¾: aarch64-linux-gnu-gcc"
        aarch64-linux-gnu-gcc --version | head -1 || echo "æ— æ³•èŽ·å–ç‰ˆæœ¬"
        echo "Bootlinå·¥å…·é“¾: ${{ env.BOOTLIN_TOOLCHAIN }}"
        ${{ env.BOOTLIN_TOOLCHAIN }}gcc --version | head -1 || echo "æ— æ³•èŽ·å–Bootlinç‰ˆæœ¬"

    - name: Generate detailed summary report
      if: always()
      run: |
        cd $KERNEL_DIR
        echo "=== è¯¦ç»†æž„å»ºæ€»ç»“æŠ¥å‘Š ==="
        echo "=========================================="
        echo ""
        
        # æž„å»ºçŠ¶æ€
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ðŸŽ‰ ðŸŽ‰ ðŸŽ‰ æž„å»ºçŠ¶æ€: æˆåŠŸ"
          echo "âœ… æˆåŠŸç”Ÿæˆäº†å¯ç”¨çš„å†…æ ¸é•œåƒ"
          echo "ðŸ“ æ–‡ä»¶ä½ç½®: out/arch/arm64/boot/Image.gz"
          echo "ðŸ’¾ æ–‡ä»¶å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
        else
          echo "âŒ æž„å»ºçŠ¶æ€: å¤±è´¥"
          echo ""
          echo "## é—®é¢˜æ·±åº¦åˆ†æž"
          echo ""
          
          # æ£€æŸ¥å…·ä½“é”™è¯¯
          if [ -f "build_bootlin.log" ]; then
            if grep -q "Unterminated quoted string" build_bootlin.log; then
              echo "ðŸ” ä¸»è¦é—®é¢˜: Shellè„šæœ¬è¯­æ³•é”™è¯¯"
              echo "   å¯èƒ½åŽŸå› : çŽ¯å¢ƒå˜é‡æ±¡æŸ“æˆ–è„šæœ¬æ ¼å¼é—®é¢˜"
              echo "   å»ºè®®: æ£€æŸ¥å†…æ ¸æºç ä¸­çš„shellè„šæœ¬ï¼Œç‰¹åˆ«æ˜¯mkcompile_h"
            fi
            
            if grep -q "function body not available" build_bootlin.log; then
              echo "ðŸ” ä¸»è¦é—®é¢˜: å†…è”å‡½æ•°ä½“ç¼ºå¤±"
              echo "   å¯èƒ½åŽŸå› : é…ç½®é€‰é¡¹æœªæ­£ç¡®å¯ç”¨æˆ–æºç ç¼ºé™·"
              echo "   å»ºè®®: æ£€æŸ¥BLK_INLINE_ENCRYPTIONç›¸å…³é…ç½®"
            fi
            
            if grep -q "memset-elt-size" build_bootlin.log; then
              echo "ðŸ” ä¸»è¦é—®é¢˜: memsetä½¿ç”¨é”™è¯¯"
              echo "   å¯èƒ½åŽŸå› : ä»£ç è§„èŒƒé—®é¢˜æˆ–ç¼–è¯‘å™¨ç‰ˆæœ¬ä¸å…¼å®¹"
              echo "   å»ºè®®: ä¿®å¤mediateké©±åŠ¨ä¸­çš„memsetè°ƒç”¨"
            fi
            
            if grep -q "format expects" build_bootlin.log; then
              echo "ðŸ” ä¸»è¦é—®é¢˜: æ ¼å¼å­—ç¬¦ä¸²é”™è¯¯"
              echo "   å¯èƒ½åŽŸå› : å‚æ•°ç±»åž‹ä¸åŒ¹é…"
              echo "   å»ºè®®: æ£€æŸ¥printkå’Œç›¸å…³æ—¥å¿—è°ƒç”¨"
            fi
          fi
          
          echo ""
          echo "## æ ¹æœ¬åŽŸå› æ€»ç»“"
          echo "åŸºäºŽå¤šæ¬¡æž„å»ºå°è¯•çš„åˆ†æžï¼Œä¸»è¦é—®é¢˜å¯èƒ½åŒ…æ‹¬:"
          echo "1. ðŸ”§ å†…æ ¸æºç ä¸ŽUbuntu 22.04å·¥å…·é“¾çš„å…¼å®¹æ€§é—®é¢˜"
          echo "2. ðŸ“ æºç ä¸­çš„shellè„šæœ¬è¯­æ³•é”™è¯¯" 
          echo "3. âš™ï¸ ç‰¹å®šMTKé©±åŠ¨ä¸Žä¸»çº¿å†…æ ¸çš„é›†æˆé—®é¢˜"
          echo "4. ðŸ› ï¸ ç¼–è¯‘çŽ¯å¢ƒä¸Žå†…æ ¸æž„å»ºç³»ç»Ÿçš„ä¸åŒ¹é…"
          
          echo ""
          echo "## åŽç»­è¡ŒåŠ¨å»ºè®®"
          echo ""
          echo "### çŸ­æœŸè§£å†³æ–¹æ¡ˆ:"
          echo "1. ðŸ“¥ ä½¿ç”¨è®¾å¤‡åŽ‚å•†æä¾›çš„é¢„ç¼–è¯‘å†…æ ¸"
          echo "2. ðŸ”„ å¯»æ‰¾å·²çŸ¥å¯æž„å»ºçš„å†…æ ¸æºç åˆ†æ”¯"
          echo "3. ðŸ  åœ¨Ubuntu 18.04/20.04çŽ¯å¢ƒä¸­æ‰‹åŠ¨æž„å»º"
          
          echo ""
          echo "### é•¿æœŸè§£å†³æ–¹æ¡ˆ:"
          echo "1. ðŸ“‹ å‘å†…æ ¸ç»´æŠ¤è€…æŠ¥å‘Šæž„å»ºé—®é¢˜"
          echo "2. ðŸ” é€æ–‡ä»¶ä¿®å¤ç¼–è¯‘é”™è¯¯"
          echo "3. ðŸ“š ä½¿ç”¨æ›´æ–°çš„å†…æ ¸ç‰ˆæœ¬ï¼ˆå¦‚4.19.yç¨³å®šç‰ˆï¼‰"
          
          echo ""
          echo "### æŠ€æœ¯æ·±åº¦ä¿®å¤:"
          echo "1. ðŸ”§ æ‰‹åŠ¨ä¿®å¤shellè„šæœ¬ä¸­çš„å¼•å·é—®é¢˜"
          echo "2. âš™ï¸ ä¸ºç¼ºå¤±çš„å‡½æ•°æä¾›æ¡©å®žçŽ°"
          echo "3. ðŸ› ï¸ è°ƒæ•´å†…æ ¸é…ç½®ä»¥ç¦ç”¨é—®é¢˜é©±åŠ¨"
          
          echo ""
          echo "## èµ„æºå‚è€ƒ"
          echo "- ðŸ“– å†…æ ¸ç¼–è¯‘æ–‡æ¡£: https://www.kernel.org/doc/html/latest/"
          echo "- ðŸ› é—®é¢˜è¿½è¸ª: https://bugzilla.kernel.org/"
          echo "- ðŸ’¬ ç¤¾åŒºæ”¯æŒ: Linuxå†…æ ¸é‚®ä»¶åˆ—è¡¨å’Œè®ºå›"
        fi
        
        echo ""
        echo "=========================================="
        echo "æž„å»ºå°è¯•å®Œæˆæ—¶é—´: $(date)"
        echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}"
        echo "å·¥ä½œæµè¿è¡Œåºå·: ${{ github.run_number }}"

    - name: Upload final artifacts and report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-ubuntu-22.04-final-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/
          ${{ env.KERNEL_DIR }}/build_*.log
        retention-days: 30

    - name: Create build summary file
      if: always()
      run: |
        cd $KERNEL_DIR
        # åˆ›å»ºè¯¦ç»†çš„æž„å»ºæ€»ç»“æ–‡ä»¶
        {
          echo "# å†…æ ¸æž„å»ºæ€»ç»“æŠ¥å‘Š"
          echo "æž„å»ºæ—¶é—´: $(date)"
          echo "å·¥ä½œæµ: ${{ github.workflow }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "è¿è¡Œåºå·: ${{ github.run_number }}"
          echo "ä»“åº“: ${{ github.repository }}"
          echo ""
          echo "## æž„å»ºçŽ¯å¢ƒ"
          echo "- ç³»ç»Ÿ: Ubuntu 22.04"
          echo "- å†…æ ¸æºç : mt6768-4.19 åˆ†æ”¯"
          echo "- æž¶æž„: arm64"
          echo ""
          echo "## å·¥å…·é“¾ä¿¡æ¯"
          echo "- é»˜è®¤GCC: $(aarch64-linux-gnu-gcc --version | head -1)"
          echo "- Bootlinå·¥å…·é“¾: ${{ env.BOOTLIN_TOOLCHAIN }}"
          echo ""
          echo "## æž„å»ºç»“æžœ"
          if [ -f "out/arch/arm64/boot/Image.gz" ]; then
            echo "çŠ¶æ€: âœ… æˆåŠŸ"
            echo "å†…æ ¸é•œåƒ: out/arch/arm64/boot/Image.gz"
            echo "å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
          else
            echo "çŠ¶æ€: âŒ å¤±è´¥"
            echo "é”™è¯¯æ‘˜è¦:"
            if [ -f "build_bootlin.log" ]; then
              grep "error:" build_bootlin.log | head -5 | while read line; do
                echo "- $line"
              done
            fi
          fi
          echo ""
          echo "## å»ºè®®"
          echo "å¦‚éœ€è¿›ä¸€æ­¥å¸®åŠ©ï¼Œè¯·æä¾›:"
          echo "1. å®Œæ•´çš„æž„å»ºæ—¥å¿—"
          echo "2. å†…æ ¸æºç çš„å…·ä½“æäº¤å“ˆå¸Œ"
          echo "3. ç›®æ ‡è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯"
        } > build_summary.md
        
        # ä¸Šä¼ æ€»ç»“æ–‡ä»¶
        echo "BUILD_SUMMARY_FILE=$KERNEL_DIR/build_summary.md" >> $GITHUB_ENV

    - name: Upload build summary
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-summary-${{ github.run_number }}
        path: ${{ env.BUILD_SUMMARY_FILE }}
        retention-days: 30