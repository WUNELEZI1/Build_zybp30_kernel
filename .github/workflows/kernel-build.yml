name: Build MT6768 Kernel (Self-Maintained)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree patch
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Apply comprehensive fixes
      run: |
        cd $KERNEL_DIR
        echo "=== åº”ç”¨å…¨é¢ä¿®å¤ ==="
        
        # 1. ä¿®å¤ try_to_unmap å‚æ•°é—®é¢˜
        if [ -f "mm/huge_memory.c" ]; then
          echo "ä¿®å¤ try_to_unmap è°ƒç”¨..."
          sed -i 's/try_to_unmap(page, ttu_flags, NULL, NULL);/try_to_unmap(page, ttu_flags);/g' mm/huge_memory.c
        fi

        # 2. ä¿®å¤ blocktag æ ¼å¼å­—ç¬¦ä¸²
        if [ -f "drivers/misc/mediatek/blocktag/blocktag-core.c" ]; then
          echo "ä¿®å¤ blocktag æ ¼å¼å­—ç¬¦ä¸²..."
          sed -i 's/"%s aee buffer: %d bytes\\n"/"%s aee buffer: %zu bytes\\n"/g' drivers/misc/mediatek/blocktag/blocktag-core.c
        fi

        # 3. ä¿®å¤ get_boot_mode ç±»å‹å†²çª
        if [ -f "drivers/input/keyboard/mediatek/mt6768/hal_kpd.c" ]; then
          echo "ä¿®å¤ get_boot_mode ç±»å‹å†²çª..."
          sed -i 's/unsigned int get_boot_mode(void)/enum boot_mode_t get_boot_mode(void)/g' drivers/input/keyboard/mediatek/mt6768/hal_kpd.c
        fi

        # 4. ä¿®å¤ keyslot-manager å†…è”å‡½æ•°é—®é¢˜
        if [ -f "include/linux/keyslot-manager.h" ]; then
          echo "ä¿®å¤ keyslot-manager.h å†…è”å‡½æ•°..."
          sed -i 's/always_inline //g' include/linux/keyslot-manager.h
        fi

        # 5. ä¿®å¤ blk-crypto å†…è”å‡½æ•°é—®é¢˜
        if [ -f "include/linux/blk-crypto.h" ]; then
          echo "ä¿®å¤ blk-crypto.h å†…è”å‡½æ•°..."
          sed -i 's/always_inline //g' include/linux/blk-crypto.h
        fi

        echo "æ‰€æœ‰ä¿®å¤å·²å®Œæˆ"

    - name: Configure kernel to disable problematic features
      run: |
        cd $KERNEL_DIR
        echo "=== é…ç½®å†…æ ¸ï¼šç¦ç”¨é—®é¢˜åŠŸèƒ½ ==="
        
        rm -rf out
        mkdir -p out
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }}
        
        ./scripts/config --file out/.config \
          --disable DEBUG_INFO \
          --disable GDB_SCRIPTS \
          --disable DEBUG_KERNEL \
          --disable SCHED_TUNE \
          --disable MTK_CM_MGR \
          --disable TRANSPARENT_HUGEPAGE \
          --disable BLK_DEV_CRYPTO \
          --disable DM_CRYPT \
          --disable CRYPTO_BLKCIPHER \
          --disable BLK_INLINE_ENCRYPTION \
          --disable BLK_CRYPTO
        
        ./scripts/config --file out/.config \
          --enable MODULES \
          --enable MODULE_UNLOAD \
          --enable MODULE_FORCE_UNLOAD \
          --enable BLOCK \
          --enable ARM64 \
          --enable MMU \
          --enable SMP \
          --enable ARCH_MT6797 \
          --enable MACH_MT6768
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

    - name: Build kernel with aggressive error suppression
      run: |
        cd $KERNEL_DIR
        echo "=== ä½¿ç”¨æ¿€è¿›é”™è¯¯æŠ‘åˆ¶ç¼–è¯‘å†…æ ¸ ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        time make O=out ARCH=arm64 -j$(($(nproc) + 1)) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          KCFLAGS="-Wno-error -Wno-format -Wno-enum-int-mismatch -Wno-incompatible-pointer-types -Wno-uninitialized -Wno-misleading-indentation -Wno-address-of-packed-member -Wno-pointer-sign -Wno-format-overflow -Wno-stringop-overflow -Wno-restrict -Wno-array-bounds -Wno-maybe-uninitialized -Wno-implicit-fallthrough -Wno-packed-not-aligned -Wno-attributes -Wno-unused-but-set-variable -Wno-unused-variable -Wno-unused-function -Wno-sign-compare -Wno-shift-negative-value -Wno-int-to-pointer-cast -Wno-pointer-to-int-cast -Wno-absolute-value -Wno-builtin-declaration-mismatch -Wno-discarded-qualifiers -Wno-incompatible-pointer-types-discards-qualifiers" \
          KCPPFLAGS="-Wno-error" \
          2>&1 | tee full_build.log || echo "ç¼–è¯‘è¿‡ç¨‹å®Œæˆï¼Œæ£€æŸ¥ç»“æœ..."

    - name: Check build results
      run: |
        cd $KERNEL_DIR
        echo "=== æ£€æŸ¥æ„å»ºç»“æœ ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "âœ… å†…æ ¸é•œåƒç”ŸæˆæˆåŠŸ!"
          echo "KERNEL_BUILD_SUCCESS=true" >> $GITHUB_ENV
        elif [ -f "out/arch/arm64/boot/Image" ]; then
          echo "âœ… å†…æ ¸é•œåƒç”ŸæˆæˆåŠŸ (æœªå‹ç¼©)"
          echo "KERNEL_BUILD_SUCCESS=true" >> $GITHUB_ENV
        elif [ -f "out/vmlinux" ]; then
          echo "âš ï¸  ç”Ÿæˆ vmlinux ä½†æœªæ‰“åŒ…"
          echo "KERNEL_BUILD_SUCCESS=partial" >> $GITHUB_ENV
        else
          echo "âŒ æœªç”Ÿæˆå†…æ ¸é•œåƒ"
          echo "KERNEL_BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: Create final build report
      if: always()
      run: |
        cd $KERNEL_DIR
        echo "=== æœ€ç»ˆæ„å»ºæŠ¥å‘Š ==="
        
        if [ "$KERNEL_BUILD_SUCCESS" = "true" ]; then
          echo "ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸ!"
        elif [ "$KERNEL_BUILD_SUCCESS" = "partial" ]; then
          echo "âš ï¸  éƒ¨åˆ†æˆåŠŸ - ç”Ÿæˆ vmlinux"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
        fi

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/out/vmlinux
          ${{ env.KERNEL_DIR }}/*.log
        retention-days: 30