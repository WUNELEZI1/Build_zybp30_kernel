name: Build MT6768 Kernel (Fix Format and Memset Errors)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python2.7 python2.7-dev \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix compilation errors
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤ç¼–è¯‘é”™è¯¯ ==="
        
        # æ¸…ç†
        rm -rf out
        mkdir -p out
        
        # ä½¿ç”¨ç³»ç»Ÿ GCC è¿›è¡Œé…ç½®
        echo "é…ç½®å†…æ ¸..."
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }} && {
          echo "âœ… é…ç½®æˆåŠŸ"
        } || {
          echo "âŒ ç‰¹å®šé…ç½®å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€é…ç½®"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        }
        
        # ä¿®å¤é…ç½®é—®é¢˜
        echo "åº”ç”¨ä¿®å¤..."
        
        # ç¦ç”¨å¯èƒ½å¯¼è‡´æ ¼å¼é”™è¯¯çš„é©±åŠ¨
        ./scripts/config --file out/.config -d MTK_CM_MGR
        ./scripts/config --file out/.config -d MTK_CM_MGR_V1
        ./scripts/config --file out/.config -d MTK_CM_MGR_V2
        
        # ç¦ç”¨å—è®¾å¤‡åŠ å¯†ç›¸å…³åŠŸèƒ½
        ./scripts/config --file out/.config -d BLK_INLINE_ENCRYPTION
        ./scripts/config --file out/.config -d BLK_DEV_INLINE_CRYPTO
        ./scripts/config --file out/.config -d BLK_CRYPTO
        
        # ç¦ç”¨ UCLAMP åŠŸèƒ½
        ./scripts/config --file out/.config -d UCLAMP_TASK
        ./scripts/config --file out/.config -d SCHED_TUNE
        
        # ç¦ç”¨å…¶ä»–å¯èƒ½æœ‰é—®é¢˜çš„é…ç½®
        ./scripts/config --file out/.config -d CHARGER_BQ25890
        ./scripts/config --file out/.config -d MTK_CMDQ
        ./scripts/config --file out/.config -d MTK_QOS_FRAMEWORK
        ./scripts/config --file out/.config -d TOUCHSCREEN_GOODIX_BRL
        ./scripts/config --file out/.config -d ACCDET_MT6358
        ./scripts/config --file out/.config -d MTK_SENSORS_1_0
        ./scripts/config --file out/.config -d INPUT_FINGERPRINT
        ./scripts/config --file out/.config -d MEDIATEX_EXTCON
        
        # æ›´æ–°é…ç½®
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        
        echo "ä¿®å¤åçš„é…ç½®æ‘˜è¦:"
        grep -E "MTK_CM_MGR|BLK_INLINE|UCLAMP" out/.config || echo "ç›¸å…³é…ç½®å·²ç¦ç”¨"

    - name: Patch source code for format and memset errors
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤æ ¼å¼å­—ç¬¦ä¸²å’Œmemseté”™è¯¯ ==="
        
        # ä¿®å¤ mediatek cm_mgr é©±åŠ¨ä¸­çš„ memset é”™è¯¯
        cat > fix_cm_mgr_memset.patch << 'EOF'
        --- a/drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.c
        +++ b/drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.c
        @@ -505,7 +505,7 @@ static void cm_mgr_ini_regulator_data(void)
         	int i;
         
         	for (i = 0; i < CM_MGR_EMI_OPP; i++) {
        -		memset(voltage_opp[i], 0,
        +		memset(voltage_opp[i], 0, sizeof(voltage_opp[i]));
         				CM_MGR_EMI_OPP * sizeof(voltage_opp[0][0]));
         		vcore_opp_uv[i] = 0;
         	}
        @@ -520,7 +520,7 @@ static void cm_mgr_ini_regulator_data(void)
         	int i;
         
         	for (i = 0; i < CM_MGR_EMI_OPP; i++) {
        -		memset(voltage_opp[i], 0,
        +		memset(voltage_opp[i], 0, sizeof(voltage_opp[i]));
         				CM_MGR_EMI_OPP * sizeof(voltage_opp[0][0]));
         		vcore_opp_uv[i] = 0;
         	}
        EOF
        
        # ä¿®å¤æ ¼å¼å­—ç¬¦ä¸²é”™è¯¯
        cat > fix_format_errors.patch << 'EOF'
        --- a/include/linux/kern_levels.h
        +++ b/include/linux/kern_levels.h
        @@ -2,7 +2,7 @@
         #ifndef _LINUX_KERN_LEVELS_H
         #define _LINUX_KERN_LEVELS_H
         
        -#define KERN_SOH	"\\001"		/* ASCII Start Of Header */
        +#define KERN_SOH	"\\001"		/* ASCII Start Of Header */
         #define KERN_SOH_ASCII	'\\001'
         
         #define KERN_EMERG	KERN_SOH "0"	/* system is unusable */
        EOF
        
        # åº”ç”¨è¡¥ä¸
        for patch_file in fix_cm_mgr_memset.patch fix_format_errors.patch; do
          if [ -f "$patch_file" ]; then
            if patch -p1 -N --dry-run < "$patch_file" 2>/dev/null; then
              patch -p1 < "$patch_file"
              echo "âœ… $patch_file åº”ç”¨æˆåŠŸ"
            else
              echo "âš ï¸ $patch_file å¯èƒ½å·²åº”ç”¨æˆ–ä¸éœ€è¦"
            fi
          fi
        done

    - name: Disable specific warnings as errors
      run: |
        cd $KERNEL_DIR
        echo "=== ç¦ç”¨ç‰¹å®šè­¦å‘Šä½œä¸ºé”™è¯¯ ==="
        
        # åˆ›å»ºç¼–è¯‘æ ‡å¿—è¡¥ä¸ï¼Œç¦ç”¨ç‰¹å®šè­¦å‘Š
        cat > disable_warnings.patch << 'EOF'
        --- a/Makefile
        +++ b/Makefile
        @@ -756,7 +756,7 @@ KBUILD_CFLAGS	+= $(call cc-option,-fdata-sections,)
         endif
        
         # This warning generated too much noise in a regular build.
        -KBUILD_CFLAGS += $(call cc-disable-warning, unused-but-set-variable)
        +KBUILD_CFLAGS += $(call cc-disable-warning, unused-but-set-variable) -Wno-format -Wno-memset-elt-size
        
         ifdef CONFIG_FRAME_POINTER
         KBUILD_CFLAGS	+= -fno-omit-frame-pointer -fno-optimize-sibling-calls
        EOF
        
        if patch -p1 -N --dry-run < disable_warnings.patch 2>/dev/null; then
          patch -p1 < disable_warnings.patch
          echo "âœ… ç¦ç”¨è­¦å‘Šè¡¥ä¸åº”ç”¨æˆåŠŸ"
        else
          echo "âš ï¸ ç¦ç”¨è­¦å‘Šè¡¥ä¸å¯èƒ½å·²åº”ç”¨æˆ–ä¸éœ€è¦"
        fi

    - name: Build with comprehensive fixes
      run: |
        cd $KERNEL_DIR
        
        if [ ! -f "out/.config" ]; then
          echo "âŒ æ²¡æœ‰é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        echo "=== ä½¿ç”¨ç»¼åˆä¿®å¤ç¼–è¯‘ ==="
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # ç¦ç”¨å°†è­¦å‘Šè§†ä¸ºé”™è¯¯
        export KCFLAGS="-Wno-error=format -Wno-error=memset-elt-size -Wno-format -Wno-memset-elt-size"
        
        echo "å¼€å§‹ç¼–è¯‘..."
        time make O=out ARCH=arm64 -j$(nproc) \
          CROSS_COMPILE="$CROSS_COMPILE" \
          KCFLAGS="$KCFLAGS" \
          2>&1 | tee build.log

    - name: Check compilation results
      run: |
        cd $KERNEL_DIR
        echo "=== ç¼–è¯‘ç»“æœæ£€æŸ¥ ==="
        
        # æ£€æŸ¥ç¼–è¯‘æ—¥å¿—
        if [ -f "build.log" ]; then
          echo "æ„å»ºæ—¥å¿—: $(wc -l < build.log) è¡Œ"
          
          # ç»Ÿè®¡ä¸åŒç±»å‹çš„é”™è¯¯
          errors=$(grep -c "error:" build.log || echo 0)
          warnings=$(grep -c "warning:" build.log || echo 0)
          echo "é”™è¯¯: $errors"
          echo "è­¦å‘Š: $warnings"
          
          # æ£€æŸ¥ç‰¹å®šé”™è¯¯ç±»å‹
          if grep -q "format" build.log && grep -q "error" build.log; then
            echo "âŒ æ ¼å¼é”™è¯¯ä»ç„¶å­˜åœ¨:"
            grep -A 3 -B 3 "format.*error" build.log | head -10
          fi
          
          if grep -q "memset" build.log && grep -q "error" build.log; then
            echo "âŒ memseté”™è¯¯ä»ç„¶å­˜åœ¨:"
            grep -A 3 -B 3 "memset.*error" build.log | head -10
          fi
          
          if [ $errors -eq 0 ]; then
            echo "âœ… æ— ç¼–è¯‘é”™è¯¯"
          fi
        fi
        
        # è¯¦ç»†æ£€æŸ¥è¾“å‡º
        echo "=== å†…æ ¸æ–‡ä»¶æ£€æŸ¥ ==="
        
        # æ£€æŸ¥ vmlinux
        if [ -f "out/vmlinux" ]; then
          echo "ğŸ‰ âœ… vmlinux å·²ç”Ÿæˆ!"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file out/vmlinux
          echo "å¤§å°: $(du -h out/vmlinux | cut -f1)"
        else
          echo "âŒ vmlinux æœªç”Ÿæˆ"
          # æ£€æŸ¥ç¼–è¯‘è¿›åº¦
          echo "ç¼–è¯‘è¿›åº¦æ£€æŸ¥:"
          find out/ -name "*.o" | wc -l | xargs echo "å·²ç¼–è¯‘å¯¹è±¡æ–‡ä»¶:"
        fi
        
        # æ£€æŸ¥ Image.gz
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ âœ… Image.gz å·²ç”Ÿæˆ!"
          echo "å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
        else
          echo "âŒ Image.gz æœªç”Ÿæˆ"
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªå‹ç¼©çš„ Image
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "âš ï¸ æ‰¾åˆ°æœªå‹ç¼©çš„ Imageï¼Œæ‰‹åŠ¨å‹ç¼©..."
            gzip -k out/arch/arm64/boot/Image
            echo "âœ… æ‰‹åŠ¨ç”Ÿæˆ Image.gz æˆåŠŸ"
          fi
        fi
        
        # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
        echo "=== æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ ==="
        find out/ -type f \( -name "vmlinux*" -o -name "Image*" -o -name "*.gz" -o -name "*.img" \) 2>/dev/null | head -10 | while read f; do
          echo "ğŸ“„ $f ($(du -h "$f" 2>/dev/null | cut -f1))"
        done

    - name: Last resort minimal build
      if: failure()
      run: |
        cd $KERNEL_DIR
        echo "=== æœ€åæ‰‹æ®µï¼šæœ€å°åŒ–æ„å»º ==="
        
        # å®Œå…¨æ¸…ç†
        rm -rf out
        mkdir -p out
        
        echo "ä½¿ç”¨ç»å¯¹æœ€å°é…ç½®æ„å»º..."
        # ä½¿ç”¨ tinyconfig ä½œä¸ºåŸºç¡€
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- tinyconfig
        
        # åªå¯ç”¨ç»å¯¹å¿…è¦çš„é…ç½®
        ./scripts/config --file out/.config -e ARM64
        ./scripts/config --file out/.config -e MMU
        ./scripts/config --file out/.config -e SERIAL_OF_PLATFORM
        ./scripts/config --file out/.config -e SERIAL_AMBA_PL010
        ./scripts/config --file out/.config -e SERIAL_AMBA_PL010_CONSOLE
        ./scripts/config --file out/.config -e PRINTK
        ./scripts/config --file out/.config -e TTY
        ./scripts/config --file out/.config -e HAS_IOMEM
        
        # ç¦ç”¨æ‰€æœ‰å¯èƒ½çš„é—®é¢˜é…ç½®
        for config in BLK_INLINE_ENCRYPTION UCLAMP_TASK SCHED_TUNE MTK_CM_MGR; do
          ./scripts/config --file out/.config -d $config 2>/dev/null || true
        done
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        
        echo "ä½¿ç”¨æœ€å°é…ç½®ç¼–è¯‘..."
        export KCFLAGS="-Wno-error -Wno-format -Wno-memset-elt-size"
        time make O=out ARCH=arm64 -j$(nproc) CROSS_COMPILE=aarch64-linux-gnu- KCFLAGS="$KCFLAGS"

    - name: Upload successful kernel
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-fixed-format-errors-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/out/vmlinux
        retention-days: 30

    - name: Upload build logs and patches
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-details-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/build.log
          ${{ env.KERNEL_DIR }}/out/.config
          ${{ env.KERNEL_DIR }}/fix_*.patch
          ${{ env.KERNEL_DIR }}/disable_warnings.patch
        retention-days: 15

    - name: Final summary
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºæ€»ç»“ ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ ğŸ‰ ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸï¼"
          echo "å¯ç”¨çš„å†…æ ¸é•œåƒ:"
          ls -lh out/arch/arm64/boot/Image.gz
          echo ""
          echo "ä¸‹ä¸€æ­¥:"
          echo "1. ä¸‹è½½ Artifacts ä¸­çš„ kernel-fixed-format-errors-*"
          echo "2. ä½¿ç”¨ Image.gz åˆ·å…¥è®¾å¤‡"
          echo "3. æµ‹è¯•å†…æ ¸åŠŸèƒ½"
        elif [ -f "out/vmlinux" ]; then
          echo "âš ï¸ ç”Ÿæˆäº† vmlinux ä½†æœªå‹ç¼©"
          echo "å¯ä»¥æ‰‹åŠ¨å‹ç¼©: gzip -c out/vmlinux > Image.gz"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "é—®é¢˜åˆ†æ:"
          if grep -q "format" build.log; then
            echo "- å­˜åœ¨æ ¼å¼å­—ç¬¦ä¸²é”™è¯¯"
          fi
          if grep -q "memset" build.log; then
            echo "- å­˜åœ¨memsetä½¿ç”¨é”™è¯¯"
          fi
          echo "è¯·æ£€æŸ¥ build-details-* ä¸­çš„è¯¦ç»†æ—¥å¿—å’Œè¡¥ä¸æ–‡ä»¶"
          echo "å¯èƒ½éœ€è¦æ›´æ·±å…¥çš„å†…æ ¸æºç ä¿®å¤"
        fi