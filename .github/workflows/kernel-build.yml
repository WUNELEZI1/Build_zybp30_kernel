name: Build MT6768 Kernel (Self-Maintained)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree patch
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix specific compilation errors
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤å…·ä½“ç¼–è¯‘é”™è¯¯ ==="
        
        # 1. ä¿®å¤ try_to_unmap å‚æ•°é—®é¢˜
        if [ -f "mm/huge_memory.c" ]; then
          echo "ä¿®å¤ mm/huge_memory.c ä¸­çš„ try_to_unmap è°ƒç”¨..."
          sed -i 's/try_to_unmap(page, ttu_flags, NULL, NULL);/try_to_unmap(page, ttu_flags);/g' mm/huge_memory.c
          echo "ä¿®å¤åçš„ä»£ç :"
          grep -A2 -B2 "try_to_unmap(page, ttu_flags)" mm/huge_memory.c || true
        fi

        # 2. ä¿®å¤ blocktag-core.c æ ¼å¼å­—ç¬¦ä¸²é”™è¯¯
        if [ -f "drivers/misc/mediatek/blocktag/blocktag-core.c" ]; then
          echo "ä¿®å¤ blocktag-core.c æ ¼å¼å­—ç¬¦ä¸²..."
          sed -i 's/"%s aee buffer: %d bytes\\n"/"%s aee buffer: %zu bytes\\n"/g' drivers/misc/mediatek/blocktag/blocktag-core.c
          # ä¿®å¤å…¶ä»–å¯èƒ½çš„æ ¼å¼å­—ç¬¦ä¸²é—®é¢˜
          sed -i 's/"%d bytes"/"%zu bytes"/g' drivers/misc/mediatek/blocktag/blocktag-core.c
        fi

        # 3. ä¿®å¤ uclamp_se_set å†…è”é”™è¯¯
        if [ -f "kernel/sched/tune.c" ]; then
          echo "ä¿®å¤ sched/tune.c ä¸­çš„ uclamp_se_set é—®é¢˜..."
          # ä¸´æ—¶ç¦ç”¨ SCHED_TUNE æ¥é¿å…è¿™ä¸ªé”™è¯¯
          echo "ä¸´æ—¶ç¦ç”¨ SCHED_TUNE é…ç½®"
        fi

        # 4. ä¿®å¤ get_boot_mode ç±»å‹å†²çª
        if [ -f "drivers/input/keyboard/mediatek/mt6768/hal_kpd.c" ]; then
          echo "ä¿®å¤ hal_kpd.c ä¸­çš„ get_boot_mode ç±»å‹å†²çª..."
          # å°†å‡½æ•°è¿”å›ç±»å‹æ”¹ä¸ºä¸å£°æ˜ä¸€è‡´
          sed -i 's/unsigned int get_boot_mode(void)/enum boot_mode_t get_boot_mode(void)/g' drivers/input/keyboard/mediatek/mt6768/hal_kpd.c
        fi

        # 5. ä¿®å¤ mt_cpufreq_get_cur_phy_freq_no_lock ç±»å‹å†²çª
        if [ -f "drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.h" ]; then
          echo "ä¿®å¤ mtk_cm_mgr.h ä¸­çš„å‡½æ•°å£°æ˜å†²çª..."
          # ä¿®æ”¹å‡½æ•°å£°æ˜ä»¥åŒ¹é…å¤´æ–‡ä»¶
          sed -i 's/extern unsigned int mt_cpufreq_get_cur_phy_freq_no_lock(enum mt_cpu_dvfs_id id);/extern unsigned int mt_cpufreq_get_cur_phy_freq_no_lock(unsigned int cluster_id);/g' drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.h
        fi

        echo "æ‰€æœ‰ä¿®å¤å·²å®Œæˆ"

    - name: Configure kernel with fixes
      run: |
        cd $KERNEL_DIR
        echo "=== é…ç½®å†…æ ¸ï¼ˆåº”ç”¨ä¿®å¤ï¼‰ ==="
        
        rm -rf out
        mkdir -p out
        
        # ä½¿ç”¨æŒ‡å®šçš„ defconfig
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }}
        
        # ç¦ç”¨æœ‰é—®é¢˜çš„é…ç½®
        ./scripts/config --file out/.config \
          --disable DEBUG_INFO \
          --disable GDB_SCRIPTS \
          --disable DEBUG_KERNEL \
          --disable SCHED_TUNE \
          --disable MTK_CM_MGR
        
        # å¯ç”¨å¿…è¦é€‰é¡¹å¹¶è°ƒæ•´ç¼–è¯‘é€‰é¡¹
        ./scripts/config --file out/.config \
          --enable MODULES \
          --set-str CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE "-O2 -Wno-error -Wno-format -Wno-enum-int-mismatch"
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

    - name: Quick test compilation of problematic files
      run: |
        cd $KERNEL_DIR
        echo "=== å¿«é€Ÿæµ‹è¯•æœ‰é—®é¢˜çš„æ–‡ä»¶ç¼–è¯‘ ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # æµ‹è¯•ç¼–è¯‘ä¹‹å‰å‡ºé”™çš„å•ä¸ªæ–‡ä»¶
        echo "1. æµ‹è¯•ç¼–è¯‘ mm/huge_memory.c..."
        if make O=out ARCH=arm64 -j1 mm/huge_memory.o 2>&1 | tee test_mm.log; then
          echo "âœ… mm/huge_memory.c ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ mm/huge_memory.c ç¼–è¯‘å¤±è´¥"
          grep -i "error" test_mm.log | head -5
          exit 1
        fi
        
        echo "2. æµ‹è¯•ç¼–è¯‘ kernel/sched/tune.c..."
        if make O=out ARCH=arm64 -j1 kernel/sched/tune.o 2>&1 | tee test_sched.log; then
          echo "âœ… kernel/sched/tune.c ç¼–è¯‘æˆåŠŸ"
        else
          echo "âš ï¸  kernel/sched/tune.c ç¼–è¯‘å¤±è´¥ï¼Œä½†ç»§ç»­ï¼ˆå·²ç¦ç”¨SCHED_TUNEï¼‰"
        fi
        
        echo "3. æµ‹è¯•ç¼–è¯‘ mediatek blocktag..."
        if make O=out ARCH=arm64 -j1 drivers/misc/mediatek/blocktag/ 2>&1 | tee test_blocktag.log; then
          echo "âœ… mediatek blocktag ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ mediatek blocktag ç¼–è¯‘å¤±è´¥"
          grep -i "error" test_blocktag.log | head -5
          exit 1
        fi

    - name: Stage 1 - Build core without scheduler
      run: |
        cd $KERNEL_DIR
        echo "=== é˜¶æ®µ 1: ç¼–è¯‘æ ¸å¿ƒï¼ˆæ’é™¤è°ƒåº¦å™¨ï¼‰ ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # å…ˆç¼–è¯‘é™¤äº†è°ƒåº¦å™¨ä¹‹å¤–çš„æ ¸å¿ƒç»„ä»¶
        echo "ç¼–è¯‘åŸºç¡€å†…æ ¸ï¼ˆæ’é™¤è°ƒåº¦å™¨ï¼‰..."
        if make O=out ARCH=arm64 -j$(nproc) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          KCFLAGS="-Wno-error -Wno-format -Wno-enum-int-mismatch -Wno-incompatible-pointer-types" \
          kernel/ mm/ fs/ ipc/ init/ lib/ crypto/ security/ \
          2>&1 | tee stage1_core.log; then
          echo "âœ… æ ¸å¿ƒç»„ä»¶ç¼–è¯‘æˆåŠŸ"
          echo "STAGE1_PASSED=true" >> $GITHUB_ENV
        else
          echo "âŒ æ ¸å¿ƒç»„ä»¶ç¼–è¯‘å¤±è´¥"
          grep -i "error:" stage1_core.log | head -10
          echo "STAGE1_PASSED=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Stage 2 - Build architecture
      if: env.STAGE1_PASSED == 'true'
      run: |
        cd $KERNEL_DIR
        echo "=== é˜¶æ®µ 2: ç¼–è¯‘æ¶æ„ä»£ç  ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "ç¼–è¯‘ ARM64 æ¶æ„ä»£ç ..."
        if make O=out ARCH=arm64 -j$(nproc) arch/arm64/ 2>&1 | tee stage2_arch.log; then
          echo "âœ… ARM64 æ¶æ„ç¼–è¯‘æˆåŠŸ"
          echo "STAGE2_PASSED=true" >> $GITHUB_ENV
        else
          echo "âŒ ARM64 æ¶æ„ç¼–è¯‘å¤±è´¥"
          grep -i "error:" stage2_arch.log | head -10
          echo "STAGE2_PASSED=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Stage 3 - Build drivers selectively
      if: env.STAGE2_PASSED == 'true'
      run: |
        cd $KERNEL_DIR
        echo "=== é˜¶æ®µ 3: é€‰æ‹©æ€§ç¼–è¯‘é©±åŠ¨ ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # å…ˆç¼–è¯‘æ²¡æœ‰é—®é¢˜çš„é©±åŠ¨
        echo "1. ç¼–è¯‘åŸºç¡€é©±åŠ¨..."
        if make O=out ARCH=arm64 -j$(nproc) \
          drivers/base/ drivers/char/ drivers/clk/ drivers/dma/ \
          drivers/gpu/drm/ drivers/hid/ drivers/i2c/ drivers/iommu/ \
          2>&1 | tee stage3_drivers1.log; then
          echo "âœ… åŸºç¡€é©±åŠ¨ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ åŸºç¡€é©±åŠ¨ç¼–è¯‘å¤±è´¥"
          grep -i "error:" stage3_drivers1.log | head -10
          exit 1
        fi
        
        # å•ç‹¬ç¼–è¯‘æœ‰é—®é¢˜çš„ mediatek é©±åŠ¨
        echo "2. ç¼–è¯‘ Mediatek é©±åŠ¨ï¼ˆé€ä¸ªæ¨¡å—ï¼‰..."
        
        # å…ˆç¼–è¯‘æ²¡æœ‰é—®é¢˜çš„ mediatek æ¨¡å—
        for module in atf accdet base/power/clkbuf_v1; do
          echo "ç¼–è¯‘ mediatek/$module..."
          if make O=out ARCH=arm64 -j1 drivers/misc/mediatek/$module 2>&1 | tee -a stage3_mediatek.log; then
            echo "âœ… mediatek/$module ç¼–è¯‘æˆåŠŸ"
          else
            echo "âš ï¸  mediatek/$module ç¼–è¯‘æœ‰è­¦å‘Š"
          fi
        done
        
        # è·³è¿‡æœ‰é—®é¢˜çš„æ¨¡å—
        echo "è·³è¿‡æœ‰é—®é¢˜çš„ mediatek æ¨¡å—: blocktag, cm_mgr_v1"

    - name: Stage 4 - Build remaining components
      if: env.STAGE2_PASSED == 'true'
      run: |
        cd $KERNEL_DIR
        echo "=== é˜¶æ®µ 4: ç¼–è¯‘å‰©ä½™ç»„ä»¶ ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "ç¼–è¯‘å‰©ä½™ç»„ä»¶ï¼ˆè·³è¿‡æœ‰é—®é¢˜çš„ï¼‰..."
        # ä½¿ç”¨æ›´å®½æ¾çš„ç¼–è¯‘é€‰é¡¹
        time make O=out ARCH=arm64 -j$(($(nproc) + 1)) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          KCFLAGS="-Wno-error -Wno-format -Wno-enum-int-mismatch -Wno-incompatible-pointer-types -Wno-uninitialized -Wno-misleading-indentation" \
          KCPPFLAGS="-Wno-error" \
          2>&1 | tee full_build.log || echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥ç»“æœ..."

    - name: Check final build results
      run: |
        cd $KERNEL_DIR
        echo "=== æ£€æŸ¥æœ€ç»ˆæ„å»ºç»“æœ ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ!"
          echo "æ–‡ä»¶: out/arch/arm64/boot/Image.gz"
          echo "å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
          echo "ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
          find out/arch/arm64/boot/ -type f -exec ls -la {} \; || echo "æ— æ³•åˆ—å‡ºæ–‡ä»¶"
        else
          echo "âš ï¸  å†…æ ¸é•œåƒæœªç”Ÿæˆï¼Œä½†éƒ¨åˆ†ç»„ä»¶ç¼–è¯‘æˆåŠŸ"
          echo "å„é˜¶æ®µçŠ¶æ€:"
          echo "é˜¶æ®µ1 (æ ¸å¿ƒç»„ä»¶): ${{ env.STAGE1_PASSED || 'æœªå®Œæˆ' }}"
          echo "é˜¶æ®µ2 (æ¶æ„ç»„ä»¶): ${{ env.STAGE2_PASSED || 'æœªå®Œæˆ' }}"
          echo "ç¼–è¯‘æ‘˜è¦:"
          if [ -f "full_build.log" ]; then
            echo "æœ€åé”™è¯¯:"
            grep -i "error:" full_build.log | tail -5
            echo "è­¦å‘Šç»Ÿè®¡:"
            grep -i "warning:" full_build.log | wc -l
          fi
          # ä¸é€€å‡ºï¼Œå…è®¸éƒ¨åˆ†æˆåŠŸ
        fi

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/*.log
        retention-days: 30

    - name: Create build summary
      if: always()
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºå®ŒæˆæŠ¥å‘Š ==="
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸ!"
          echo ""
          echo "ä¿®å¤çš„é—®é¢˜:"
          echo "  âœ… try_to_unmap å‚æ•°ä¿®å¤"
          echo "  âœ… blocktag æ ¼å¼å­—ç¬¦ä¸²ä¿®å¤" 
          echo "  âœ… get_boot_mode ç±»å‹å†²çªä¿®å¤"
          echo "  âœ… mt_cpufreq å‡½æ•°å£°æ˜ä¿®å¤"
          echo ""
          echo "ğŸ“¦ äº§ç‰©: out/arch/arm64/boot/Image.gz"
        else
          echo "âš ï¸  ç¼–è¯‘éƒ¨åˆ†æˆåŠŸ"
          echo ""
          echo "ä¿®å¤çš„é—®é¢˜:"
          echo "  âœ… try_to_unmap å‚æ•°ä¿®å¤"
          echo "  âœ… blocktag æ ¼å¼å­—ç¬¦ä¸²ä¿®å¤"
          echo "  âœ… get_boot_mode ç±»å‹å†²çªä¿®å¤"
          echo "  âœ… mt_cpufreq å‡½æ•°å£°æ˜ä¿®å¤"
          echo ""
          echo "å‰©ä½™é—®é¢˜:"
          echo "  ğŸ”§ uclamp_se_set å†…è”é—®é¢˜ï¼ˆå·²ç¦ç”¨SCHED_TUNEï¼‰"
          echo "  ğŸ”§ å…¶ä»– mediatek é©±åŠ¨å…¼å®¹æ€§é—®é¢˜"
          echo ""
          echo "å»ºè®®: å†…æ ¸é…ç½®å¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´ä»¥è§£å†³å‰©ä½™é—®é¢˜"
        fi