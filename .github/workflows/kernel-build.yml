name: Build MT6768 Kernel (Fix Shell Syntax Error)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python2.7 python2.7-dev \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix shell environment and syntax issues
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤Shellç¯å¢ƒé—®é¢˜ ==="
        
        # è®¾ç½®ç®€å•çš„ç¯å¢ƒå˜é‡
        export USER=runner
        export HOME=/home/runner
        export SHELL=/bin/bash
        
        # ä¿®å¤å¯èƒ½çš„å¼•å·é—®é¢˜
        find . -name "*.sh" -type f -exec sed -i 's/\r$//' {} \;  # ä¿®å¤Windowsæ¢è¡Œç¬¦
        find . -name "*.sh" -type f -exec chmod +x {} \;  # ç¡®ä¿å¯æ‰§è¡Œæƒé™

    - name: Clean minimal configuration
      run: |
        cd $KERNEL_DIR
        echo "=== æ¸…ç†é…ç½® ==="
        
        rm -rf out
        mkdir -p out
        
        # ä½¿ç”¨defconfigä½œä¸ºåŸºç¡€
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        echo "åŸºç¡€é…ç½®å®Œæˆ"

    - name: Build with simple environment
      run: |
        cd $KERNEL_DIR
        
        if [ ! -f "out/.config" ]; then
          echo "âŒ æ²¡æœ‰é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        echo "=== ä½¿ç”¨ç®€å•ç¯å¢ƒç¼–è¯‘ ==="
        
        # è®¾ç½®æœ€åŸºæœ¬çš„ç¯å¢ƒå˜é‡
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # ä½¿ç”¨æœ€ç®€å•çš„ç¼–è¯‘æ ‡å¿—
        export KCFLAGS="-Wno-error -Wno-format -Wno-memset-elt-size"
        
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "ç¯å¢ƒå˜é‡:"
        env | grep -E "ARCH|CROSS_COMPILE|KCFLAGS" || true
        
        echo "å¼€å§‹ç¼–è¯‘..."
        # ä½¿ç”¨ç®€å•çš„makeå‘½ä»¤ï¼Œé¿å…å¤æ‚ç¯å¢ƒ
        time make O=out ARCH=arm64 -j$(nproc) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          2>&1 | tee build.log

    - name: Debug shell syntax issues
      if: failure()
      run: |
        cd $KERNEL_DIR
        echo "=== è°ƒè¯•Shellè¯­æ³•é—®é¢˜ ==="
        
        # æ£€æŸ¥initç›®å½•çš„Makefile
        if [ -f "init/Makefile" ]; then
          echo "æ£€æŸ¥init/Makefileç¬¬40è¡Œé™„è¿‘:"
          sed -n '35,45p' init/Makefile
        fi
        
        # æ£€æŸ¥scripts/mkcompile_hè„šæœ¬
        if [ -f "scripts/mkcompile_h" ]; then
          echo "æ£€æŸ¥mkcompile_hè„šæœ¬:"
          head -20 scripts/mkcompile_h
          echo "è„šæœ¬å¤§å°: $(wc -l < scripts/mkcompile_h) è¡Œ"
        fi
        
        # æ£€æŸ¥ç¯å¢ƒå˜é‡ä¸­çš„å¼•å·é—®é¢˜
        echo "æ£€æŸ¥ç¯å¢ƒå˜é‡:"
        env | grep -E '["\047]' || echo "æœªå‘ç°å¼•å·é—®é¢˜"

    - name: Fix compile.h generation
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤compile.hç”Ÿæˆé—®é¢˜ ==="
        
        # æ‰‹åŠ¨åˆ›å»ºå¿…è¦çš„ç›®å½•
        mkdir -p out/include/generated
        
        # åˆ›å»ºç®€å•çš„compile.hæ–‡ä»¶
        cat > out/include/generated/compile.h << 'EOF'
        /* This file is auto generated, version 1 */
        #define UTS_MACHINE "aarch64"
        #define UTS_VERSION "#1 SMP PREEMPT $(date)"
        #define LINUX_COMPILE_BY "runner"
        #define LINUX_COMPILE_HOST "github-actions"
        #define LINUX_COMPILER "aarch64-linux-gnu-gcc"
        EOF
        
        echo "æ‰‹åŠ¨åˆ›å»ºäº† compile.h"

    - name: Try alternative build approach
      run: |
        cd $KERNEL_DIR
        echo "=== å°è¯•æ›¿ä»£æ„å»ºæ–¹æ³• ==="
        
        # è®¾ç½®ç¯å¢ƒ
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # å…ˆç¼–è¯‘initç›¸å…³éƒ¨åˆ†
        echo "ç¼–è¯‘initéƒ¨åˆ†..."
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- init/main.o 2>&1 | tee -a build.log || {
          echo "initç¼–è¯‘å¤±è´¥ï¼Œå°è¯•è·³è¿‡"
        }
        
        # ç„¶åå°è¯•å®Œæ•´ç¼–è¯‘
        echo "å®Œæ•´ç¼–è¯‘..."
        time make O=out ARCH=arm64 -j$(nproc) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          -i 2>&1 | tee -a build.log

    - name: Manual kernel compilation
      if: failure()
      run: |
        cd $KERNEL_DIR
        echo "=== æ‰‹åŠ¨ç¼–è¯‘å†…æ ¸ ==="
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p out/arch/arm64/boot
        
        # å°è¯•ç¼–è¯‘æ ¸å¿ƒéƒ¨åˆ†
        echo "ç¼–è¯‘æ ¸å¿ƒå¯¹è±¡æ–‡ä»¶..."
        
        # ç¼–è¯‘åŸºæœ¬çš„å†…æ ¸æ–‡ä»¶
        for dir in init kernel arch/arm64/kernel lib; do
          if [ -d "$dir" ]; then
            echo "ç¼–è¯‘ $dir..."
            make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- $dir/ 2>&1 | tail -5 || echo "$dir ç¼–è¯‘é‡åˆ°é—®é¢˜"
          fi
        done
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†è¶³å¤Ÿçš„å¯¹è±¡æ–‡ä»¶
        object_count=$(find out/ -name "*.o" -type f | wc -l)
        echo "å·²ç¼–è¯‘å¯¹è±¡æ–‡ä»¶: $object_count"
        
        if [ $object_count -gt 100 ]; then
          echo "å°è¯•æ‰‹åŠ¨é“¾æ¥..."
          # å°è¯•æ‰¾åˆ°é“¾æ¥è„šæœ¬
          if [ -f "out/arch/arm64/kernel/vmlinux.lds" ]; then
            echo "ä½¿ç”¨é“¾æ¥è„šæœ¬æ‰‹åŠ¨é“¾æ¥..."
            find out/ -name "*.o" -type f > objects.list
            if [ -s objects.list ]; then
              aarch64-linux-gnu-ld -EL -p --no-undefined -X --build-id -o out/vmlinux \
                -T out/arch/arm64/kernel/vmlinux.lds @objects.list 2>&1 | tail -10 || echo "é“¾æ¥å¤±è´¥"
            fi
          fi
        fi

    - name: Generate kernel image if possible
      run: |
        cd $KERNEL_DIR
        echo "=== ç”Ÿæˆå†…æ ¸é•œåƒ ==="
        
        if [ -f "out/vmlinux" ]; then
          echo "æ‰¾åˆ° vmlinuxï¼Œç”Ÿæˆé•œåƒ..."
          mkdir -p out/arch/arm64/boot
          
          # ç”Ÿæˆæœªå‹ç¼©çš„ Image
          aarch64-linux-gnu-objcopy -O binary -R .note -R .comment -S out/vmlinux out/arch/arm64/boot/Image 2>&1 | tail -5 && {
            echo "âœ… ç”Ÿæˆ Image æˆåŠŸ"
            
            # å‹ç¼©ä¸º Image.gz
            gzip -k -f out/arch/arm64/boot/Image
            echo "âœ… ç”Ÿæˆ Image.gz æˆåŠŸ"
            ls -lh out/arch/arm64/boot/Image.gz
          } || echo "æ— æ³•ç”Ÿæˆ Image"
        else
          echo "æ²¡æœ‰ vmlinux æ–‡ä»¶"
          # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯ç”¨çš„å†…æ ¸æ–‡ä»¶
          find out/ -name "vmlinux*" -o -name "Image*" | head -10
        fi

    - name: Analyze results
      run: |
        cd $KERNEL_DIR
        echo "=== ç»“æœåˆ†æ ==="
        
        # æ£€æŸ¥ç¼–è¯‘æ—¥å¿—
        if [ -f "build.log" ]; then
          echo "æ„å»ºæ—¥å¿—: $(wc -l < build.log) è¡Œ"
          echo "é”™è¯¯: $(grep -c "error:" build.log || echo 0)"
          echo "è­¦å‘Š: $(grep -c "warning:" build.log || echo 0)"
          
          # æ£€æŸ¥ç‰¹å®šé”™è¯¯
          if grep -q "Unterminated quoted string" build.log; then
            echo "âŒ å‘ç°æœªç»ˆæ­¢å¼•å·é”™è¯¯"
            grep -A 5 -B 5 "Unterminated quoted string" build.log | head -10
          fi
        fi
        
        echo "=== æ–‡ä»¶æ£€æŸ¥ ==="
        for file in "out/vmlinux" "out/arch/arm64/boot/Image" "out/arch/arm64/boot/Image.gz"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨ ($(du -h "$file" | cut -f1))"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
          fi
        done
        
        echo "å¯¹è±¡æ–‡ä»¶æ•°é‡: $(find out/ -name "*.o" | wc -l)"

    - name: Upload any results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-results-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/out/vmlinux
          ${{ env.KERNEL_DIR }}/build.log
        retention-days: 30

    - name: Final report
      run: |
        cd $KERNEL_DIR
        echo "=== æœ€ç»ˆæŠ¥å‘Š ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ æˆåŠŸç”Ÿæˆå†…æ ¸é•œåƒ!"
          echo "æ–‡ä»¶: out/arch/arm64/boot/Image.gz"
          echo "å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
        elif [ -f "out/vmlinux" ]; then
          echo "âš ï¸ ç”Ÿæˆäº† vmlinux ä½†æ²¡æœ‰å‹ç¼©é•œåƒ"
          echo "å¯ä»¥æ‰‹åŠ¨è¿è¡Œ: gzip -c out/vmlinux > Image.gz"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo ""
          echo "é—®é¢˜åˆ†æ:"
          echo "1. Shellè¯­æ³•é”™è¯¯ - å¯èƒ½æ˜¯ç¯å¢ƒå˜é‡æˆ–è„šæœ¬é—®é¢˜"
          echo "2. éœ€è¦æ‰‹åŠ¨ä¿®å¤å†…æ ¸æ„å»ºç³»ç»Ÿ"
          echo ""
          echo "å»ºè®®:"
          echo "1. æ£€æŸ¥å†…æ ¸æºç ä¸­çš„shellè„šæœ¬"
          echo "2. å°è¯•åœ¨æœ¬åœ°ç¯å¢ƒç¼–è¯‘è°ƒè¯•"
          echo "3. è€ƒè™‘ä½¿ç”¨ä¸åŒçš„å†…æ ¸ç‰ˆæœ¬"
        fi