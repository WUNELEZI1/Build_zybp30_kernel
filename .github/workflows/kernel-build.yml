name: Build MT6768 Kernel (Fixed Block Crypto)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python2.7 python2.7-dev \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix compilation errors
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤ç¼–è¯‘é”™è¯¯ ==="
        
        # æ¸…ç†
        rm -rf out
        mkdir -p out
        
        # ä½¿ç”¨ç³»ç»Ÿ GCC è¿›è¡Œé…ç½®
        echo "é…ç½®å†…æ ¸..."
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }} && {
          echo "âœ… é…ç½®æˆåŠŸ"
        } || {
          echo "âŒ ç‰¹å®šé…ç½®å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€é…ç½®"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        }
        
        # ä¿®å¤é…ç½®é—®é¢˜
        echo "åº”ç”¨ä¿®å¤..."
        
        # ä¿®å¤å—è®¾å¤‡åŠ å¯†ç›¸å…³é”™è¯¯ - ç¦ç”¨ç›¸å…³åŠŸèƒ½
        ./scripts/config --file out/.config -d BLK_INLINE_ENCRYPTION
        ./scripts/config --file out/.config -d BLK_DEV_INLINE_CRYPTO
        ./scripts/config --file out/.config -d BLK_CRYPTO
        ./scripts/config --file out/.config -d BLK_CRYPTO_FALLBACK
        ./scripts/config --file out/.config -d KEYS
        
        # ç¦ç”¨ UCLAMP åŠŸèƒ½ï¼ˆå¯¼è‡´ç¼–è¯‘é”™è¯¯çš„æ ¹æºï¼‰
        ./scripts/config --file out/.config -d UCLAMP_TASK
        ./scripts/config --file out/.config -d SCHED_TUNE
        
        # ç¦ç”¨å…¶ä»–å¯èƒ½æœ‰é—®é¢˜çš„é…ç½®
        ./scripts/config --file out/.config -d CHARGER_BQ25890
        ./scripts/config --file out/.config -d MTK_CMDQ
        ./scripts/config --file out/.config -d MTK_QOS_FRAMEWORK
        ./scripts/config --file out/.config -d TOUCHSCREEN_GOODIX_BRL
        ./scripts/config --file out/.config -d ACCDET_MT6358
        ./scripts/config --file out/.config -d MTK_SENSORS_1_0
        ./scripts/config --file out/.config -d INPUT_FINGERPRINT
        ./scripts/config --file out/.config -d MEDIATEX_EXTCON
        
        # ç¡®ä¿å¯ç”¨å¿…è¦çš„é…ç½®
        ./scripts/config --file out/.config -e MODULES
        ./scripts/config --file out/.config -e MODULE_UNLOAD
        ./scripts/config --file out/.config -e ARM64
        
        # æ›´æ–°é…ç½®
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        
        echo "ä¿®å¤åçš„é…ç½®æ‘˜è¦:"
        grep -E "BLK_INLINE|BLK_CRYPTO|UCLAMP|SCHED_TUNE" out/.config || echo "ç›¸å…³é…ç½®å·²ç¦ç”¨"

    - name: Patch kernel source (fix inline crypto errors)
      run: |
        cd $KERNEL_DIR
        echo "=== åº”ç”¨æºç è¡¥ä¸ä¿®å¤å†…è”åŠ å¯†é”™è¯¯ ==="
        
        # åˆ›å»ºè¡¥ä¸æ–‡ä»¶æ¥ä¿®å¤ blk-crypto.h ä¸­çš„å†…è”å‡½æ•°é—®é¢˜
        cat > fix_inline_crypto.patch << 'EOF'
        --- a/include/linux/blk-crypto.h
        +++ b/include/linux/blk-crypto.h
        @@ -30,7 +30,7 @@ static inline bool blk_crypto_rq_is_encrypted(struct request *rq)
         
         #ifdef CONFIG_BLK_INLINE_ENCRYPTION
         
        -inline void blk_crypto_flock(struct keyslot_manager *ksm, unsigned int flags);
        +static inline void blk_crypto_flock(struct keyslot_manager *ksm, unsigned int flags) {}
         
         #else /* CONFIG_BLK_INLINE_ENCRYPTION */
         
        --- a/include/linux/keyslot-manager.h
        +++ b/include/linux/keyslot-manager.h
        @@ -98,7 +98,7 @@ void *keyslot_manager_private(struct keyslot_manager *ksm);
         
         #ifdef CONFIG_BLK_INLINE_ENCRYPTION
         
        -inline void ksm_flock(struct keyslot_manager *ksm, unsigned int flags);
        +static inline void ksm_flock(struct keyslot_manager *ksm, unsigned int flags) {}
         
         #else /* CONFIG_BLK_INLINE_ENCRYPTION */
         
        EOF
        
        # åº”ç”¨è¡¥ä¸
        if patch -p1 -N --dry-run < fix_inline_crypto.patch; then
          patch -p1 < fix_inline_crypto.patch
          echo "âœ… æºç è¡¥ä¸åº”ç”¨æˆåŠŸ"
        else
          echo "âš ï¸ è¡¥ä¸å¯èƒ½å·²åº”ç”¨æˆ–ä¸éœ€è¦ï¼Œç»§ç»­ç¼–è¯‘"
        fi

    - name: Build with fixes
      run: |
        cd $KERNEL_DIR
        
        if [ ! -f "out/.config" ]; then
          echo "âŒ æ²¡æœ‰é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        echo "=== ä½¿ç”¨ä¿®å¤åçš„é…ç½®ç¼–è¯‘ ==="
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "å¼€å§‹ç¼–è¯‘..."
        # ä½¿ç”¨æ›´å¤šè¯¦ç»†è¾“å‡ºä»¥ä¾¿è°ƒè¯•
        time make O=out ARCH=arm64 -j$(nproc) \
          CROSS_COMPILE="$CROSS_COMPILE" \
          V=1 2>&1 | tee build.log

    - name: Check compilation results
      run: |
        cd $KERNEL_DIR
        echo "=== ç¼–è¯‘ç»“æœæ£€æŸ¥ ==="
        
        # æ£€æŸ¥ç¼–è¯‘æ—¥å¿—
        if [ -f "build.log" ]; then
          echo "æ„å»ºæ—¥å¿—: $(wc -l < build.log) è¡Œ"
          echo "é”™è¯¯: $(grep -c "error:" build.log || echo 0)"
          echo "è­¦å‘Š: $(grep -c "warning:" build.log || echo 0)"
          
          # æ£€æŸ¥ç‰¹å®šé”™è¯¯
          if grep -q "blk_crypto_flock" build.log || grep -q "ksm_flock" build.log; then
            echo "âŒ å—è®¾å¤‡åŠ å¯†é”™è¯¯ä»ç„¶å­˜åœ¨:"
            grep -A 5 -B 5 "blk_crypto_flock\|ksm_flock" build.log | head -20
          elif grep -q "error:" build.log; then
            echo "å…¶ä»–é”™è¯¯:"
            grep "error:" build.log | tail -5
          else
            echo "âœ… æ— ç¼–è¯‘é”™è¯¯"
          fi
        fi
        
        # è¯¦ç»†æ£€æŸ¥è¾“å‡º
        echo "=== å†…æ ¸æ–‡ä»¶æ£€æŸ¥ ==="
        
        # æ£€æŸ¥ vmlinux
        if [ -f "out/vmlinux" ]; then
          echo "ğŸ‰ âœ… vmlinux å·²ç”Ÿæˆ!"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file out/vmlinux
          echo "å¤§å°: $(du -h out/vmlinux | cut -f1)"
        else
          echo "âŒ vmlinux æœªç”Ÿæˆ"
          # æ£€æŸ¥æ˜¯å¦æœ‰å¯¹è±¡æ–‡ä»¶
          echo "å¯¹è±¡æ–‡ä»¶æ£€æŸ¥:"
          find out/ -name "*.o" | head -5
        fi
        
        # æ£€æŸ¥ Image.gz
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ âœ… Image.gz å·²ç”Ÿæˆ!"
          echo "å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
        else
          echo "âŒ Image.gz æœªç”Ÿæˆ"
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªå‹ç¼©çš„ Image
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "âš ï¸ æ‰¾åˆ°æœªå‹ç¼©çš„ Imageï¼Œæ‰‹åŠ¨å‹ç¼©..."
            gzip -k out/arch/arm64/boot/Image
            echo "âœ… æ‰‹åŠ¨ç”Ÿæˆ Image.gz æˆåŠŸ"
          fi
        fi
        
        # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
        echo "=== æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ ==="
        find out/ -type f \( -name "vmlinux*" -o -name "Image*" -o -name "*.gz" -o -name "*.img" \) 2>/dev/null | while read f; do
          echo "ğŸ“„ $f ($(du -h "$f" 2>/dev/null | cut -f1))"
        done || echo "æ— å†…æ ¸æ–‡ä»¶"

    - name: Alternative build approach
      if: failure()
      run: |
        cd $KERNEL_DIR
        echo "=== å°è¯•æ›¿ä»£æ„å»ºæ–¹æ³• ==="
        
        # å®Œå…¨æ¸…ç†
        rm -rf out
        mkdir -p out
        
        echo "ä½¿ç”¨æœ€å°é…ç½®æ„å»º..."
        # ä½¿ç”¨ defconfig å¹¶æ‰‹åŠ¨ç¦ç”¨é—®é¢˜é…ç½®
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # å¼ºåˆ¶ç¦ç”¨æ‰€æœ‰å—åŠ å¯†ç›¸å…³é…ç½®
        for config in BLK_INLINE_ENCRYPTION BLK_DEV_INLINE_CRYPTO BLK_CRYPTO BLK_CRYPTO_FALLBACK KEYS; do
          ./scripts/config --file out/.config -d $config 2>/dev/null || true
        done
        
        # ç¦ç”¨å…¶ä»–é—®é¢˜é…ç½®
        ./scripts/config --file out/.config -d UCLAMP_TASK
        ./scripts/config --file out/.config -d SCHED_TUNE
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        
        echo "ä½¿ç”¨æœ€å°é…ç½®ç¼–è¯‘..."
        time make O=out ARCH=arm64 -j$(nproc) CROSS_COMPILE=aarch64-linux-gnu-

    - name: Upload successful kernel
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-fixed-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/out/vmlinux
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/build.log
          ${{ env.KERNEL_DIR }}/out/.config
          ${{ env.KERNEL_DIR }}/fix_inline_crypto.patch
        retention-days: 15

    - name: Final summary
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºæ€»ç»“ ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ ğŸ‰ ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸï¼"
          echo "å¯ç”¨çš„å†…æ ¸é•œåƒ:"
          ls -lh out/arch/arm64/boot/Image.gz
          echo ""
          echo "ä¸‹ä¸€æ­¥:"
          echo "1. ä¸‹è½½ Artifacts ä¸­çš„ kernel-fixed-*"
          echo "2. ä½¿ç”¨ Image.gz åˆ·å…¥è®¾å¤‡"
          echo "3. æµ‹è¯•å†…æ ¸åŠŸèƒ½"
        elif [ -f "out/vmlinux" ]; then
          echo "âš ï¸ ç”Ÿæˆäº† vmlinux ä½†æœªå‹ç¼©"
          echo "å¯ä»¥æ‰‹åŠ¨å‹ç¼©: gzip -c out/vmlinux > Image.gz"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "è¯·æ£€æŸ¥ build-logs-* ä¸­çš„é”™è¯¯ä¿¡æ¯"
          echo "å¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´å†…æ ¸é…ç½®æˆ–ä¿®å¤æºç "
        fi