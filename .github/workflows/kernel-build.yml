name: Build MediaTek Kernel

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'å†…æ ¸é…ç½®æ–‡ä»¶'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ç¼–è¯‘ MediaTek å®˜æ–¹å†…æ ¸
      run: |
        echo "=== ğŸš€ ç¼–è¯‘ MediaTek å®˜æ–¹å†…æ ¸ ==="
        
        # æ€§èƒ½é…ç½®
        CPU_CORES=$(nproc)
        PARALLEL_JOBS=$((CPU_CORES * 2))
        
        echo "é…ç½®: $PARALLEL_JOBS å¹¶è¡Œä»»åŠ¡ | $ARCHæ¶æ„"
        echo "æºç : MediaTek-Labs/common-kernel-4.19"
        
        # å®‰è£…ä¾èµ– - ä½¿ç”¨ GCC 9 å·¥å…·é“¾ä»¥å…¼å®¹å†…æ ¸ 4.19
        echo "ğŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…· (GCC 9)..."
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          build-essential bc bison flex libssl-dev libelf-dev \
          gcc-9-aarch64-linux-gnu g++-9-aarch64-linux-gnu git python3 libncurses-dev \
          dwarves rsync kmod cpio
        
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        
        # è®¾ç½®ä½¿ç”¨ GCC 9 å·¥å…·é“¾
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=aarch64-linux-gnu-gcc-9
        export CXX=aarch64-linux-gnu-g++-9
        
        # å…³é”®ä¿®å¤ï¼šä¸º GCC 9 å·¥å…·é“¾åˆ›å»ºæ— ç‰ˆæœ¬å·ç¬¦å·é“¾æ¥
        sudo ln -sf /usr/bin/aarch64-linux-gnu-gcc-9 /usr/bin/aarch64-linux-gnu-gcc
        sudo ln -sf /usr/bin/aarch64-linux-gnu-g++-9 /usr/bin/aarch64-linux-gnu-g++
        sudo ln -sf /usr/bin/aarch64-linux-gnu-cpp-9 /usr/bin/aarch64-linux-gnu-cpp
        echo "âœ… å·²åˆ›å»º GCC 9 å·¥å…·é“¾ç¬¦å·é“¾æ¥"
        
        # å…‹éš†å®˜æ–¹å†…æ ¸æºç  (åªå…‹éš† master åˆ†æ”¯)
        echo "ğŸ”§ è·å– MediaTek å®˜æ–¹å†…æ ¸æºç ..."
        git clone --depth=1 https://github.com/MediaTek-Labs/common-kernel-4.19.git kernel-source --quiet
        
        cd kernel-source

        # ğŸ”§ å…³é”®ä¿®å¤ï¼šä¿®å¤ dtc ç¼–è¯‘é”™è¯¯ (yylloc å¤šé‡å®šä¹‰)
        echo "ğŸ”§ ä¿®å¤ dtc ç¼–è¯‘é”™è¯¯..."
        sed -i 's/^YYLTYPE yylloc;/extern YYLTYPE yylloc;/' scripts/dtc/dtc-lexer.l
        sed -i 's/^YYLTYPE yylloc;/extern YYLTYPE yylloc;/' scripts/dtc/dtc-parser.tab.c 2>/dev/null || true
        echo "âœ… dtc æºç ä¿®å¤å®Œæˆ"
        
        # ğŸ”§ å…³é”®ä¿®å¤ï¼šç¦ç”¨æœ‰é—®é¢˜çš„ MediaTek DVFSRC é©±åŠ¨
        echo "ğŸ”§ é…ç½®å†…æ ¸æ—¶ç¦ç”¨æœ‰é—®é¢˜çš„é©±åŠ¨..."
        {
          echo "# ç¦ç”¨æœ‰é—®é¢˜çš„ MediaTek DVFSRC é©±åŠ¨"
          echo "CONFIG_MTK_DVFSRC=n"
          echo "CONFIG_MTK_DVFSRC_MT6768=n"
          echo "CONFIG_MTK_DVFSRC_HELPER=n"
        } > .disable_problematic_drivers
        
        # æ¸…ç†å’Œé…ç½®
        echo "âš™ï¸ é…ç½®å†…æ ¸..."
        rm -f .config .config.old
        
        # ä½¿ç”¨æŒ‡å®šé…ç½®æˆ–é»˜è®¤é…ç½®
        if make ${{ github.event.inputs.defconfig }} 2>/dev/null; then
          echo "âœ… ä½¿ç”¨é…ç½®: ${{ github.event.inputs.defconfig }}"
        else
          echo "âš ï¸ ä½¿ç”¨é»˜è®¤é…ç½®"
          make defconfig
        fi
        
        # åˆå¹¶ç¦ç”¨é©±åŠ¨é…ç½®
        cat .disable_problematic_drivers >> .config
        
        # ä¼˜åŒ–é…ç½®ï¼ˆå¯é€‰ï¼‰- ç¦ç”¨è°ƒè¯•ä¿¡æ¯åŠ é€Ÿç¼–è¯‘
        echo "ğŸ”§ åº”ç”¨ç¼–è¯‘ä¼˜åŒ–..."
        sed -i 's/CONFIG_DEBUG_INFO=y/CONFIG_DEBUG_INFO=n/' .config 2>/dev/null || true
        sed -i 's/CONFIG_DEBUG_KERNEL=y/CONFIG_DEBUG_KERNEL=n/' .config 2>/dev/null || true
        
        # ğŸ”§ é¢å¤–ä¿®å¤ï¼šå¦‚æœDVFSRCé©±åŠ¨ç¼–è¯‘ä»å¤±è´¥ï¼Œç›´æ¥åˆ é™¤æºæ–‡ä»¶
        echo "ğŸ”§ å‡†å¤‡ä¿®å¤ï¼šå¦‚æœ‰éœ€è¦ï¼Œç›´æ¥åˆ é™¤æœ‰é—®é¢˜çš„é©±åŠ¨æ–‡ä»¶..."
        DVFSRC_DIR="drivers/misc/mediatek/dvfsrc"
        if [ -d "$DVFSRC_DIR" ]; then
          echo "æ‰¾åˆ° DVFSRC ç›®å½•ï¼Œå‡†å¤‡åœ¨ç¼–è¯‘å¤±è´¥æ—¶ä¿®å¤"
          echo "DVFSRC_DIR_EXISTS=true" >> $GITHUB_ENV
        fi
        
        # å¼€å§‹ç¼–è¯‘
        echo "âš¡ å¼€å§‹ç¼–è¯‘..."
        START_TIME=$(date +%s)
        
        # ç¼–è¯‘è¿›åº¦ç›‘æ§
        (
          echo "ğŸ“Š ç¼–è¯‘è¿›åº¦ç›‘æ§..."
          while true; do
            if ps aux | grep -v grep | grep -q "make.*-j"; then
              COMPILED_FILES=$(find . -name "*.o" -type f 2>/dev/null | wc -l)
              TOTAL_FILES=$(find . -name "*.c" -type f 2>/dev/null | wc -l)
              if [ $TOTAL_FILES -gt 0 ]; then
                PERCENT=$((COMPILED_FILES * 100 / TOTAL_FILES))
                echo "[$(date +%H:%M:%S)] è¿›åº¦: $PERCENT% ($COMPILED_FILES/$TOTAL_FILES)"
              fi
            else
              break
            fi
            sleep 30
          done
        ) &
        MONITOR_PID=$!
        
        # åˆ†é˜¶æ®µç¼–è¯‘
        echo "é˜¶æ®µ1: ç¼–è¯‘ vmlinux..."
        make -j$PARALLEL_JOBS vmlinux
        
        echo "é˜¶æ®µ2: ç¼–è¯‘ Image..."
        make -j$PARALLEL_JOBS Image
        
        # é˜¶æ®µ3: ç¼–è¯‘æ¨¡å—ï¼ˆä½¿ç”¨ä¿®å¤ç­–ç•¥ï¼‰
        echo "é˜¶æ®µ3: ç¼–è¯‘æ¨¡å—ï¼ˆä½¿ç”¨æ™ºèƒ½ä¿®å¤ç­–ç•¥ï¼‰..."
        
        # ç¬¬ä¸€æ¬¡å°è¯•ç¼–è¯‘æ¨¡å—
        make -j$PARALLEL_JOBS modules 2>&1 | tee modules_build_attempt1.log
        MODULES_EXIT_CODE=${PIPESTATUS[0]}
        
        if [ $MODULES_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ ç¬¬ä¸€æ¬¡æ¨¡å—ç¼–è¯‘å¤±è´¥ï¼ˆä»£ç : $MODULES_EXIT_CODEï¼‰ï¼Œå°è¯•ä¿®å¤..."
            echo "=== åˆ†æé”™è¯¯ä¿¡æ¯ ==="
            grep -E "error:|Error:|ERROR:|è‡´å‘½é”™è¯¯|fatal|No such file" modules_build_attempt1.log | tail -20
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯DVFSRCé©±åŠ¨é—®é¢˜
            if grep -q "drivers/misc/mediatek/dvfsrc" modules_build_attempt1.log || 
               grep -q "DVFSRC" modules_build_attempt1.log ||
               grep -q "dvfsrc" modules_build_attempt1.log; then
                echo "ğŸ”§ æ£€æµ‹åˆ° DVFSRC é©±åŠ¨é—®é¢˜ï¼Œåº”ç”¨ä¿®å¤..."
                
                # æ–¹æ³•1: ç¡®ä¿é…ç½®ä¸­ç¦ç”¨
                echo "CONFIG_MTK_DVFSRC=n" >> .config
                echo "CONFIG_MTK_DVFSRC_MT6768=n" >> .config
                
                # æ–¹æ³•2: å¦‚æœé…ç½®ç¦ç”¨æ— æ•ˆï¼Œç›´æ¥åˆ é™¤æºæ–‡ä»¶ï¼ˆæœ€åæ‰‹æ®µï¼‰
                if [ -d "$DVFSRC_DIR" ]; then
                    echo "ğŸ› ï¸ ç›´æ¥ç¦ç”¨ DVFSRC é©±åŠ¨ç›®å½•..."
                    # åˆ›å»ºç©ºæ–‡ä»¶æ›¿ä»£æºæ–‡ä»¶ï¼Œé¿å…ç¼–è¯‘é”™è¯¯
                    find "$DVFSRC_DIR" -name "*.c" -exec sh -c 'echo "/* æ­¤æ–‡ä»¶å·²ç¦ç”¨ */" > "$1"' _ {} \;
                    find "$DVFSRC_DIR" -name "*.h" -exec sh -c 'echo "/* æ­¤æ–‡ä»¶å·²ç¦ç”¨ */" > "$1"' _ {} \;
                    echo "âœ… DVFSRC é©±åŠ¨æ–‡ä»¶å·²ç¦ç”¨"
                fi
                
                # é‡æ–°ç”Ÿæˆé…ç½®
                yes "" | make oldconfig > /dev/null 2>&1
                
                # ç¬¬äºŒæ¬¡å°è¯•ç¼–è¯‘æ¨¡å—
                echo "ğŸ”„ é‡æ–°å°è¯•ç¼–è¯‘æ¨¡å—..."
                make -j$PARALLEL_JOBS modules 2>&1 | tee modules_build_attempt2.log
                MODULES_EXIT_CODE=${PIPESTATUS[0]}
                
                if [ $MODULES_EXIT_CODE -ne 0 ]; then
                    echo "âš ï¸ ç¬¬äºŒæ¬¡æ¨¡å—ç¼–è¯‘ä»å¤±è´¥ï¼ˆä»£ç : $MODULES_EXIT_CODEï¼‰"
                    echo "=== ç¬¬äºŒæ¬¡ç¼–è¯‘é”™è¯¯ ==="
                    grep -E "error:|Error:|ERROR:|è‡´å‘½é”™è¯¯|fatal" modules_build_attempt2.log | tail -20
                    echo "MODULES_BUILD_FAILED=true" >> $GITHUB_ENV
                else
                    echo "âœ… æ¨¡å—ç¼–è¯‘æˆåŠŸï¼ˆç»è¿‡ä¿®å¤ï¼‰"
                    echo "MODULES_BUILD_FAILED=false" >> $GITHUB_ENV
                fi
            else
                echo "âŒ æœªçŸ¥çš„æ¨¡å—ç¼–è¯‘é”™è¯¯ï¼Œæ— æ³•è‡ªåŠ¨ä¿®å¤"
                echo "MODULES_BUILD_FAILED=true" >> $GITHUB_ENV
            fi
        else
            echo "âœ… æ¨¡å—ç¼–è¯‘æˆåŠŸ"
            echo "MODULES_BUILD_FAILED=false" >> $GITHUB_ENV
        fi
        
        echo "é˜¶æ®µ4: ç¼–è¯‘è®¾å¤‡æ ‘..."
        make -j$PARALLEL_JOBS dtbs 2>/dev/null || echo "âš ï¸ è®¾å¤‡æ ‘ç¼–è¯‘è·³è¿‡"
        
        # åœæ­¢ç›‘æ§
        kill $MONITOR_PID 2>/dev/null || true
        
        END_TIME=$(date +%s)
        COMPILE_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "=== ğŸ ç¼–è¯‘å®Œæˆ ==="
        echo "â±ï¸ æ€»è€—æ—¶: ${COMPILE_TIME}ç§’"
        
        # æ£€æŸ¥ç»“æœ
        IMAGE_FOUND=false
        for img in Image zImage Image.gz; do
          if [ -f arch/$ARCH/boot/$img ]; then
            IMAGE_FOUND=true
            echo "âœ… æˆåŠŸç”Ÿæˆ: arch/$ARCH/boot/$img"
            ls -lh arch/$ARCH/boot/$img
            break
          fi
        done
        
        if $IMAGE_FOUND; then
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°å†…æ ¸é•œåƒ"
          echo "BUILD_STATUS=no_image" >> $GITHUB_ENV
        fi
        
        echo "COMPILE_TIME=$COMPILE_TIME" >> $GITHUB_ENV

    - name: ä¸Šä¼ å†…æ ¸é•œåƒ
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-image
        path: kernel-source/arch/arm64/boot/Image*
        retention-days: 7

    - name: ä¸Šä¼ æ‰€æœ‰å†…æ ¸æ–‡ä»¶
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-all
        path: |
          kernel-source/arch/arm64/boot/
          kernel-source/.config
        retention-days: 7

    - name: ä¸Šä¼ æ¨¡å—ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          kernel-source/modules_build_attempt1.log
          kernel-source/modules_build_attempt2.log
          kernel-source/.disable_problematic_drivers
        retention-days: 3

    - name: æ‰“åŒ…æ¨¡å—
      if: env.BUILD_STATUS == 'success' && env.MODULES_BUILD_FAILED == 'false'
      run: |
        cd kernel-source
        if [ -d lib/modules ]; then
          echo "ğŸ“¦ æ‰“åŒ…å†…æ ¸æ¨¡å—..."
          tar -czf modules.tar.gz lib/modules/
          echo "âœ… æ¨¡å—æ‰“åŒ…å®Œæˆ"
        fi

    - name: ä¸Šä¼ å†…æ ¸æ¨¡å—
      if: env.BUILD_STATUS == 'success' && env.MODULES_BUILD_FAILED == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-modules
        path: kernel-source/modules.tar.gz
        retention-days: 7