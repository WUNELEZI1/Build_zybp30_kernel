name: 编译MT6768内核（修复类型冲突版v21）

on:
  workflow_dispatch:
    inputs:
      config:
        description: '内核配置文件'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  BASE_FIX_VERSION: "20"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 150

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 安装依赖
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi libncurses-dev dwarves curl file
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        sudo apt-get clean

    - name: 克隆源码并修复（最终解决类型冲突）
      run: |
        CURRENT_FIX_VERSION=$(( ${BASE_FIX_VERSION} + 1 ))
        echo "当前修复版本: v${CURRENT_FIX_VERSION}"
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV
        echo "CURRENT_FIX_VERSION=${CURRENT_FIX_VERSION}" >> $GITHUB_ENV
        
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/WUNELEZI1/Gale-Kernel-Source.git \
          kernel-source
        cd kernel-source
        
        echo "=== 应用最终修复（版本：v${CURRENT_FIX_VERSION}） ==="
        
        # -------------------------- 修复1：mt_cpufreq声明重复unsigned问题 --------------------------
        if [ -f "drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.h" ]; then
          # 修复重复unsigned和参数类型，保持与mtk_cpufreq_api.h一致
          sed -i '99s/unsigned unsigned int mt_cpufreq_get_cur_phy_freq_no_lock(int id)/unsigned int mt_cpufreq_get_cur_phy_freq_no_lock(unsigned int cluster_id)/' drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.h
        fi
        
        # -------------------------- 修复2：uclamp_se_set内联函数问题 --------------------------
        if [ -f "kernel/sched/sched.h" ]; then
          sed -i '2370s/inline void uclamp_se_set/void uclamp_se_set/' kernel/sched/sched.h
          sed -i 's/__always_inline//g' kernel/sched/sched.h
          sed -i 's/always_inline//g' kernel/sched/sched.h
        fi
        
        # -------------------------- 修复3：ksm_flock内联函数问题 --------------------------
        if [ -f "include/linux/keyslot-manager.h" ]; then
          sed -i '101s/inline void ksm_flock/void ksm_flock/' include/linux/keyslot-manager.h
          sed -i 's/always_inline //g' include/linux/keyslot-manager.h
        fi
        
        # -------------------------- 修复4：blk_crypto_flock内联问题 --------------------------
        if [ -f "include/linux/blk-crypto.h" ]; then
          sed -i 's/inline void blk_crypto_flock/void blk_crypto_flock/' include/linux/blk-crypto.h
        fi
        
        # -------------------------- 修复5：枚举修复 --------------------------
        if [ -f "drivers/power/supply/mediatek/charger/mtk_charger_intf.h" ]; then
          sed -i '/enum charger_enum {/,/};/d' drivers/power/supply/mediatek/charger/mtk_charger_intf.h
          sed -i '/enum charger_enum/a enum charger_enum {\n    CHARGER_DEV_NOTIFY_VBUS_OVP,\n    CHARGER_DEV_NOTIFY_EOC,\n    CHARGER_DEV_NOTIFY_RECHG,\n    CHARGER_DEV_NOTIFY_SAFETY_TIMEOUT,\n    CHARGER_DEV_NOTIFY_BAT_OVP\n};' drivers/power/supply/mediatek/charger/mtk_charger_intf.h
        fi
        
        # -------------------------- 修复6：mtk_charger.c修复 --------------------------
        if [ -f "drivers/power/supply/mediatek/charger/mtk_charger.c" ]; then
          sed -i '1i#include <linux/of.h>' drivers/power/supply/mediatek/charger/mtk_charger.c
          sed -i '72s/charger_manager/charger_consumer/' drivers/power/supply/mediatek/charger/mtk_charger.c
          sed -i '72s/(const/(struct device *dev, const/' drivers/power/supply/mediatek/charger/mtk_charger.c
          sed -i '73s/charger_manager/charger_consumer/' drivers/power/supply/mediatek/charger/mtk_charger.c
          sed -i '205s/charger_manager/charger_consumer/' drivers/power/supply/mediatek/charger/mtk_charger.c
          sed -i '205s/(const/(struct device *dev, const/' drivers/power/supply/mediatek/charger/mtk_charger.c
          sed -i '206s/charger_manager/charger_consumer/' drivers/power/supply/mediatek/charger/mtk_charger.c
          sed -i '127s/struct of_device_id/__maybe_unused struct of_device_id/' drivers/power/supply/mediatek/charger/mtk_charger.c
          sed -i '128i     { .compatible = "mediatek,mtk-charger" },' drivers/power/supply/mediatek/charger/mtk_charger.c
          sed -i '129i     {}' drivers/power/supply/mediatek/charger/mtk_charger.c
        fi
        
        # -------------------------- 修复7：返回值处理 --------------------------
        if [ -f "drivers/power/supply/mediatek/battery/mtk_battery.c" ]; then
          sed -i '4063s/kstrtoint(/ret = kstrtoint(/' drivers/power/supply/mediatek/battery/mtk_battery.c
          sed -i '4064i         if (ret)' drivers/power/supply/mediatek/battery/mtk_battery.c
          sed -i '4065i             break;' drivers/power/supply/mediatek/battery/mtk_battery.c
        fi
        
        if [ -f "drivers/misc/mediatek/connectivity/wlan/adaptor/fw_log_wifi.c" ]; then
          sed -i '235s/copy_to_user/ret = copy_to_user/' drivers/misc/mediatek/connectivity/wlan/adaptor/fw_log_wifi.c
          sed -i '236i         if (ret)' drivers/misc/mediatek/connectivity/wlan/adaptor/fw_log_wifi.c
          sed -i '237i             return -EFAULT;' drivers/misc/mediatek/connectivity/wlan/adaptor/fw_log_wifi.c
        fi
        
        # -------------------------- 修复8：ccci修复 --------------------------
        if [ -f "drivers/misc/mediatek/ccci_util/ccci_util_lib_sys.c" ]; then
          sed -i '257i         char ft_buf[256];' drivers/misc/mediatek/ccci_util/ccci_util_lib_sys.c
          sed -i '258s/ccci_get_plat_ft_inf/ccci_get_plat_ft_inf(ft_buf, sizeof(ft_buf)) > 0/' drivers/misc/mediatek/ccci_util/ccci_util_lib_sys.c
        fi
        
        # -------------------------- 修复9：camera_dpe.c修复 --------------------------
        if [ -f "drivers/misc/mediatek/cameraisp/dpe/mt6768/camera_dpe.c" ]; then
          sed -i '4708s/$/ {/' drivers/misc/mediatek/cameraisp/dpe/mt6768/camera_dpe.c
          sed -i '4709s/^/    /' drivers/misc/mediatek/cameraisp/dpe/mt6768/camera_dpe.c
          sed -i '4710i }' drivers/misc/mediatek/cameraisp/dpe/mt6768/camera_dpe.c
        fi
        
        # -------------------------- 基础修复 --------------------------
        sed -i 's/, NULL, NULL//g' mm/huge_memory.c 2>/dev/null
        sed -i 's/%d bytes/%zu bytes/g' drivers/misc/mediatek/blocktag/blocktag-core.c 2>/dev/null
        sed -i 's/unsigned int/enum boot_mode_t/g' drivers/input/keyboard/mediatek/mt6768/hal_kpd.c 2>/dev/null
        sed -i 's/ARRAY_SIZE(count_ack)/sizeof(count_ack)/g' drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.c 2>/dev/null
        sed -i 's/ARRAY_SIZE(count_ack)/sizeof(max_load)/g' drivers/misc/mediatek/base/power/cm_mgr_v1/mtk_cm_mgr.c 2>/dev/null
        
        echo "修复完成（版本：v${CURRENT_FIX_VERSION}）"

    - name: 配置内核
      run: |
        cd ${{ env.KERNEL_DIR }}
        rm -rf out && mkdir -p out
        
        make O=out ARCH=${{ env.ARCH }} CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.config }}
        
        ./scripts/config --file out/.config \
          --disable DEBUG_INFO --disable GDB_SCRIPTS --disable DEBUG_KERNEL \
          --disable TRANSPARENT_HUGEPAGE --disable BLK_DEV_CRYPTO \
          --disable CC_STACKPROTECTOR --disable WERROR \
          --disable CONFIG_WARN_UNUSED_RESULT --disable CONFIG_WARN_SWITCH_UNREACHABLE
        
        make O=out ARCH=${{ env.ARCH }} CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

    - name: 编译内核
      run: |
        cd ${{ env.KERNEL_DIR }}
        export ARCH=${{ env.ARCH }}
        export CROSS_COMPILE=aarch64-linux-gnu-
        CORES=$(nproc)
        JOBS=$((CORES + 1))
        
        time make O=out -j$JOBS \
          KCFLAGS="-w -fno-inline-functions" \
          2>&1 | tee 编译日志.log
        
        if [ -f "out/arch/${{ env.ARCH }}/boot/Image.gz" ] || [ -f "out/arch/${{ env.ARCH }}/boot/Image" ]; then
          echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: 检查结果
      run: |
        cd ${{ env.KERNEL_DIR }}
        echo "=== 构建结果 ==="
        
        echo "=== 编译错误汇总（版本：v${{ env.CURRENT_FIX_VERSION }}） ===" > 错误汇总.log
        ERROR_COUNT=$(grep -c "error:" 编译日志.log)
        echo "错误总数：$ERROR_COUNT" >> 错误汇总.log
        if [ $ERROR_COUNT -gt 0 ]; then
          grep -A 3 -B 2 "error:" 编译日志.log | sort -u >> 错误汇总.log
          cat 错误汇总.log
        fi
        
        if [ "${{ env.BUILD_SUCCESS }}" = "true" ]; then
          echo "✅ 内核镜像生成成功（版本：v${{ env.CURRENT_FIX_VERSION }}）"
        else
          echo "❌ 编译失败（版本：v${{ env.CURRENT_FIX_VERSION }}）"
        fi

    - name: 上传产物
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: 内核构建-v${{ env.CURRENT_FIX_VERSION }}-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/${{ env.ARCH }}/boot/
          ${{ env.KERNEL_DIR }}/编译日志.log
          ${{ env.KERNEL_DIR }}/错误汇总.log
          ${{ env.KERNEL_DIR }}/out/.config
        retention-days: 30