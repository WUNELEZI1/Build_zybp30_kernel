name: ğŸš€ MT6768 å†…æ ¸ç¼–è¯‘ (æ€§èƒ½ä¼˜åŒ–ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'å†…æ ¸é…ç½®æ–‡ä»¶'
        required: true
        default: 'k69v1_64_k419_defconfig'
      build_target:
        description: 'ç¼–è¯‘ç›®æ ‡'
        required: true
        default: 'Image.gz-dtb'
        type: choice
        options:
          - Image.gz-dtb
          - Image
          - all
      ccache_enabled:
        description: 'å¯ç”¨CCacheç¼“å­˜'
        required: true
        default: true
        type: boolean
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•° (0=è‡ªåŠ¨)'
        required: true
        default: 0
        type: number

env:
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-
  # æ€§èƒ½ä¼˜åŒ–ç¯å¢ƒå˜é‡
  KCFLAGS: "-O2 -pipe -fno-semantic-interposition -fno-trapping-math"
  KCPPFLAGS: "-O2"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      matrix:
        # å¯ä»¥åŒæ—¶ç¼–è¯‘å¤šä¸ªé…ç½®
        config: [${{ github.event.inputs.defconfig }}]

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        # è®¾ç½®CPUä¼˜åŒ–æ ‡å¿—
        CPU_CORES=$(nproc)
        echo "CPUæ ¸å¿ƒæ•°: $CPU_CORES"
        
        # è®¡ç®—æœ€ä¼˜å¹¶è¡Œä»»åŠ¡æ•°
        if [ "${{ github.event.inputs.parallel_jobs }}" -eq 0 ]; then
          PARALLEL_JOBS=$((CPU_CORES * 2))
        else
          PARALLEL_JOBS=${{ github.event.inputs.parallel_jobs }}
        fi
        echo "PARALLEL_JOBS=$PARALLEL_JOBS" >> $GITHUB_ENV
        echo "ä½¿ç”¨å¹¶è¡Œä»»åŠ¡æ•°: $PARALLEL_JOBS"
        
        # è®¾ç½®ç¼–è¯‘ä¼˜åŒ–
        echo "MAKEFLAGS=-j$PARALLEL_JOBS" >> $GITHUB_ENV

    - name: ç¼“å­˜CCache
      if: github.event.inputs.ccache_enabled == 'true'
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          ccache
        key: ${{ runner.os }}-ccache-${{ hashFiles('**/.ccache/**') }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: å®‰è£…é«˜æ€§èƒ½å·¥å…·é“¾
      run: |
        echo "=== å®‰è£…ä¼˜åŒ–å·¥å…·é“¾ ==="
        sudo apt-get update -y
        
        # åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 python3-pip \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file rsync kmod cpio \
          ccache pahole lz4 zstd
        
        # å®‰è£…æœ€æ–°ç‰ˆGCCå·¥å…·é“¾ï¼ˆå¯é€‰ï¼‰
        # sudo apt-get install -y gcc-11 g++-11 gcc-11-aarch64-linux-gnu
        
        # è®¾ç½®CCache
        if [ "${{ github.event.inputs.ccache_enabled }}" = "true" ]; then
          echo "è®¾ç½®CCache..."
          ccache -M 2G
          ccache -s
          echo "CCACHE_DIR=~/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV
        fi
        
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        
        # æ˜¾ç¤ºå·¥å…·ç‰ˆæœ¬
        echo "=== å·¥å…·ç‰ˆæœ¬ ==="
        aarch64-linux-gnu-gcc --version | head -1
        ccache --version | head -1
        make --version | head -1

    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        echo "=== å…‹éš†å†…æ ¸æºç  ==="
        
        # ä½¿ç”¨å¹¶è¡Œå…‹éš†åŠ é€Ÿ
        git config --global core.preloadIndex true
        git config --global core.fscache true
        git config --global gc.auto 256
        
        if git clone --depth=1 --branch=mt6768-4.19 --jobs=4 \
          https://github.com/WUNELEZI1/Gale-Kernel-Source.git kernel-source; then
          echo "âœ… æºç å…‹éš†æˆåŠŸ"
          echo "KERNEL_SOURCE=kernel-source" >> $GITHUB_ENV
        else
          echo "âŒ å…‹éš†å¤±è´¥"
          exit 1
        fi

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== é…ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        
        # è®¾ç½®æ€§èƒ½ä¼˜åŒ–å‚æ•°
        if [ "${{ github.event.inputs.ccache_enabled }}" = "true" ]; then
          echo 'CC="ccache aarch64-linux-gnu-gcc"' >> $GITHUB_ENV
          echo 'CXX="ccache aarch64-linux-gnu-g++"' >> $GITHUB_ENV
        else
          echo 'CC="aarch64-linux-gnu-gcc"' >> $GITHUB_ENV
          echo 'CXX="aarch64-linux-gnu-g++"' >> $GITHUB_ENV
        fi
        
        # ç¦ç”¨è°ƒè¯•ä¿¡æ¯åŠ é€Ÿç¼–è¯‘
        echo "CONFIG_DEBUG_INFO=n" >> $GITHUB_ENV
        echo "CONFIG_DEBUG_KERNEL=n" >> $GITHUB_ENV
        
        echo "ç¼–è¯‘ç¯å¢ƒé…ç½®å®Œæˆ"

    - name: å¿«é€Ÿé…ç½®å†…æ ¸
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== å¿«é€Ÿå†…æ ¸é…ç½® ==="
        
        # è·³è¿‡æ¸…ç†ï¼Œç›´æ¥é…ç½®
        echo "è·³è¿‡ make mrproper"
        rm -f .config .config.old
        
        # å¿«é€Ÿé…ç½®
        echo "ä½¿ç”¨é…ç½®: ${{ matrix.config }}"
        if ! make ${{ matrix.config }}; then
          echo "âŒ é…ç½®å¤±è´¥ï¼Œå°è¯•é»˜è®¤é…ç½®"
          make defconfig || make allyesconfig
        fi
        
        # ä¼˜åŒ–é…ç½® - ç¦ç”¨è°ƒè¯•å’Œä¸éœ€è¦çš„åŠŸèƒ½
        echo "ä¼˜åŒ–å†…æ ¸é…ç½®..."
        ./scripts/config --file .config \
          --disable DEBUG_INFO \
          --disable GDB_SCRIPTS \
          --disable DEBUG_KERNEL \
          --disable KASAN \
          --disable UBSAN \
          --disable DEBUG_FS \
          --disable PROFILING \
          --disable KCOV
        
        # åº”ç”¨é…ç½®
        make olddefconfig
        
        echo "âœ… é…ç½®å®Œæˆ"

    - name: ç¼–è¯‘å†…æ ¸ (æ€§èƒ½ä¼˜åŒ–)
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== å¼€å§‹é«˜æ€§èƒ½ç¼–è¯‘ ==="
        
        # åˆ›å»ºç¼–è¯‘ç›®å½•
        mkdir -p build_logs
        
        # è®¾ç½®ç¼–è¯‘å¼€å§‹æ—¶é—´
        START_TIME=$(date +%s)
        
        # æ€§èƒ½ç›‘æ§
        echo "å¼€å§‹ç¼–è¯‘: $(date)"
        echo "ç³»ç»Ÿèµ„æº:"
        free -h
        df -h
        
        # ä½¿ç”¨æ€§èƒ½ä¼˜åŒ–ç¼–è¯‘
        set +e
        {
          echo "=== ç¼–è¯‘ç»Ÿè®¡ ==="
          time make -j$PARALLEL_JOBS ${{ github.event.inputs.build_target }} \
            CC="$CC" \
            CXX="$CXX" \
            KCFLAGS="$KCFLAGS -Wno-error" \
            KCPPFLAGS="$KCPPFLAGS" \
            2>&1
        } | tee build_logs/full_build.log
        
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        # è®¡ç®—ç¼–è¯‘æ—¶é—´
        END_TIME=$(date +%s)
        COMPILE_TIME=$((END_TIME - START_TIME))
        echo "COMPILE_TIME=$COMPILE_TIME" >> $GITHUB_ENV
        
        # åˆ†æç»“æœ
        ERROR_COUNT=$(grep -c "error:" build_logs/full_build.log || true)
        WARNING_COUNT=$(grep -c "warning:" build_logs/full_build.log || true)
        
        echo "ç¼–è¯‘æ—¶é—´: ${COMPILE_TIME}ç§’"
        echo "é”™è¯¯æ•°é‡: $ERROR_COUNT"
        echo "è­¦å‘Šæ•°é‡: $WARNING_COUNT"
        
        # æ£€æŸ¥ç»“æœ
        if [ $BUILD_EXIT_CODE -eq 0 ] && ls arch/$ARCH/boot/Image* >/dev/null 2>&1; then
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
        else
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV
          echo "âŒ ç¼–è¯‘å¤±è´¥"
        fi
        
        echo "ERROR_COUNT=$ERROR_COUNT" >> $GITHUB_ENV

    - name: æ€§èƒ½åˆ†æå’ŒæŠ¥å‘Š
      if: always()
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== æ€§èƒ½åˆ†ææŠ¥å‘Š ===" > performance_report.md
        
        # ç¼–è¯‘æ—¶é—´ç»Ÿè®¡
        echo "**ç¼–è¯‘æ—¶é—´:** ${COMPILE_TIME}ç§’" >> performance_report.md
        echo "**å¹¶è¡Œä»»åŠ¡:** $PARALLEL_JOBS" >> performance_report.md
        echo "**CCacheçŠ¶æ€:** ${{ github.event.inputs.ccache_enabled }}" >> performance_report.md
        
        # CCacheç»Ÿè®¡
        if [ "${{ github.event.inputs.ccache_enabled }}" = "true" ]; then
          echo "" >> performance_report.md
          echo "**CCacheç»Ÿè®¡:**" >> performance_report.md
          ccache -s >> performance_report.md
        fi
        
        # é”™è¯¯ç»Ÿè®¡
        echo "" >> performance_report.md
        echo "**ç¼–è¯‘ç»Ÿè®¡:**" >> performance_report.md
        echo "- é”™è¯¯: $ERROR_COUNT" >> performance_report.md
        echo "- è­¦å‘Š: $WARNING_COUNT" >> performance_report.md
        
        # ç”Ÿæˆæ–‡ä»¶ä¿¡æ¯
        if [ "$BUILD_STATUS" = "success" ]; then
          echo "" >> performance_report.md
          echo "**ç”Ÿæˆæ–‡ä»¶:**" >> performance_report.md
          for file in arch/$ARCH/boot/Image*; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "- $(basename "$file") ($size)" >> performance_report.md
            fi
          done
        fi
        
        cat performance_report.md

    - name: ä¸Šä¼ å†…æ ¸é•œåƒ
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-images-${{ matrix.config }}
        path: |
          ${{ env.KERNEL_SOURCE }}/arch/arm64/boot/
        compression-level: 0  # ä¸å‹ç¼©ï¼ŒåŠ å¿«ä¸Šä¼ 
        retention-days: 30

    - name: ä¸Šä¼ ç¼–è¯‘æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-reports-${{ matrix.config }}
        path: |
          ${{ env.KERNEL_SOURCE }}/build_logs/
          ${{ env.KERNEL_SOURCE }}/performance_report.md
          ${{ env.KERNEL_SOURCE }}/.config
        retention-days: 7

    - name: æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
      if: always()
      run: |
        echo "=== ğŸš€ ç¼–è¯‘ä¼˜åŒ–ç»“æœ ==="
        echo "çŠ¶æ€: $BUILD_STATUS"
        echo "æ—¶é—´: ${COMPILE_TIME}ç§’"
        echo "é…ç½®: ${{ matrix.config }}"
        echo "å¹¶è¡Œ: $PARALLEL_JOBS ä»»åŠ¡"
        echo "CCache: ${{ github.event.inputs.ccache_enabled }}"
        
        if [ "$BUILD_STATUS" = "success" ]; then
          echo "ğŸ‰ é«˜æ€§èƒ½ç¼–è¯‘å®Œæˆ!"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi