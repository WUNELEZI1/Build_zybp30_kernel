name: Build MT6768 Kernel with Source Fixes

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python2.7 python2.7-dev \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree patch
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix kernel source code issues
      run: |
        cd $KERNEL_DIR
        echo "=== ç»¼åˆä¿®å¤å†…æ ¸æºç é—®é¢˜ ==="
        
        # 1. ä¿®å¤ try_to_unmap å‚æ•°é—®é¢˜
        echo "ä¿®å¤ try_to_unmap å‡½æ•°è°ƒç”¨..."
        find . -name "*.c" -type f -exec grep -l "try_to_unmap(" {} \; | head -20 | while read file; do
          echo "å¤„ç†æ–‡ä»¶: $file"
          # ä¸ºåªæœ‰ä¸€ä¸ªå‚æ•°çš„ try_to_unmap è°ƒç”¨æ·»åŠ ç¬¬äºŒä¸ªå‚æ•°
          sed -i 's/try_to_unmap([[:space:]]*\([^,)]*\)[[:space:]]*)/try_to_unmap(\1, 0)/g' "$file"
          sed -i 's/try_to_unmap([[:space:]]*\([^,)]*\)[[:space:]]*);/try_to_unmap(\1, 0);/g' "$file"
        done
        
        # 2. ä¿®å¤å…¶ä»–å¸¸è§ç¼–è¯‘é—®é¢˜
        echo "ä¿®å¤å…¶ä»–å¸¸è§ç¼–è¯‘é—®é¢˜..."
        
        # ç¦ç”¨å¯èƒ½å¯¼è‡´é—®é¢˜çš„é…ç½®
        if [ -f "arch/arm64/configs/${{ github.event.inputs.DEFCONFIG }}" ]; then
          cp "arch/arm64/configs/${{ github.event.inputs.DEFCONFIG }}" .config
        else
          echo "ä½¿ç”¨é»˜è®¤é…ç½®"
          make ARCH=arm64 defconfig
        fi
        
        # é€šè¿‡ scripts/config ç¦ç”¨é—®é¢˜é…ç½®
        ./scripts/config --set-str CONFIG_SYSTEM_TRUSTED_KEYS ""
        ./scripts/config --set-str CONFIG_SYSTEM_REVOCATION_KEYS ""
        ./scripts/config --disable DEBUG_INFO
        ./scripts/config --disable DEBUG_KERNEL
        
        echo "âœ… æºç ä¿®å¤å®Œæˆ"

    - name: Build kernel with fixes
      run: |
        cd $KERNEL_DIR
        echo "=== ä½¿ç”¨ä¿®å¤åçš„æºç ç¼–è¯‘å†…æ ¸ ==="
        
        # åº”ç”¨é…ç½®æ›´æ”¹
        make ARCH=arm64 olddefconfig
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # ç¼–è¯‘å†…æ ¸
        echo "å¼€å§‹ç¼–è¯‘å†…æ ¸..."
        time make -j$(($(nproc) * 2)) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          KCFLAGS="-Wno-error -Wno-format -Wno-memset-elt-size" \
          2>&1 | tee build.log

    - name: Check and package results
      run: |
        cd $KERNEL_DIR
        echo "=== æ£€æŸ¥æ„å»ºç»“æœ ==="
        
        if [ -f "arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸï¼"
          echo "ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la arch/arm64/boot/Image.gz
          echo "å¤§å°: $(du -h arch/arm64/boot/Image.gz | cut -f1)"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯"
          # æ˜¾ç¤ºæœ€åçš„é”™è¯¯
          if [ -f "build.log" ]; then
            echo "æœ€åçš„é”™è¯¯:"
            grep "error:" build.log | tail -5
          fi
        fi

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-built-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/arch/arm64/boot/Image.gz
          ${{ env.KERNEL_DIR }}/build.log
        retention-days: 30