name: Build MT6768 Kernel (Final Fix)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python2.7 python2.7-dev \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix kernel configuration issues
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤å†…æ ¸é…ç½®é—®é¢˜ ==="
        
        # æ¸…ç†
        rm -rf out
        mkdir -p out
        
        # å…³é”®ä¿®å¤ï¼šä½¿ç”¨ç³»ç»Ÿ GCC è¿›è¡Œé…ç½®é˜¶æ®µ
        echo "ä½¿ç”¨ç³»ç»Ÿ GCC è¿›è¡Œé…ç½®..."
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }} && {
          echo "âœ… é…ç½®æˆåŠŸ"
        } || {
          echo "âŒ ç‰¹å®šé…ç½®å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€é…ç½®"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        }
        
        # ä¿®å¤ Kconfig å†²çª
        echo "ä¿®å¤ Kconfig ç±»å‹é‡å®šä¹‰å†²çª..."
        # ç¦ç”¨æœ‰å†²çªçš„é…ç½®
        ./scripts/config --file out/.config -d CHARGER_BQ25890
        ./scripts/config --file out/.config -d MTK_CMDQ
        ./scripts/config --file out/.config -d MTK_QOS_FRAMEWORK
        ./scripts/config --file out/.config -d TOUCHSCREEN_GOODIX_BRL
        
        # ç¦ç”¨å·²çŸ¥æœ‰é—®é¢˜çš„é©±åŠ¨
        ./scripts/config --file out/.config -d ACCDET_MT6358
        ./scripts/config --file out/.config -d MTK_SENSORS_1_0
        ./scripts/config --file out/.config -d INPUT_FINGERPRINT
        ./scripts/config --file out/.config -d MEDIATEX_EXTCON
        
        # æ›´æ–°é…ç½®
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

    - name: Setup compilation environment
      run: |
        echo "=== è®¾ç½®ç¼–è¯‘ç¯å¢ƒ ==="
        
        # æ–¹æ¡ˆ1ï¼šä½¿ç”¨ç³»ç»Ÿ GCC å·¥å…·é“¾ï¼ˆæ¨èï¼‰
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
        echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
        
        # éªŒè¯å·¥å…·é“¾
        echo "éªŒè¯ GCC å·¥å…·é“¾:"
        aarch64-linux-gnu-gcc --version || echo "GCC ä¸å¯ç”¨"

    - name: Build kernel with GCC
      run: |
        cd $KERNEL_DIR
        
        if [ ! -f "out/.config" ]; then
          echo "âŒ æ²¡æœ‰é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        echo "=== ä½¿ç”¨ GCC å·¥å…·é“¾ç¼–è¯‘å†…æ ¸ ==="
        echo "ä½¿ç”¨çš„å·¥å…·é“¾:"
        echo "CC: $CC"
        echo "CROSS_COMPILE: $CROSS_COMPILE"
        echo "ARCH: $ARCH"
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "é…ç½®æ‘˜è¦:"
        grep -E "CONFIG_LOCALVERSION|CONFIG_ARM64|CONFIG_CPU" out/.config | head -10
        
        echo "å¼€å§‹ç¼–è¯‘..."
        time make O=out ARCH=arm64 -j$(($(nproc)/2)) \
          CROSS_COMPILE="$CROSS_COMPILE" \
          2>&1 | tee build.log

    - name: Check build results
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºç»“æœæ£€æŸ¥ ==="
        
        if [ -f "build.log" ]; then
          echo "æ„å»ºæ—¥å¿—: $(wc -l < build.log) è¡Œ"
          echo "é”™è¯¯ç»Ÿè®¡: $(grep -c "error:" build.log || echo 0)"
          echo "è­¦å‘Šç»Ÿè®¡: $(grep -c "warning:" build.log || echo 0)"
          
          # æ£€æŸ¥å…³é”®é”™è¯¯
          if grep -q "error:" build.log; then
            echo "å…³é”®é”™è¯¯:"
            grep "error:" build.log | tail -10
          fi
        fi
        
        # è¯¦ç»†æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        echo "=== è¾“å‡ºæ–‡ä»¶è¯¦ç»†æ£€æŸ¥ ==="
        echo "1. æœç´¢å†…æ ¸é•œåƒ:"
        find out/ -name "Image*" -o -name "vmlinux*" -o -name "*.gz" -o -name "*.img" 2>/dev/null | while read f; do
          echo "   âœ… $f ($(du -h "$f" 2>/dev/null | cut -f1 || echo 'æœªçŸ¥'))"
        done || echo "   æœªæ‰¾åˆ°å†…æ ¸é•œåƒ"
        
        echo "2. out ç›®å½•ç»“æ„:"
        find out/ -type f -name "*" 2>/dev/null | head -30 || echo "   out ç›®å½•ä¸ºç©º"
        
        echo "3. æ£€æŸ¥ç¼–è¯‘çŠ¶æ€:"
        if find out/ -name "vmlinux" 2>/dev/null | grep -q .; then
          echo "   âœ… vmlinux å·²ç”Ÿæˆ"
          vmlinux_path=$(find out/ -name "vmlinux" | head -1)
          echo "   è·¯å¾„: $vmlinux_path"
          file "$vmlinux_path" 2>/dev/null || echo "   æ— æ³•åˆ†ææ–‡ä»¶"
        else
          echo "   âŒ vmlinux æœªç”Ÿæˆ"
        fi

    - name: Generate kernel image if needed
      if: failure()
      run: |
        cd $KERNEL_DIR
        echo "=== å°è¯•æ‰‹åŠ¨ç”Ÿæˆå†…æ ¸é•œåƒ ==="
        
        # å¦‚æœç¼–è¯‘å¤±è´¥ä½†æœ‰ vmlinuxï¼Œå°è¯•æ‰‹åŠ¨ç”Ÿæˆ Image
        if [ -f "out/vmlinux" ]; then
          echo "æ‰¾åˆ° vmlinuxï¼Œå°è¯•ç”Ÿæˆ Image..."
          mkdir -p out/arch/arm64/boot
          aarch64-linux-gnu-objcopy -O binary -R .note -R .comment -S out/vmlinux out/arch/arm64/boot/Image 2>/dev/null && {
            echo "âœ… æˆåŠŸç”Ÿæˆ Image"
            gzip -k out/arch/arm64/boot/Image
            echo "âœ… ç”Ÿæˆ Image.gz"
            ls -lh out/arch/arm64/boot/Image.gz
          } || echo "æ— æ³•ç”Ÿæˆ Image"
        else
          echo "æ²¡æœ‰ vmlinuxï¼Œæ— æ³•æ‰‹åŠ¨ç”Ÿæˆå†…æ ¸é•œåƒ"
        fi

    - name: Upload kernel artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-final-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/out/vmlinux
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-final-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/build.log
          ${{ env.KERNEL_DIR }}/out/.config
        retention-days: 15

    - name: Final success message
      if: success()
      run: |
        cd $KERNEL_DIR
        echo "ğŸ‰ ğŸ‰ ğŸ‰ å†…æ ¸ç¼–è¯‘å®Œæˆï¼"
        echo "ç”Ÿæˆçš„æ–‡ä»¶:"
        find out/ -name "Image*" -o -name "vmlinux*" -o -name "*.gz" -o -name "*.img" 2>/dev/null | while read f; do
          echo "   ğŸ“„ $f ($(du -h "$f" 2>/dev/null | cut -f1))"
        done
        echo ""
        echo "ä¸‹ä¸€æ­¥:"
        echo "1. ä¸‹è½½ Artifacts ä¸­çš„ kernel-final-*"
        echo "2. ä½¿ç”¨ Image.gz åˆ·å…¥è®¾å¤‡"
        echo "3. å¦‚æœåˆ·å…¥å¤±è´¥ï¼Œæ£€æŸ¥ build-logs-final-* ä¸­çš„é”™è¯¯ä¿¡æ¯"