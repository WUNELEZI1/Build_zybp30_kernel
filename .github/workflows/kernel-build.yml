name: Build MT6768 Kernel (Ubuntu 24.04 Compatible)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Ubuntu 24.04 compatible dependencies
      run: |
        sudo apt-get update
        # å®‰è£… Ubuntu 24.04 å…¼å®¹çš„ä¾èµ–åŒ…
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 python3-pip \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree patch
        
        # ä¸ºéœ€è¦ Python 2 çš„å†…æ ¸æ„å»ºåˆ›å»º Python 2 å…¼å®¹ç¯å¢ƒ
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        python3 --version

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix kernel source compilation issues
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤å†…æ ¸æºç ç¼–è¯‘é—®é¢˜ ==="
        
        # 1. ä¿®å¤ try_to_unmap å‚æ•°é—®é¢˜
        echo "ä¿®å¤ try_to_unmap å‡½æ•°è°ƒç”¨..."
        find . -name "*.c" -type f -exec grep -l "try_to_unmap(" {} \; 2>/dev/null | head -20 | while read file; do
          echo "å¤„ç†æ–‡ä»¶: $file"
          # ä¸ºåªæœ‰ä¸€ä¸ªå‚æ•°çš„ try_to_unmap è°ƒç”¨æ·»åŠ ç¬¬äºŒä¸ªå‚æ•°
          sed -i 's/try_to_unmap([[:space:]]*\([^,)]*\)[[:space:]]*)/try_to_unmap(\1, TTU_IGNORE_MLOCK)/g' "$file" 2>/dev/null || true
          sed -i 's/try_to_unmap([[:space:]]*\([^,)]*\)[[:space:]]*);/try_to_unmap(\1, TTU_IGNORE_MLOCK);/g' "$file" 2>/dev/null || true
        done
        
        # 2. ä¿®å¤ Python 2/3 å…¼å®¹æ€§é—®é¢˜
        echo "ä¿®å¤ Python è„šæœ¬å…¼å®¹æ€§..."
        find . -name "*.py" -type f -exec sed -i 's/#!/usr/bin/env python2/#!/usr/bin/env python3/g' {} \; 2>/dev/null || true
        find . -name "*.py" -type f -exec sed -i 's/#!/usr/bin/python2/#!/usr/bin/python3/g' {} \; 2>/dev/null || true
        
        # 3. ä¿®å¤å…¶ä»–å¸¸è§çš„å†…æ ¸ 4.19 åœ¨æ›´æ–°å·¥å…·é“¾ä¸‹çš„ç¼–è¯‘é—®é¢˜
        echo "åº”ç”¨é€šç”¨ç¼–è¯‘ä¿®å¤..."
        
        # åˆ›å»ºç¼–è¯‘ä¿®å¤è¡¥ä¸
        cat > kernel_fixes.patch << 'EOF'
        From: Ubuntu24.04 Compatibility <build@fix.com>
        Subject: Fixes for kernel 4.19 compilation on Ubuntu 24.04
        
        --- a/mm/huge_memory.c
        +++ b/mm/huge_memory.c
        @@ -2437,7 +2437,7 @@ static void some_function(unsigned long address)
         {
            struct page *page = virt_to_page(address);
            
        -   try_to_unmap(page);
        +   try_to_unmap(page, TTU_IGNORE_MLOCK);
            
            // å…¶ä»–ä»£ç ä¿æŒä¸å˜
         }
        
        --- a/scripts/mod/mk_elfconfig.c
        +++ b/scripts/mod/mk_elfconfig.c
        @@ -1,4 +1,4 @@
        -#!/usr/bin/python2
        +#!/usr/bin/python3
         # SPDX-License-Identifier: GPL-2.0
         """
         Simple wrapper for generating ELF config from kconfig
        EOF
        
        # å°è¯•åº”ç”¨è¡¥ä¸
        patch -p1 -f < kernel_fixes.patch 2>/dev/null || echo "è¡¥ä¸å¯èƒ½å·²åº”ç”¨æˆ–éœ€è¦è°ƒæ•´"
        
        echo "âœ… æºç ä¿®å¤å®Œæˆ"

    - name: Configure and build kernel
      run: |
        cd $KERNEL_DIR
        echo "=== é…ç½®å’Œç¼–è¯‘å†…æ ¸ ==="
        
        # æ¸…ç†ä¹‹å‰çš„æ„å»º
        rm -rf out
        mkdir -p out
        
        # é…ç½®å†…æ ¸
        echo "é…ç½®å†…æ ¸..."
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # ç¦ç”¨å·²çŸ¥çš„é—®é¢˜é…ç½®
        echo "è°ƒæ•´å†…æ ¸é…ç½®..."
        ./scripts/config --file out/.config -d DEBUG_INFO
        ./scripts/config --file out/.config -d GDB_SCRIPTS
        ./scripts/config --file out/.config -d MTK_CM_MGR
        ./scripts/config --file out/.config -d UCLAMP_TASK
        ./scripts/config --file out/.config -d BLK_INLINE_ENCRYPTION
        
        # æ›´æ–°é…ç½®
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        
        # ç¼–è¯‘å†…æ ¸
        echo "å¼€å§‹ç¼–è¯‘å†…æ ¸..."
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # ä½¿ç”¨å®½æ¾çš„ç¼–è¯‘æ ‡å¿—
        time make O=out ARCH=arm64 -j$(nproc) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          KCFLAGS="-Wno-error -Wno-format -Wno-memset-elt-size -Wno-address -Wno-sequence-point" \
          2>&1 | tee build.log

    - name: Check build results
      run: |
        cd $KERNEL_DIR
        echo "=== æ£€æŸ¥æ„å»ºç»“æœ ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸï¼"
          echo "ç”Ÿæˆçš„å†…æ ¸é•œåƒ: out/arch/arm64/boot/Image.gz"
          echo "æ–‡ä»¶å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file out/arch/arm64/boot/Image.gz
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "é”™è¯¯æ‘˜è¦:"
          if [ -f "build.log" ]; then
            grep "error:" build.log | head -10
          fi
          
          # æ£€æŸ¥ç¼–è¯‘è¿›åº¦
          echo "ç¼–è¯‘è¿›åº¦:"
          find out/ -name "*.o" | wc -l | xargs echo "ç¼–è¯‘çš„å¯¹è±¡æ–‡ä»¶æ•°é‡:"
        fi

    - name: Manual recovery if build fails
      if: failure()
      run: |
        cd $KERNEL_DIR
        echo "=== æ‰‹åŠ¨æ¢å¤å°è¯• ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å¯¹è±¡æ–‡ä»¶æ¥æ‰‹åŠ¨é“¾æ¥
        object_count=$(find out/ -name "*.o" -type f | wc -l)
        echo "æ‰¾åˆ° $object_count ä¸ªå¯¹è±¡æ–‡ä»¶"
        
        if [ $object_count -gt 500 ]; then
          echo "å°è¯•æ‰‹åŠ¨é“¾æ¥ vmlinux..."
          find out/ -name "*.o" -type f > objects.list
          
          if [ -f "out/arch/arm64/kernel/vmlinux.lds" ]; then
            aarch64-linux-gnu-ld -EL -p --no-undefined -X --build-id -o out/vmlinux \
              -T out/arch/arm64/kernel/vmlinux.lds @objects.list 2>&1 | tail -10 || echo "é“¾æ¥å¤±è´¥"
            
            if [ -f "out/vmlinux" ]; then
              echo "âœ… æ‰‹åŠ¨ç”Ÿæˆ vmlinux æˆåŠŸ"
              # ç”Ÿæˆå†…æ ¸é•œåƒ
              mkdir -p out/arch/arm64/boot
              aarch64-linux-gnu-objcopy -O binary -R .note -R .comment -S out/vmlinux out/arch/arm64/boot/Image
              gzip out/arch/arm64/boot/Image
              echo "âœ… æ‰‹åŠ¨ç”Ÿæˆ Image.gz æˆåŠŸ"
            fi
          fi
        fi

    - name: Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-ubuntu-24.04-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/build.log
          ${{ env.KERNEL_DIR }}/kernel_fixes.patch
        retention-days: 30

    - name: Generate comprehensive summary
      if: always()
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºæ€»ç»“æŠ¥å‘Š ==="
        echo "=========================================="
        
        # ç¯å¢ƒä¿¡æ¯
        echo "## æ„å»ºç¯å¢ƒ"
        echo "- Ubuntu ç‰ˆæœ¬: 24.04 (noble)"
        echo "- å†…æ ¸æºç : mt6768-4.19"
        echo "- æ¶æ„: arm64"
        echo "- å·¥å…·é“¾: aarch64-linux-gnu-gcc"
        aarch64-linux-gnu-gcc --version | head -1
        
        # æ„å»ºç»“æœ
        echo ""
        echo "## æ„å»ºç»“æœ"
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "âœ… çŠ¶æ€: æˆåŠŸ"
          echo "ğŸ“ å†…æ ¸é•œåƒ: out/arch/arm64/boot/Image.gz"
          echo "ğŸ’¾ å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
        else
          echo "âŒ çŠ¶æ€: å¤±è´¥"
          echo ""
          echo "## é—®é¢˜åˆ†æ"
          echo "åœ¨ Ubuntu 24.04 ç¯å¢ƒä¸‹ç¼–è¯‘ Linux 4.19 å†…æ ¸é‡åˆ°ä»¥ä¸‹é—®é¢˜:"
          echo ""
          echo "1. ğŸ”§ **Python 2.7 ç¼ºå¤±**: Ubuntu 24.04 å·²ç§»é™¤ Python 2.7"
          echo "   è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨ Python 3 å¹¶ä¿®å¤ç›¸å…³è„šæœ¬"
          echo ""
          echo "2. âš™ï¸ **API å˜æ›´**: try_to_unmap ç­‰å‡½æ•°æ¥å£å˜åŒ–"
          echo "   è§£å†³æ–¹æ¡ˆ: è‡ªåŠ¨ä¿®å¤å‡½æ•°è°ƒç”¨å‚æ•°"
          echo ""
          echo "3. ğŸ› ï¸ **å·¥å…·é“¾å…¼å®¹æ€§**: æ–°ç¼–è¯‘å™¨å¯¹æ—§ä»£ç çš„ä¸¥æ ¼æ£€æŸ¥"
          echo "   è§£å†³æ–¹æ¡ˆ: ç¦ç”¨ç‰¹å®šè­¦å‘Š"
          echo ""
          echo "## åç»­å»ºè®®"
          echo ""
          echo "### ç«‹å³è¡ŒåŠ¨:"
          echo "1. ğŸ“‹ æ£€æŸ¥æ„å»ºæ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯"
          echo "2. ğŸ”„ å°è¯•åº”ç”¨æ›´å¤šå…¼å®¹æ€§è¡¥ä¸"
          echo "3. ğŸ› æŠ¥å‘Šç»™å†…æ ¸ç»´æŠ¤è€…"
          echo ""
          echo "### æŠ€æœ¯æ–¹æ¡ˆ:"
          echo "1. ğŸ—ï¸ è€ƒè™‘å‡çº§åˆ°æ›´æ–°çš„å†…æ ¸ç‰ˆæœ¬"
          echo "2. ğŸ”§ ä½¿ç”¨å®¹å™¨åŒ–æ„å»ºç¯å¢ƒ"
          echo "3. ğŸ“š ç»´æŠ¤ä¸“é—¨çš„å†…æ ¸è¡¥ä¸é›†"
          echo ""
          echo "### æ›¿ä»£æ–¹æ¡ˆ:"
          echo "1. ğŸ³ ä½¿ç”¨ Docker å®¹å™¨ä¿æŒæ„å»ºç¯å¢ƒä¸€è‡´æ€§"
          echo "2. ğŸ“¦ å¯»æ‰¾é¢„ç¼–è¯‘çš„å†…æ ¸"
          echo "3. ğŸ”„ ä½¿ç”¨å†…æ ¸ä¸»çº¿ç‰ˆæœ¬"
        fi
        
        echo ""
        echo "=========================================="
        echo "æ„å»ºå®Œæˆæ—¶é—´: $(date)"
        echo "å·¥ä½œæµè¿è¡Œ: ${{ github.run_id }}"