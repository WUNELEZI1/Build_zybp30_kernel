name: Build MT6768 Kernel (Self-Maintained)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree patch
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix kernel compilation issues
      run: |
        cd $KERNEL_DIR
        echo "=== 修复内核编译问题 ==="
        
        # 修复 try_to_unmap 参数问题
        if [ -f "mm/huge_memory.c" ]; then
          echo "修复 mm/huge_memory.c..."
          sed -i 's/try_to_unmap(page)/try_to_unmap(page, 0)/g' mm/huge_memory.c
        fi
        
        # 修复格式字符串问题
        if [ -f "drivers/misc/mediatek/blocktag/blocktag-core.c" ]; then
          echo "修复 blocktag-core.c..."
          sed -i 's/"%s %d %d"/"%s %zu %zu"/g' drivers/misc/mediatek/blocktag/blocktag-core.c
        fi
        
        # 修复 thermal cooling 问题
        if [ -f "drivers/thermal/cpu_cooling.c" ]; then
          echo "修复 cpu_cooling.c..."
          sed -i 's/^int cpufreq_platform_cooling_register/static int cpufreq_platform_cooling_register/g' drivers/thermal/cpu_cooling.c
        fi

    - name: Configure kernel
      run: |
        cd $KERNEL_DIR
        echo "=== 配置内核 ==="
        
        rm -rf out
        mkdir -p out
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # 禁用问题配置
        ./scripts/config --file out/.config -d DEBUG_INFO
        ./scripts/config --file out/.config -d GDB_SCRIPTS
        ./scripts/config --file out/.config -d MTK_CM_MGR
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        echo "=== 编译内核 ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        time make O=out ARCH=arm64 -j$(nproc) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          KCFLAGS="-Wno-error -Wno-format -Wno-memset-elt-size" \
          2>&1 | tee build.log

    - name: Check build results
      run: |
        cd $KERNEL_DIR
        echo "=== 检查构建结果 ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "✅ 内核编译成功!"
          echo "文件: out/arch/arm64/boot/Image.gz"
          echo "大小: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
        else
          echo "❌ 编译失败"
          echo "错误摘要:"
          grep "error:" build.log | head -5 || echo "无错误信息"
        fi

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/build.log
        retention-days: 30

    - name: Create build summary
      if: always()
      run: |
        echo "=== 构建完成 ==="
        echo "工作流运行完成，请下载 Artifacts 查看结果"