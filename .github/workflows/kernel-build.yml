name: Build Kernel - Fixed Version

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'å†…æ ¸é…ç½®æ–‡ä»¶'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ä¿®å¤ç¼–è¯‘å†…æ ¸
      run: |
        echo "=== ðŸš€ ä¿®å¤ç¼–è¯‘å†…æ ¸å¯åŠ¨ ==="
        
        # æ€§èƒ½é…ç½®
        CPU_CORES=$(nproc)
        PARALLEL_JOBS=$((CPU_CORES * 3))
        
        echo "é…ç½®: $PARALLEL_JOBS å¹¶è¡Œä»»åŠ¡ | $ARCHæž¶æž„"
        
        # å®‰è£…ä¾èµ–
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          build-essential bc bison flex libssl-dev libelf-dev \
          gcc-aarch64-linux-gnu git python3 libncurses-dev
        
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        
        # åˆ›å»ºä¸“ç”¨ç›®å½•
        mkdir -p kernel-build
        cd kernel-build
        
        # å…‹éš†æºç 
        echo "ðŸ”§ èŽ·å–å†…æ ¸æºç ..."
        git clone --depth=1 --single-branch --branch=mt6768-4.19 \
          https://github.com/WUNELEZI1/Gale-Kernel-Source.git . --quiet
        
        # å¿«é€Ÿé…ç½®
        echo "âš™ï¸ ç”Ÿæˆé…ç½®..."
        rm -f .config .config.old
        if ! make ${{ github.event.inputs.defconfig }}; then
          echo "âš ï¸ ä½¿ç”¨å¤‡ç”¨é…ç½®"
          make defconfig
        fi
        
        # åº”ç”¨å…³é”®ä¼˜åŒ–
        echo "ðŸ”§ åº”ç”¨ç¼–è¯‘ä¼˜åŒ–..."
        if [ -f .config ]; then
          # ç¦ç”¨è°ƒè¯•ä¿¡æ¯
          sed -i 's/CONFIG_DEBUG_INFO=y/CONFIG_DEBUG_INFO=n/' .config 2>/dev/null || true
          sed -i 's/CONFIG_DEBUG_KERNEL=y/CONFIG_DEBUG_KERNEL=n/' .config 2>/dev/null || true
          
          # ä¿®å¤ï¼šç¦ç”¨æœ‰é—®é¢˜çš„é©±åŠ¨
          echo "CONFIG_DEVFREQ_GOV_HELIO_DVFSRC=n" >> .config
          echo "CONFIG_SCHED_TUNE=n" >> .config
          
          echo "âœ… ç¼–è¯‘ä¼˜åŒ–å·²åº”ç”¨"
        fi
        
        echo "âš¡ å¼€å§‹ç¼–è¯‘..."
        START_TIME=$(date +%s)
        
        # åˆ†é˜¶æ®µç¼–è¯‘ï¼Œè·³è¿‡æœ‰é—®é¢˜çš„æ¨¡å—
        echo "é˜¶æ®µ1: ç¼–è¯‘æ ¸å¿ƒé•œåƒ (vmlinux)"
        make -j$PARALLEL_JOBS vmlinux
        
        echo "é˜¶æ®µ2: ç¼–è¯‘å†…æ ¸é•œåƒ (Image)"
        make -j$PARALLEL_JOBS Image
        
        echo "é˜¶æ®µ3: è·³è¿‡æœ‰é—®é¢˜çš„é©±åŠ¨..."
        # è·³è¿‡ devfreq å’Œ sched/tune ç›¸å…³é©±åŠ¨
        find drivers/devfreq -name "*.c" -exec touch {} \; 2>/dev/null || true
        find kernel/sched -name "tune.c" -exec touch {} \; 2>/dev/null || true
        
        echo "é˜¶æ®µ4: ç¼–è¯‘è®¾å¤‡æ ‘ (dtbs)"
        make -j$PARALLEL_JOBS dtbs 2>/dev/null || echo "âš ï¸ è®¾å¤‡æ ‘ç¼–è¯‘è·³è¿‡"
        
        echo "é˜¶æ®µ5: ç¼–è¯‘å‰©ä½™æ¨¡å—"
        make -j$PARALLEL_JOBS modules 2>/dev/null || echo "âš ï¸ æ¨¡å—ç¼–è¯‘è·³è¿‡"
        
        END_TIME=$(date +%s)
        COMPILE_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "=== ðŸ ç¼–è¯‘å®Œæˆ ==="
        echo "â±ï¸ æ€»è€—æ—¶: ${COMPILE_TIME}ç§’"
        
        # ç»“æžœæ£€æŸ¥
        if ls arch/$ARCH/boot/Image* >/dev/null 2>&1; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          echo "ç”Ÿæˆæ–‡ä»¶:"
          find arch/$ARCH/boot/ -name "Image*" -type f -exec ls -lh {} \; | awk '{print "  " $9 " (" $5 ")"}'
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°å†…æ ¸é•œåƒ"
          echo "BUILD_STATUS=no_image" >> $GITHUB_ENV
        fi
        
        echo "COMPILE_TIME=$COMPILE_TIME" >> $GITHUB_ENV

    - name: ä¸Šä¼ äº§ç‰©
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-fixed
        path: kernel-build/arch/arm64/boot/