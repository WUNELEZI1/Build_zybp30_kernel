name: Build MT6768 Kernel (Uclamp Fix)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python2.7 python2.7-dev \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix uclamp compilation error
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤ uclamp ç¼–è¯‘é”™è¯¯ ==="
        
        # æ¸…ç†
        rm -rf out
        mkdir -p out
        
        # ä½¿ç”¨ç³»ç»Ÿ GCC è¿›è¡Œé…ç½®
        echo "é…ç½®å†…æ ¸..."
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }} && {
          echo "âœ… é…ç½®æˆåŠŸ"
        } || {
          echo "âŒ ç‰¹å®šé…ç½®å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€é…ç½®"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        }
        
        # ä¿®å¤é…ç½®é—®é¢˜
        echo "åº”ç”¨ä¿®å¤..."
        
        # ç¦ç”¨ UCLAMP åŠŸèƒ½ï¼ˆå¯¼è‡´ç¼–è¯‘é”™è¯¯çš„æ ¹æºï¼‰
        ./scripts/config --file out/.config -d UCLAMP_TASK
        ./scripts/config --file out/.config -d SCHED_TUNE
        
        # ç¦ç”¨å…¶ä»–å¯èƒ½æœ‰é—®é¢˜çš„é…ç½®
        ./scripts/config --file out/.config -d CHARGER_BQ25890
        ./scripts/config --file out/.config -d MTK_CMDQ
        ./scripts/config --file out/.config -d MTK_QOS_FRAMEWORK
        ./scripts/config --file out/.config -d TOUCHSCREEN_GOODIX_BRL
        ./scripts/config --file out/.config -d ACCDET_MT6358
        ./scripts/config --file out/.config -d MTK_SENSORS_1_0
        ./scripts/config --file out/.config -d INPUT_FINGERPRINT
        ./scripts/config --file out/.config -d MEDIATEX_EXTCON
        
        # æ›´æ–°é…ç½®
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        
        echo "ä¿®å¤åçš„é…ç½®æ‘˜è¦:"
        grep -E "UCLAMP|SCHED_TUNE" out/.config || echo "ç›¸å…³é…ç½®å·²ç¦ç”¨"

    - name: Build with uclamp fix
      run: |
        cd $KERNEL_DIR
        
        if [ ! -f "out/.config" ]; then
          echo "âŒ æ²¡æœ‰é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        echo "=== ä½¿ç”¨ä¿®å¤åçš„é…ç½®ç¼–è¯‘ ==="
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "å¼€å§‹ç¼–è¯‘..."
        time make O=out ARCH=arm64 -j$(($(nproc)/2)) \
          CROSS_COMPILE="$CROSS_COMPILE" \
          2>&1 | tee build.log

    - name: Check compilation results
      run: |
        cd $KERNEL_DIR
        echo "=== ç¼–è¯‘ç»“æœæ£€æŸ¥ ==="
        
        # æ£€æŸ¥ç¼–è¯‘æ—¥å¿—
        if [ -f "build.log" ]; then
          echo "æ„å»ºæ—¥å¿—: $(wc -l < build.log) è¡Œ"
          echo "é”™è¯¯: $(grep -c "error:" build.log || echo 0)"
          echo "è­¦å‘Š: $(grep -c "warning:" build.log || echo 0)"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„é”™è¯¯
          if grep -q "error:" build.log; then
            echo "æ–°é”™è¯¯:"
            grep "error:" build.log | tail -5
          else
            echo "âœ… æ— ç¼–è¯‘é”™è¯¯"
          fi
        fi
        
        # è¯¦ç»†æ£€æŸ¥è¾“å‡º
        echo "=== å†…æ ¸æ–‡ä»¶æ£€æŸ¥ ==="
        
        # æ£€æŸ¥ vmlinux
        if [ -f "out/vmlinux" ]; then
          echo "ğŸ‰ âœ… vmlinux å·²ç”Ÿæˆ!"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file out/vmlinux
          echo "å¤§å°: $(du -h out/vmlinux | cut -f1)"
        else
          echo "âŒ vmlinux æœªç”Ÿæˆ"
        fi
        
        # æ£€æŸ¥ Image.gz
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ âœ… Image.gz å·²ç”Ÿæˆ!"
          echo "å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
        else
          echo "âŒ Image.gz æœªç”Ÿæˆ"
        fi
        
        # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
        echo "=== æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ ==="
        find out/ -type f \( -name "vmlinux*" -o -name "Image*" -o -name "*.gz" -o -name "*.img" \) 2>/dev/null | while read f; do
          echo "ğŸ“„ $f ($(du -h "$f" 2>/dev/null | cut -f1))"
        done || echo "æ— å†…æ ¸æ–‡ä»¶"

    - name: Manual kernel image generation
      if: failure()
      run: |
        cd $KERNEL_DIR
        echo "=== æ‰‹åŠ¨ç”Ÿæˆå†…æ ¸é•œåƒ ==="
        
        # å¦‚æœç¼–è¯‘å¤±è´¥ä½†æœ‰å¯¹è±¡æ–‡ä»¶ï¼Œå°è¯•æ‰‹åŠ¨é“¾æ¥
        if find out/ -name "*.o" | head -1 | grep -q .; then
          echo "æ‰¾åˆ°å¯¹è±¡æ–‡ä»¶ï¼Œå°è¯•æ‰‹åŠ¨ç”Ÿæˆå†…æ ¸..."
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p out/arch/arm64/boot
          
          # å°è¯•æ‰‹åŠ¨ç”Ÿæˆ Image
          echo "å°è¯•ç”Ÿæˆæœªå‹ç¼©çš„å†…æ ¸é•œåƒ..."
          aarch64-linux-gnu-ld -EL -p --no-undefined -X --build-id -o out/vmlinux -T out/arch/arm64/kernel/vmlinux.lds \
            $(find out/ -name "*.o" | head -20) 2>/dev/null && {
            echo "âœ… æ‰‹åŠ¨ç”Ÿæˆ vmlinux æˆåŠŸ"
            
            # ç”Ÿæˆ Image
            aarch64-linux-gnu-objcopy -O binary -R .note -R .comment -S out/vmlinux out/arch/arm64/boot/Image 2>/dev/null && {
              echo "âœ… ç”Ÿæˆ Image æˆåŠŸ"
              gzip -k out/arch/arm64/boot/Image
              echo "âœ… ç”Ÿæˆ Image.gz æˆåŠŸ"
              ls -lh out/arch/arm64/boot/Image.gz
            } || echo "æ— æ³•ç”Ÿæˆ Image"
          } || echo "æ‰‹åŠ¨é“¾æ¥å¤±è´¥"
        else
          echo "æ²¡æœ‰å¯¹è±¡æ–‡ä»¶ï¼Œæ— æ³•æ‰‹åŠ¨ç”Ÿæˆå†…æ ¸"
        fi

    - name: Upload successful kernel
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-uclamp-fixed-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/out/vmlinux
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-uclamp-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/build.log
          ${{ env.KERNEL_DIR }}/out/.config
        retention-days: 15

    - name: Final summary
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºæ€»ç»“ ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ ğŸ‰ ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸï¼"
          echo "å¯ç”¨çš„å†…æ ¸é•œåƒ:"
          ls -lh out/arch/arm64/boot/Image.gz
          echo ""
          echo "ä¸‹ä¸€æ­¥:"
          echo "1. ä¸‹è½½ Artifacts ä¸­çš„ kernel-uclamp-fixed-*"
          echo "2. ä½¿ç”¨ Image.gz åˆ·å…¥è®¾å¤‡"
          echo "3. æµ‹è¯•å†…æ ¸åŠŸèƒ½"
        elif [ -f "out/vmlinux" ]; then
          echo "âš ï¸ ç”Ÿæˆäº† vmlinux ä½†æœªå‹ç¼©"
          echo "å¯ä»¥æ‰‹åŠ¨å‹ç¼©: gzip -c out/vmlinux > Image.gz"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "è¯·æ£€æŸ¥ build-logs-uclamp-* ä¸­çš„é”™è¯¯ä¿¡æ¯"
        fi