name: Build MT6768 Kernel (Fixed Syntax)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 python3-pip \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree patch
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix kernel source compilation
      run: |
        cd $KERNEL_DIR
        echo "=== 修复内核源码编译问题 ==="
        
        # 修复 try_to_unmap 参数问题
        echo "修复 try_to_unmap 函数调用..."
        if [ -f "mm/huge_memory.c" ]; then
          # 显示错误位置
          echo "错误位置代码:"
          sed -n '2435,2445p' mm/huge_memory.c
          
          # 精确修复
          sed -i '2440s/try_to_unmap(page)/try_to_unmap(page, 0)/' mm/huge_memory.c
          echo "修复后的代码:"
          sed -n '2435,2445p' mm/huge_memory.c
        fi
        
        # 修复所有 try_to_unmap 调用
        find . -name "*.c" -type f -exec grep -l "try_to_unmap(" {} \; 2>/dev/null | while read file; do
          echo "修复文件: $file"
          sed -i 's/try_to_unmap([[:space:]]*\([^,)]*\)[[:space:]]*)/try_to_unmap(\1, 0)/g' "$file"
          sed -i 's/try_to_unmap([[:space:]]*\([^,)]*\)[[:space:]]*);/try_to_unmap(\1, 0);/g' "$file"
        done

    - name: Configure kernel
      run: |
        cd $KERNEL_DIR
        echo "=== 配置内核 ==="
        
        rm -rf out
        mkdir -p out
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
        
        # 禁用问题配置
        ./scripts/config --file out/.config -d DEBUG_INFO
        ./scripts/config --file out/.config -d GDB_SCRIPTS
        ./scripts/config --file out/.config -d MTK_CM_MGR
        ./scripts/config --file out/.config -d BLK_INLINE_ENCRYPTION
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        echo "=== 编译内核 ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        time make O=out ARCH=arm64 -j$(nproc) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          KCFLAGS="-Wno-error -Wno-format -Wno-memset-elt-size" \
          2>&1 | tee build.log

    - name: Check build results
      run: |
        cd $KERNEL_DIR
        echo "=== 检查构建结果 ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "✅ 内核编译成功!"
          echo "文件: out/arch/arm64/boot/Image.gz"
          echo "大小: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
        else
          echo "❌ 编译失败"
          echo "错误摘要:"
          grep "error:" build.log | head -5 || echo "无错误信息"
        fi

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/
          ${{ env.KERNEL_DIR }}/build.log
        retention-days: 30