name: Build MT6768 Kernel

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'å†…æ ¸é…ç½®æ–‡ä»¶'
        required: true
        default: 'k69v1_64_k419_defconfig'
      build_target:
        description: 'ç¼–è¯‘ç›®æ ‡'
        required: true
        default: 'Image.gz-dtb'

env:
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: æ£€å‡ºå½“å‰ä»“åº“
      uses: actions/checkout@v4

    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        echo "=== å…‹éš†å†…æ ¸æºç  ==="
        git clone --depth=1 --branch=mt6768-4.19 https://github.com/WUNELEZI1/Gale-Kernel-Source.git kernel-source
        echo "KERNEL_SOURCE=kernel-source" >> $GITHUB_ENV

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi libncurses-dev dwarves curl file \
          rsync kmod cpio
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== ç¯å¢ƒä¿¡æ¯ ==="
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "æ¶æ„: $ARCH"
        echo "é…ç½®æ–‡ä»¶: ${{ github.event.inputs.defconfig }}"
        
        # æ˜¾ç¤ºå¯ç”¨çš„é…ç½®æ–‡ä»¶
        echo "å¯ç”¨çš„é…ç½®:"
        find arch/arm64/configs -name "*defconfig" | head -10 || echo "æ— é…ç½®"

    - name: æ‰‹åŠ¨æ¸…ç†å’Œé…ç½®
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== æ‰‹åŠ¨é…ç½® ==="
        
        # å®Œå…¨è·³è¿‡ make mrproperï¼Œæ‰‹åŠ¨æ¸…ç†
        echo "æ‰‹åŠ¨æ¸…ç†é…ç½®..."
        rm -f .config .config.old
        
        # ç›´æ¥é…ç½®å†…æ ¸
        echo "ä½¿ç”¨é…ç½®: ${{ github.event.inputs.defconfig }}"
        if make ${{ github.event.inputs.defconfig }}; then
          echo "âœ… é…ç½®æˆåŠŸ"
        else
          echo "âŒ é…ç½®å¤±è´¥ï¼Œå°è¯•é»˜è®¤é…ç½®"
          if ! make defconfig; then
            echo "âš ï¸ ä½¿ç”¨æœ€å°é…ç½®"
            echo "CONFIG_ARM64=y" > .config
            make olddefconfig
          fi
        fi

    - name: ç¼–è¯‘å†…æ ¸
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== å¼€å§‹ç¼–è¯‘ ==="
        
        CORES=$(nproc)
        JOBS=$((CORES + 1))
        echo "ä½¿ç”¨ $JOBS ä¸ªä»»åŠ¡ç¼–è¯‘"
        
        # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
        touch build.log
        
        # å¼€å§‹ç¼–è¯‘
        set +e
        time make -j$JOBS ${{ github.event.inputs.build_target }} 2>&1 | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        # åˆ†æç»“æœ
        ERROR_COUNT=$(grep -c "error:" build.log || true)
        WARNING_COUNT=$(grep -c "warning:" build.log || true)
        
        echo "é€€å‡ºç : $BUILD_EXIT_CODE"
        echo "é”™è¯¯: $ERROR_COUNT"
        echo "è­¦å‘Š: $WARNING_COUNT"
        
        # æ£€æŸ¥ç»“æœ
        if [ $BUILD_EXIT_CODE -eq 0 ] && [ -f "arch/$ARCH/boot/Image.gz-dtb" ]; then
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
        else
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV
          echo "âŒ ç¼–è¯‘å¤±è´¥"
        fi
        
        echo "ERROR_COUNT=$ERROR_COUNT" >> $GITHUB_ENV

    - name: ç”Ÿæˆé”™è¯¯æŠ¥å‘Š
      if: env.BUILD_STATUS == 'failed'
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== é”™è¯¯æŠ¥å‘Š ===" > errors.txt
        grep -A 2 -B 1 "error:" build.log | head -30 >> errors.txt
        echo "=== å®Œæ•´æ—¥å¿—å·²ä¿å­˜ ===" >> errors.txt
        cat errors.txt

    - name: ä¸Šä¼ äº§ç‰©
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-images
        path: ${{ env.KERNEL_SOURCE }}/arch/arm64/boot/

    - name: ä¸Šä¼ æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ${{ env.KERNEL_SOURCE }}/build.log
          ${{ env.KERNEL_SOURCE }}/errors.txt
          ${{ env.KERNEL_SOURCE }}/.config

    - name: æ˜¾ç¤ºç»“æœ
      if: always()
      run: |
        cd ${{ env.KERNEL_SOURCE }}
        echo "=== æœ€ç»ˆç»“æœ ==="
        echo "çŠ¶æ€: $BUILD_STATUS"
        echo "é”™è¯¯: $ERROR_COUNT"
        
        if [ "$BUILD_STATUS" = "success" ]; then
          echo "ğŸ‰ æˆåŠŸ!"
          ls -la arch/arm64/boot/
        else
          echo "âŒ å¤±è´¥"
          if [ -f "errors.txt" ]; then
            echo "ä¸»è¦é”™è¯¯:"
            head -10 errors.txt
          fi
        fi