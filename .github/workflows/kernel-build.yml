name: Build MT6768 Kernel (Self-Maintained)

on:
  workflow_dispatch:
    inputs:
      DEFCONFIG:
        description: 'Kernel defconfig'
        required: true
        default: 'k69v1_64_k419_defconfig'

env:
  ARCH: arm64
  SUBARCH: arm64

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          git wget unzip python3 \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev dwarves curl file tree patch
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=mt6768-4.19 \
          https://github.com/NullableIsBellable/Gale-Kernel-Source.git \
          kernel-source
        echo "KERNEL_DIR=$(pwd)/kernel-source" >> $GITHUB_ENV

    - name: Fix kernel compilation issues
      run: |
        cd $KERNEL_DIR
        echo "=== ä¿®å¤å†…æ ¸ç¼–è¯‘é—®é¢˜ ==="
        
        # ä¿®å¤ try_to_unmap å‚æ•°é—®é¢˜ - è¿™æ˜¯ä¸»è¦ä¿®å¤
        if [ -f "mm/huge_memory.c" ]; then
          echo "ä¿®å¤ mm/huge_memory.c ä¸­çš„ try_to_unmap è°ƒç”¨..."
          sed -i 's/try_to_unmap(page, ttu_flags, NULL, NULL);/try_to_unmap(page, ttu_flags);/g' mm/huge_memory.c
          echo "ä¿®å¤åçš„ä»£ç :"
          grep -A2 -B2 "try_to_unmap(page, ttu_flags)" mm/huge_memory.c || true
        fi

    - name: Configure kernel
      run: |
        cd $KERNEL_DIR
        echo "=== é…ç½®å†…æ ¸ ==="
        
        rm -rf out
        mkdir -p out
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ github.event.inputs.DEFCONFIG }}
        
        # ç¦ç”¨é—®é¢˜é…ç½®
        ./scripts/config --file out/.config \
          --disable DEBUG_INFO \
          --disable GDB_SCRIPTS \
          --disable DEBUG_KERNEL
        
        make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

    - name: Stage 1 - Build core components
      run: |
        cd $KERNEL_DIR
        echo "=== é˜¶æ®µ 1: ç¼–è¯‘æ ¸å¿ƒç»„ä»¶ ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # é¦–å…ˆç¼–è¯‘åŸºç¡€ç»„ä»¶
        echo "1. ç¼–è¯‘åŸºç¡€å·¥å…·å’Œå¤´æ–‡ä»¶..."
        make O=out ARCH=arm64 -j1 scripts prepare 2>&1 | tee stage1_build.log || echo "åŸºç¡€å·¥å…·ç¼–è¯‘å®Œæˆ"
        
        # ç¼–è¯‘æœ‰é—®é¢˜çš„ mm ç»„ä»¶
        echo "2. ç¼–è¯‘å†…å­˜ç®¡ç†ç»„ä»¶ (mm)..."
        if make O=out ARCH=arm64 -j1 mm/ 2>&1 | tee -a stage1_build.log; then
          echo "âœ… mm ç»„ä»¶ç¼–è¯‘æˆåŠŸ"
          echo "STAGE1_PASSED=true" >> $GITHUB_ENV
        else
          echo "âŒ mm ç»„ä»¶ç¼–è¯‘å¤±è´¥"
          echo "é”™è¯¯è¯¦æƒ…:"
          grep -i "error:" stage1_build.log | head -10
          echo "STAGE1_PASSED=false" >> $GITHUB_ENV
          exit 1
        fi
        
        # ç¼–è¯‘å…¶ä»–å…³é”®ç»„ä»¶
        echo "3. ç¼–è¯‘å†…æ ¸æ ¸å¿ƒ..."
        if make O=out ARCH=arm64 -j1 kernel/ mm/ fs/ ipc/ 2>&1 | tee -a stage1_build.log; then
          echo "âœ… æ ¸å¿ƒç»„ä»¶ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ æ ¸å¿ƒç»„ä»¶ç¼–è¯‘å¤±è´¥"
          grep -i "error:" stage1_build.log | tail -10
          exit 1
        fi

    - name: Stage 2 - Build architecture specific
      if: env.STAGE1_PASSED == 'true'
      run: |
        cd $KERNEL_DIR
        echo "=== é˜¶æ®µ 2: ç¼–è¯‘æ¶æ„ç›¸å…³ç»„ä»¶ ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "1. ç¼–è¯‘ ARM64 æ¶æ„ä»£ç ..."
        if make O=out ARCH=arm64 -j2 arch/arm64/ 2>&1 | tee stage2_build.log; then
          echo "âœ… ARM64 æ¶æ„ç¼–è¯‘æˆåŠŸ"
          echo "STAGE2_PASSED=true" >> $GITHUB_ENV
        else
          echo "âŒ ARM64 æ¶æ„ç¼–è¯‘å¤±è´¥"
          grep -i "error:" stage2_build.log | head -10
          echo "STAGE2_PASSED=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Stage 3 - Build drivers
      if: env.STAGE2_PASSED == 'true'
      run: |
        cd $KERNEL_DIR
        echo "=== é˜¶æ®µ 3: ç¼–è¯‘é©±åŠ¨ç¨‹åº ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "1. ç¼–è¯‘æ ¸å¿ƒé©±åŠ¨ç¨‹åº..."
        # å…ˆç¼–è¯‘ä¸€äº›å…³é”®é©±åŠ¨
        if make O=out ARCH=arm64 -j$(nproc) drivers/base/ drivers/char/ drivers/clk/ 2>&1 | tee stage3_build.log; then
          echo "âœ… æ ¸å¿ƒé©±åŠ¨ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ æ ¸å¿ƒé©±åŠ¨ç¼–è¯‘å¤±è´¥"
          grep -i "error:" stage3_build.log | head -10
          exit 1
        fi
        
        echo "2. ç¼–è¯‘ Mediatek é©±åŠ¨..."
        if make O=out ARCH=arm64 -j$(nproc) drivers/misc/mediatek/ 2>&1 | tee -a stage3_build.log; then
          echo "âœ… Mediatek é©±åŠ¨ç¼–è¯‘æˆåŠŸ"
        else
          echo "âš ï¸  Mediatek é©±åŠ¨ç¼–è¯‘æœ‰è­¦å‘Šï¼Œç»§ç»­..."
          # ä¸é€€å‡ºï¼Œå› ä¸ºæœ‰äº›è­¦å‘Šå¯èƒ½ä¸å½±å“æœ€ç»ˆæ„å»º
        fi

    - name: Stage 4 - Full kernel build
      if: env.STAGE2_PASSED == 'true'
      run: |
        cd $KERNEL_DIR
        echo "=== é˜¶æ®µ 4: å®Œæ•´å†…æ ¸ç¼–è¯‘ ==="
        
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "å¼€å§‹å®Œæ•´ç¼–è¯‘..."
        time make O=out ARCH=arm64 -j$(($(nproc) + 1)) \
          CROSS_COMPILE="aarch64-linux-gnu-" \
          KCFLAGS="-Wno-error -Wno-format -Wno-memset-elt-size -Wno-address-of-packed-member" \
          2>&1 | tee full_build.log
        
        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥ç»“æœ..."

    - name: Check final build results
      run: |
        cd $KERNEL_DIR
        echo "=== æ£€æŸ¥æœ€ç»ˆæ„å»ºç»“æœ ==="
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ!"
          echo "æ–‡ä»¶: out/arch/arm64/boot/Image.gz"
          echo "å¤§å°: $(du -h out/arch/arm64/boot/Image.gz | cut -f1)"
          echo "å…¶ä»–ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la out/arch/arm64/boot/ || echo "æ— æ³•åˆ—å‡ºæ–‡ä»¶"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "å„é˜¶æ®µçŠ¶æ€:"
          echo "é˜¶æ®µ1 (æ ¸å¿ƒç»„ä»¶): ${{ env.STAGE1_PASSED || 'æœªå®Œæˆ' }}"
          echo "é˜¶æ®µ2 (æ¶æ„ç»„ä»¶): ${{ env.STAGE2_PASSED || 'æœªå®Œæˆ' }}"
          echo "é”™è¯¯æ‘˜è¦:"
          if [ -f "full_build.log" ]; then
            grep -i "error:" full_build.log | head -10
          elif [ -f "stage3_build.log" ]; then
            grep -i "error:" stage3_build.log | head -10
          elif [ -f "stage2_build.log" ]; then
            grep -i "error:" stage2_build.log | head -10
          elif [ -f "stage1_build.log" ]; then
            grep -i "error:" stage1_build.log | head -10
          fi
          exit 1
        fi

    - name: Upload kernel artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-image-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          ${{ env.KERNEL_DIR }}/stage1_build.log
          ${{ env.KERNEL_DIR }}/stage2_build.log
          ${{ env.KERNEL_DIR }}/stage3_build.log
          ${{ env.KERNEL_DIR }}/full_build.log
        retention-days: 30

    - name: Create build summary
      if: always()
      run: |
        cd $KERNEL_DIR
        echo "=== æ„å»ºå®ŒæˆæŠ¥å‘Š ==="
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸ!"
          echo ""
          echo "ğŸ“Š æ„å»ºé˜¶æ®µçŠ¶æ€:"
          echo "  âœ… é˜¶æ®µ1: æ ¸å¿ƒç»„ä»¶ - å®Œæˆ"
          echo "  âœ… é˜¶æ®µ2: æ¶æ„ç»„ä»¶ - å®Œæˆ" 
          echo "  âœ… é˜¶æ®µ3: é©±åŠ¨ç¨‹åº - å®Œæˆ"
          echo "  âœ… é˜¶æ®µ4: å®Œæ•´ç¼–è¯‘ - å®Œæˆ"
          echo ""
          echo "ğŸ“¦ äº§ç‰©: out/arch/arm64/boot/Image.gz ($(du -h out/arch/arm64/boot/Image.gz | cut -f1))"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo ""
          echo "ğŸ“Š å¤±è´¥é˜¶æ®µ:"
          echo "  é˜¶æ®µ1 (æ ¸å¿ƒç»„ä»¶): ${{ env.STAGE1_PASSED || 'å¤±è´¥' }}"
          echo "  é˜¶æ®µ2 (æ¶æ„ç»„ä»¶): ${{ env.STAGE2_PASSED || 'å¤±è´¥' }}"
          echo ""
          echo "ğŸ”§ å»ºè®®:"
          echo "  1. ä¸‹è½½ build-logs Artifact æŸ¥çœ‹è¯¦ç»†é”™è¯¯"
          echo "  2. æ£€æŸ¥ try_to_unmap ä¿®å¤æ˜¯å¦æ­£ç¡®åº”ç”¨"
          echo "  3. å¯èƒ½éœ€è¦ä¿®å¤å…¶ä»–å†…æ ¸APIå…¼å®¹æ€§é—®é¢˜"
        fi