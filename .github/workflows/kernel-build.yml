name: Build MediaTek Kernel

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'å†…æ ¸é…ç½®æ–‡ä»¶'
        required: true
        default: 'k69v1_64_k419_defconfig'
      kernel_branch:
        description: 'å†…æ ¸åˆ†æ”¯'
        required: true
        default: 'master'
        type: choice
        options:
          - master
          - kernel-4.19
          - kernel-4.14

env:
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ç¼–è¯‘ MediaTek å®˜æ–¹å†…æ ¸
      run: |
        echo "=== ğŸš€ ç¼–è¯‘ MediaTek å®˜æ–¹å†…æ ¸ ==="
        
        # æ€§èƒ½é…ç½®
        CPU_CORES=$(nproc)
        PARALLEL_JOBS=$((CPU_CORES * 2))
        
        echo "é…ç½®: $PARALLEL_JOBS å¹¶è¡Œä»»åŠ¡ | $ARCHæ¶æ„"
        echo "æºç : MediaTek-Labs/common-kernel-4.19"
        echo "åˆ†æ”¯: ${{ github.event.inputs.kernel_branch }}"
        
        # å®‰è£…ä¾èµ–
        echo "ğŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·..."
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          build-essential bc bison flex libssl-dev libelf-dev \
          gcc-aarch64-linux-gnu git python3 libncurses-dev \
          dwarves rsync kmod cpio
        
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        
        # å…‹éš†å®˜æ–¹å†…æ ¸æºç 
        echo "ğŸ”§ è·å– MediaTek å®˜æ–¹å†…æ ¸æºç ..."
        git clone --depth=1 --single-branch --branch=${{ github.event.inputs.kernel_branch }} \
          https://github.com/MediaTek-Labs/common-kernel-4.19.git kernel-source --quiet
        
        cd kernel-source
        
        # æ¸…ç†å’Œé…ç½®
        echo "âš™ï¸ é…ç½®å†…æ ¸..."
        rm -f .config .config.old
        
        # ä½¿ç”¨æŒ‡å®šé…ç½®æˆ–é»˜è®¤é…ç½®
        if make ${{ github.event.inputs.defconfig }} 2>/dev/null; then
          echo "âœ… ä½¿ç”¨é…ç½®: ${{ github.event.inputs.defconfig }}"
        else
          echo "âš ï¸ ä½¿ç”¨é»˜è®¤é…ç½®"
          make defconfig
        fi
        
        # ä¼˜åŒ–é…ç½®ï¼ˆå¯é€‰ï¼‰
        echo "ğŸ”§ ä¼˜åŒ–é…ç½®..."
        {
          echo "# ç¼–è¯‘ä¼˜åŒ–"
          echo "CONFIG_DEBUG_INFO=n"
          echo "CONFIG_DEBUG_KERNEL=n"
          echo "CONFIG_GDB_SCRIPTS=n"
        } >> .config
        
        # é‡æ–°ç”Ÿæˆé…ç½®
        yes "" | make oldconfig > /dev/null 2>&1
        
        # å¼€å§‹ç¼–è¯‘
        echo "âš¡ å¼€å§‹ç¼–è¯‘..."
        START_TIME=$(date +%s)
        
        # ç¼–è¯‘è¿›åº¦ç›‘æ§
        (
          echo "ğŸ“Š ç¼–è¯‘è¿›åº¦ç›‘æ§..."
          while true; do
            if ps aux | grep -v grep | grep -q "make.*-j"; then
              COMPILED_FILES=$(find . -name "*.o" -type f 2>/dev/null | wc -l)
              TOTAL_FILES=$(find . -name "*.c" -type f 2>/dev/null | wc -l)
              if [ $TOTAL_FILES -gt 0 ]; then
                PERCENT=$((COMPILED_FILES * 100 / TOTAL_FILES))
                echo "[$(date +%H:%M:%S)] è¿›åº¦: $PERCENT% ($COMPILED_FILES/$TOTAL_FILES)"
              fi
            else
              break
            fi
            sleep 30
          done
        ) &
        MONITOR_PID=$!
        
        # åˆ†é˜¶æ®µç¼–è¯‘
        echo "é˜¶æ®µ1: ç¼–è¯‘ vmlinux..."
        make -j$PARALLEL_JOBS vmlinux
        
        echo "é˜¶æ®µ2: ç¼–è¯‘ Image..."
        make -j$PARALLEL_JOBS Image
        
        echo "é˜¶æ®µ3: ç¼–è¯‘æ¨¡å—..."
        make -j$PARALLEL_JOBS modules 2>/dev/null || echo "âš ï¸ æ¨¡å—ç¼–è¯‘è·³è¿‡"
        
        echo "é˜¶æ®µ4: ç¼–è¯‘è®¾å¤‡æ ‘..."
        make -j$PARALLEL_JOBS dtbs 2>/dev/null || echo "âš ï¸ è®¾å¤‡æ ‘ç¼–è¯‘è·³è¿‡"
        
        # åœæ­¢ç›‘æ§
        kill $MONITOR_PID 2>/dev/null || true
        
        END_TIME=$(date +%s)
        COMPILE_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "=== ğŸ ç¼–è¯‘å®Œæˆ ==="
        echo "â±ï¸ æ€»è€—æ—¶: ${COMPILE_TIME}ç§’"
        
        # æ£€æŸ¥ç»“æœ
        IMAGE_FOUND=false
        for img in Image zImage Image.gz; do
          if [ -f arch/$ARCH/boot/$img ]; then
            IMAGE_FOUND=true
            echo "âœ… æˆåŠŸç”Ÿæˆ: arch/$ARCH/boot/$img"
            ls -lh arch/$ARCH/boot/$img
            break
          fi
        done
        
        if $IMAGE_FOUND; then
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°å†…æ ¸é•œåƒ"
          echo "BUILD_STATUS=no_image" >> $GITHUB_ENV
        fi
        
        echo "COMPILE_TIME=$COMPILE_TIME" >> $GITHUB_ENV

    - name: ä¸Šä¼ å†…æ ¸é•œåƒ
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-image
        path: kernel-source/arch/arm64/boot/Image*
        retention-days: 7

    - name: ä¸Šä¼ æ‰€æœ‰å†…æ ¸æ–‡ä»¶
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-all
        path: |
          kernel-source/arch/arm64/boot/
          kernel-source/.config
        retention-days: 7

    - name: ä¸Šä¼ æ¨¡å—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-modules
        path: kernel-source/modules.tar.gz
        retention-days: 7

    - name: æ‰“åŒ…æ¨¡å—
      if: env.BUILD_STATUS == 'success'
      run: |
        cd kernel-source
        if [ -d lib/modules ]; then
          echo "ğŸ“¦ æ‰“åŒ…å†…æ ¸æ¨¡å—..."
          tar -czf modules.tar.gz lib/modules/
          echo "âœ… æ¨¡å—æ‰“åŒ…å®Œæˆ"
        fi