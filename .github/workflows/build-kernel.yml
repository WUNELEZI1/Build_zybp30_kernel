name: Build MT6768 Android Kernel

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'å®Œå…¨æ¸…ç†æ„å»º'
        required: false
        default: true
        type: boolean

env:
  # æ ¸å¿ƒé…ç½®
  KERNEL_SOURCE: "https://github.com/NullableIsBellable/Gale-Kernel-Source.git"
  KERNEL_BRANCH: "mt6768-4.19"
  NDK_VERSION: "r23c"
  DEFCONFIG: "k69v1_64_k419_defconfig"
  
  # æ„å»ºå‚æ•°
  ARCH: "arm64"
  COMPILE_JOBS: 4  # ä¿å®ˆçš„å¹¶è¡Œç¼–è¯‘ä»»åŠ¡æ•°ï¼Œæé«˜ç¨³å®šæ€§

jobs:
  build:
    name: ç¼–è¯‘MT6768å†…æ ¸
    runs-on: ubuntu-20.04
    
    steps:
    - name: æ£€å‡ºå·¥ä½œæµä»“åº“
      uses: actions/checkout@v4
      
    - name: è®°å½•æ„å»ºä¿¡æ¯
      run: |
        echo "=== å†…æ ¸æ„å»ºä¿¡æ¯ ==="
        echo "è®¾å¤‡: MT6768"
        echo "Androidç‰ˆæœ¬: 12"
        echo "å†…æ ¸ç‰ˆæœ¬: 4.19.191"
        echo "Defconfig: $DEFCONFIG"
        echo "æ¶æ„: $ARCH"
        echo "Ubuntuç‰ˆæœ¬: $(lsb_release -d | cut -f2)"
        echo "å¼€å§‹æ—¶é—´: $(date)"
        echo "===================="

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        # åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt-get install -y build-essential bc ccache
        # å†…æ ¸ç¼–è¯‘å¿…éœ€
        sudo apt-get install -y bison flex libssl-dev libelf-dev
        # é…ç½®å·¥å…·
        sudo apt-get install -y libncurses-dev pkg-config
        # äº¤å‰ç¼–è¯‘å·¥å…·
        sudo apt-get install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi
        # å…¶ä»–å·¥å…·
        sudo apt-get install -y python2 python3 git wget curl zip unzip
        # ä¸ºæ—§å†…æ ¸å¯èƒ½éœ€è¦çš„å…¼å®¹æ€§åŒ…
        sudo apt-get install -y dwarves libssl1.1
        
        # åˆ›å»ºpython2ç¬¦å·é“¾æ¥ï¼ˆéƒ¨åˆ†æ—§æ„å»ºè„šæœ¬éœ€è¦ï¼‰
        if ! command -v python2 &> /dev/null; then
          sudo ln -sf /usr/bin/python2.7 /usr/bin/python2 || true
        fi
        
        echo "ä¾èµ–å®‰è£…å®Œæˆ"

    - name: é…ç½®ccacheç¼“å­˜
      uses: actions/cache@v3
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-kernel-${{ hashFiles('**/.github/workflows/*.yml') }}
        restore-keys: |
          ${{ runner.os }}-ccache-kernel-

    - name: è®¾ç½®ccache
      run: |
        ccache -M 2G
        ccache -s
        echo "CCACHE_DIR=~/.ccache" >> $GITHUB_ENV

    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        echo "æ­£åœ¨å…‹éš†å†…æ ¸æºç ..."
        git clone --depth=1 --branch=$KERNEL_BRANCH $KERNEL_SOURCE kernel-source
        echo "å†…æ ¸æºç ç‰ˆæœ¬ä¿¡æ¯:"
        cd kernel-source
        git log -1 --oneline
        echo "DEFCONFIGæ–‡ä»¶æ£€æŸ¥:"
        ls -la arch/arm64/configs/ | grep k69 || echo "æœªæ‰¾åˆ°k69é…ç½®æ–‡ä»¶"
        [ -f "arch/arm64/configs/$DEFCONFIG" ] && echo "âœ… æ‰¾åˆ°defconfig: $DEFCONFIG" || echo "âŒ defconfigä¸å­˜åœ¨: $DEFCONFIG"

    - name: ä¸‹è½½Android NDK
      run: |
        echo "ä¸‹è½½NDK $NDK_VERSION..."
        wget -q --show-progress https://dl.google.com/android/repository/android-ndk-$NDK_VERSION-linux.zip
        unzip -q android-ndk-$NDK_VERSION-linux.zip
        echo "NDK_PATH=$(pwd)/android-ndk-$NDK_VERSION" >> $GITHUB_ENV
        echo "NDKä¸‹è½½å®Œæˆ"

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡..."
        
        # åŸºç¡€æ¶æ„è®¾ç½®
        echo "ARCH=$ARCH" >> $GITHUB_ENV
        echo "SUBARCH=$ARCH" >> $GITHUB_ENV
        
        # NDKå·¥å…·é“¾è·¯å¾„
        NDK_PREBUILT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64"
        
        # Clangç¼–è¯‘å™¨
        echo "CC=$NDK_PREBUILT/bin/clang" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
        
        # LLVMå·¥å…·é“¾
        echo "LD=$NDK_PREBUILT/bin/ld.lld" >> $GITHUB_ENV
        echo "AR=$NDK_PREBUILT/bin/llvm-ar" >> $GITHUB_ENV
        echo "NM=$NDK_PREBUILT/bin/llvm-nm" >> $GITHUB_ENV
        echo "STRIP=$NDK_PREBUILT/bin/llvm-strip" >> $GITHUB_ENV
        echo "OBJCOPY=$NDK_PREBUILT/bin/llvm-objcopy" >> $GITHUB_ENV
        echo "OBJDUMP=$NDK_PREBUILT/bin/llvm-objdump" >> $GITHUB_ENV
        
        # äº¤å‰ç¼–è¯‘å·¥å…·
        echo "CROSS_COMPILE=$NDK_PREBUILT/bin/aarch64-linux-android-" >> $GITHUB_ENV
        echo "CROSS_COMPILE_ARM32=$NDK_PREBUILT/bin/arm-linux-androideabi-" >> $GITHUB_ENV
        
        # æ„å»ºæ ‡å¿—
        echo "KBUILD_BUILD_USER=github-action" >> $GITHUB_ENV
        echo "KBUILD_BUILD_HOST=github" >> $GITHUB_ENV
        
        echo "ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ"

    - name: æ¸…ç†æ„å»ºç¯å¢ƒ
      if: inputs.clean_build
      run: |
        cd kernel-source
        echo "æ‰§è¡Œå®Œå…¨æ¸…ç†..."
        make clean && make mrproper || echo "æ¸…ç†å®Œæˆæˆ–æ— éœ€æ¸…ç†"
        rm -rf out

    - name: é…ç½®å†…æ ¸
      run: |
        cd kernel-source
        echo "é…ç½®å†…æ ¸ä½¿ç”¨ $DEFCONFIG..."
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p out
        
        # åº”ç”¨defconfig
        set -x
        make O=out ARCH=$ARCH $DEFCONFIG
        
        # éªŒè¯é…ç½®
        if [ -f "out/.config" ]; then
          echo "âœ… å†…æ ¸é…ç½®æˆåŠŸ"
          echo "é…ç½®æ‘˜è¦:"
          grep -E "CONFIG_(LOCALVERSION|VERSION|PATCHLEVEL|COMPILE_BY)=" out/.config || true
        else
          echo "âŒ å†…æ ¸é…ç½®å¤±è´¥"
          exit 1
        fi

    - name: ç¼–è¯‘å†…æ ¸
      timeout-minutes: 60
      run: |
        cd kernel-source
        echo "å¼€å§‹å†…æ ¸ç¼–è¯‘ (ä½¿ç”¨ $COMPILE_JOBS ä¸ªå¹¶è¡Œä»»åŠ¡)..."
        
        # ä½¿ç”¨ccacheå’Œè¯¦ç»†è¾“å‡ºè¿›è¡Œç¼–è¯‘
        time make O=out ARCH=$ARCH -j$COMPILE_JOBS \
          CC="ccache $CC" \
          LD="$LD" \
          AR="$AR" \
          NM="$NM" \
          STRIP="$STRIP" \
          OBJCOPY="$OBJCOPY" \
          OBJDUMP="$OBJDUMP" \
          CLANG_TRIPLE="$CLANG_TRIPLE" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CROSS_COMPILE_ARM32="$CROSS_COMPILE_ARM32" \
          V=1 2>&1 | tee build.log
        
        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥ç»“æœ..."

    - name: éªŒè¯ç¼–è¯‘äº§ç‰©
      run: |
        cd kernel-source
        echo "=== ç¼–è¯‘äº§ç‰©éªŒè¯ ==="
        
        # æ£€æŸ¥æ ¸å¿ƒæ–‡ä»¶
        KERNEL_FILES=(
          "out/arch/arm64/boot/Image.gz"
          "out/arch/arm64/boot/Image"
          "out/arch/arm64/boot/Image.gz-dtb"
          "out/arch/arm64/boot/dtbo.img"
          "out/arch/arm64/boot/dtb.img"
        )
        
        for file in "${KERNEL_FILES[@]}"; do
          if [ -f "$file" ]; then
            size=$(du -h "$file" | cut -f1)
            echo "âœ… $file ($size)"
          else
            echo "âš ï¸  $file (æœªæ‰¾åˆ°)"
          fi
        done
        
        # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
        echo "æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶:"
        find out/arch/arm64/boot/ -type f 2>/dev/null | while read f; do
          echo "   ğŸ“„ $f ($(du -h "$f" | cut -f1))"
        done || echo "æ— è¾“å‡ºæ–‡ä»¶"
        
        # æ£€æŸ¥æ¨¡å—
        MODULE_COUNT=$(find out -name "*.ko" 2>/dev/null | wc -l)
        echo "å†…æ ¸æ¨¡å—æ•°é‡: $MODULE_COUNT"

    - name: æ”¶é›†æ„å»ºä¿¡æ¯
      if: success()
      run: |
        cd kernel-source
        echo "æ”¶é›†æ„å»ºä¿¡æ¯..."
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        {
          echo "MT6768 å†…æ ¸æ„å»ºæŠ¥å‘Š"
          echo "===================="
          echo "æ„å»ºæ—¶é—´: $(date)"
          echo "Gitæäº¤: $(git log -1 --oneline || echo 'æœªçŸ¥')"
          echo "Defconfig: $DEFCONFIG"
          echo "ç¼–è¯‘å™¨: $($CC --version | head -1 || echo 'æœªçŸ¥')"
          echo "æ¶æ„: $ARCH"
          echo "Androidç‰ˆæœ¬: 12"
          echo "å†…æ ¸ç‰ˆæœ¬: 4.19.191"
        } > build-info.txt
        
        cat build-info.txt

    - name: æ‰“åŒ…ç¼–è¯‘äº§ç‰©
      if: success()
      run: |
        cd kernel-source
        echo "æ‰“åŒ…ç¼–è¯‘äº§ç‰©..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p kernel-release
        
        # å¤åˆ¶å†…æ ¸é•œåƒ
        cp out/arch/arm64/boot/Image.gz kernel-release/ 2>/dev/null || true
        cp out/arch/arm64/boot/Image kernel-release/ 2>/dev/null || true
        cp out/arch/arm64/boot/Image.gz-dtb kernel-release/ 2>/dev/null || true
        cp out/arch/arm64/boot/dtbo.img kernel-release/ 2>/dev/null || true
        cp out/arch/arm64/boot/dtb.img kernel-release/ 2>/dev/null || true
        
        # å¤åˆ¶é‡è¦æ¨¡å—
        mkdir -p kernel-release/modules
        find out -name "*.ko" -exec cp {} kernel-release/modules/ \; 2>/dev/null || true
        
        # å¤åˆ¶æ„å»ºæ—¥å¿—å’Œä¿¡æ¯
        cp build.log kernel-release/ 2>/dev/null || true
        cp build-info.txt kernel-release/
        
        # åˆ›å»ºæ‰“åŒ…æ–‡ä»¶
        RELEASE_NAME="kernel-mt6768-$(date +%Y%m%d-%H%M%S)"
        zip -r $RELEASE_NAME.zip kernel-release/
        echo "RELEASE_FILE=$RELEASE_NAME.zip" >> $GITHUB_ENV
        
        echo "æ‰“åŒ…å®Œæˆ: $RELEASE_NAME.zip"

    - name: ä¸Šä¼ å†…æ ¸äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.sha }}
        path: |
          kernel-source/${{ env.RELEASE_FILE }}
          kernel-source/kernel-release/
        retention-days: 30
        if-no-files-found: error

    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.sha }}
        path: |
          kernel-source/build.log
          kernel-source/build-info.txt
        retention-days: 15

    - name: æ„å»ºå®Œæˆé€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ å†…æ ¸ç¼–è¯‘æˆåŠŸ!"
          echo "äº§ç‰©: $RELEASE_FILE"
        else
          echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥!"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯"
        fi