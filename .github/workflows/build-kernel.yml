name: Build MT6768 Kernel

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  NDK_VERSION: 'r23c'
  KERNEL_SOURCE_URL: 'https://github.com/NullableIsBellable/Gale-Kernel-Source.git'
  KERNEL_BRANCH: 'mt6768-4.19'

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Clone kernel source
      run: |
        git clone --depth=1 --branch=$KERNEL_BRANCH $KERNEL_SOURCE_URL kernel-source

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libssl-dev \
          python2 python3 git zip make \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libelf-dev libncurses-dev dwarves \
          ccache

    - name: Setup ccache
      run: |
        ccache -M 25G
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

    - name: Download and setup Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-$NDK_VERSION-linux.zip
        unzip -q android-ndk-$NDK_VERSION-linux.zip
        echo "NDK_PATH=$(pwd)/android-ndk-$NDK_VERSION" >> $GITHUB_ENV

    - name: Setup build environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        
        # 使用NDK中的Clang工具链[citation:9]
        echo "CC=$(pwd)/android-ndk-$NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/clang" >> $GITHUB_ENV
        echo "LD=$(pwd)/android-ndk-$NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld" >> $GITHUB_ENV
        echo "AR=$(pwd)/android-ndk-$NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
        
        # 设置交叉编译工具链[citation:9]
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
        echo "CROSS_COMPILE=$(pwd)/android-ndk-$NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-" >> $GITHUB_ENV
        echo "CROSS_COMPILE_ARM32=$(pwd)/android-ndk-$NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin/arm-linux-androideabi-" >> $GITHUB_ENV

    - name: Configure kernel
      run: |
        cd kernel-source
        # 使用k69v1_64_k419_defconfig[citation:9]
        make O=out ARCH=arm64 k69v1_64_k419_defconfig

    - name: Build kernel
      run: |
        cd kernel-source
        # 启用ccache加速编译[citation:1]
        make O=out ARCH=arm64 -j$(nproc) \
          CC="ccache $CC" \
          LD="$LD" \
          AR="$AR" \
          CLANG_TRIPLE="$CLANG_TRIPLE" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CROSS_COMPILE_ARM32="$CROSS_COMPILE_ARM32"

    - name: Check build artifacts
      run: |
        cd kernel-source
        echo "=== 编译产物检查 ==="
        [ -f "out/arch/arm64/boot/Image.gz" ] && echo "✅ Image.gz 存在" || echo "❌ Image.gz 缺失"
        [ -f "out/arch/arm64/boot/Image.gz-dtb" ] && echo "✅ Image.gz-dtb 存在" || echo "❌ Image.gz-dtb 缺失"
        [ -f "out/arch/arm64/boot/dtbo.img" ] && echo "✅ dtbo.img 存在" || echo "❌ dtbo.img 缺失"
        
        # 列出所有生成的文件
        find out/arch/arm64/boot/ -type f -name "*" 2>/dev/null | while read file; do
          echo "生成: $file ($(du -h "$file" | cut -f1))"
        done || echo "未找到标准输出文件"

    - name: Upload kernel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.sha }}
        path: |
          kernel-source/out/arch/arm64/boot/Image.gz
          kernel-source/out/arch/arm64/boot/Image.gz-dtb
          kernel-source/out/arch/arm64/boot/dtbo.img
          kernel-source/out/arch/arm64/boot/dtb.img
        retention-days: 30

    - name: Upload full build directory
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.sha }}
        path: kernel-source/out/
        retention-days: 7
